# 작업 계획서: 이미지 추출 시 MediaPipe 적용

**작업 일시**: 2026-01-09 13:11  
**작업 목표**: 이미지 추출 시 MediaPipe를 사용하여 더 정확한 얼굴 영역 추출

## 작업 배경
- 현재 `extract_face_region` 함수는 OpenCV Haar Cascade를 사용하여 얼굴을 감지
- Haar Cascade는 정확도가 낮고, 눈 위치를 정확히 찾기 어려움
- MediaPipe는 468개의 랜드마크 포인트를 제공하여 더 정확한 얼굴 감지 가능
- 이미 얼굴 편집/생성 기능에서 MediaPipe를 사용 중이므로, 추출 기능에도 적용하여 일관성 향상

## 작업 범위

### 1. `extract_face_region` 함수 개선
- MediaPipe 옵션 추가
- 랜드마크 기반 얼굴 영역 계산
- 기존 OpenCV 방식과의 호환성 유지

## 작업 순서

### 1단계: `extract_face_region` 함수 수정
- [x] `utils/kaodata_image.py`의 `extract_face_region` 함수 수정
  - [x] `use_mediapipe` 파라미터 추가 (기본값: False, 기존 동작 유지)
  - [x] MediaPipe import 및 사용 가능 여부 확인
  - [x] MediaPipe로 랜드마크 감지 함수 호출
  - [x] 랜드마크 기반으로 얼굴 영역 계산
    - [x] 눈 위치로 얼굴 중심 계산
    - [x] 랜드마크 범위로 얼굴 크기 계산
  - [x] MediaPipe가 없거나 실패하면 기존 OpenCV 방식으로 폴백

### 2단계: 얼굴 영역 계산 로직 구현
- [x] MediaPipe 랜드마크를 기반으로 얼굴 영역 계산
  - [x] 눈 위치 (left_eye, right_eye)로 얼굴 중심 X 계산
  - [x] 눈 Y 좌표로 얼굴 중심 Y 계산
  - [x] 랜드마크 범위로 얼굴 크기 (width, height) 계산
  - [x] 기존 `crop_scale`, `center_offset_x`, `center_offset_y` 파라미터 적용

### 3단계: 호환성 확인
- [x] 기존 호출 코드와의 호환성 확인
  - [x] `gui/_face_extract.py`의 `extract_face` 메서드 확인 (3곳)
  - [x] `gui/_face_import.py`의 호출 확인 (1곳)
  - [x] `utils/kaodata_image.py`의 `save_face_from_png` 함수 확인 (1곳)
  - [x] 기본값이 False이므로 기존 동작 유지 확인

### 5단계: GUI 통합
- [x] `gui/_face_extract.py`에 MediaPipe 옵션 추가
  - [x] `use_mediapipe` 변수 추가 (기본값: False)
  - [x] 얼굴 영역 설정 UI에 MediaPipe 체크박스 추가
  - [x] MediaPipe 사용 가능 여부 확인 및 안내 메시지 표시
  - [x] 모든 `extract_face_region` 호출에 `use_mediapipe` 파라미터 적용

### 4단계: 테스트 및 검증
- [x] 다양한 이미지로 테스트
  - [x] 정면 얼굴 이미지 (7개 이미지 테스트 완료)
  - [x] 다양한 크기의 얼굴 이미지 (96x120 크기 이미지들)
- [x] MediaPipe가 없는 환경에서 폴백 동작 확인 (정상 동작 확인)
- [x] 기존 OpenCV 방식과 결과 비교
  - MediaPipe 방식이 더 정확한 얼굴 영역 추출 (일부 이미지에서 크기 차이 확인)
  - 테스트 결과: `test/extract_face_test_results/` 폴더에 저장됨

## 기술 스택
- Python
- PIL/Pillow (이미지 처리)
- OpenCV (기존 방식, 폴백용)
- MediaPipe (새로운 방식, 선택적)

## 주의사항
- MediaPipe는 선택적 의존성 (없어도 기본 기능 동작)
- Exception 발생 시 pass 금지, 모든 에러는 로그 출력
- 기존 코드와의 호환성 유지 (기본값 False)
- MediaPipe가 없거나 실패하면 자동으로 OpenCV 방식으로 폴백

## 완료 조건
- [x] `extract_face_region` 함수에 MediaPipe 옵션 추가 완료
- [x] 랜드마크 기반 얼굴 영역 계산 동작 확인
- [x] 기존 호출 코드와의 호환성 확인 완료
- [x] 다양한 이미지로 테스트 완료 (7개 이미지 테스트 성공)
- [x] MediaPipe 없을 때 폴백 동작 확인 완료 (정상 동작 확인)
- [x] GUI에 MediaPipe 옵션 통합 완료 (체크박스 추가)

## 구현 세부사항

### MediaPipe를 사용한 얼굴 영역 계산
- `utils/face_landmarks.py`의 `detect_face_landmarks` 함수 활용
- `get_key_landmarks` 함수로 주요 랜드마크 추출
  - left_eye: 왼쪽 눈 중심
  - right_eye: 오른쪽 눈 중심
  - nose: 코 끝
  - mouth: 입 중심
- 눈 위치로 얼굴 중심 계산
- 랜드마크 범위로 얼굴 크기 계산
  - 눈 사이 거리를 기준으로 얼굴 너비 추정
  - 눈에서 입까지 거리를 기준으로 얼굴 높이 추정

### 기존 OpenCV 방식과의 차이
- **OpenCV Haar Cascade**: 얼굴 사각형만 찾음, 눈 위치는 별도 감지 필요
- **MediaPipe**: 468개 랜드마크 포인트로 정확한 얼굴 특징 감지
- **정확도**: MediaPipe가 더 정확한 얼굴 영역 계산 가능

## 참고 사항
- 기존 작업 계획서: `specs/task260108_1121.md` (Phase 5 참고)
- 관련 모듈:
  - `utils/kaodata_image.py`: `extract_face_region` 함수
  - `utils/face_landmarks.py`: MediaPipe 랜드마크 감지
  - `gui/_face_extract.py`: 얼굴 추출 패널
