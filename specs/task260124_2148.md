# 작업 계획서: 눈동자 윤곽과 눈꺼풀 랜드마크 연동 강화 (task260124_2148)

## 1. 작업 목표

눈동자 윤곽이 눈꺼풀 랜드마크를 기준으로 동적으로 재조정되도록 로직을 개선하여, 눈동자의 자연스러운 움직임과 형태 유지 기능을 구현합니다.

### 최종 결과:
* ✅ 눈동자 윤곽 재계산 로직 도입
* ✅ 눈꺼풀 경계 내 눈동자 형태 유지 기능 구현
* ✅ 눈동자 이동 범위 확장 및 자연스러운 움직임 개선
* ✅ 성능 최적화를 위한 캐싱 로직 추가

## 2. 현재 상태 분석

### 2.1 기존 구조
- **눈동자 중심점 드래그**: `gui/face_edit/polygon_drag_handler.py`
- **클램핑 로직**: `utils/face_morphing/polygon_morphing/core.py`의 `clamp_iris_to_eye_region()`
- **렌더링**: `gui/face_edit/polygon_renderer/all_tab_drawer.py`

### 2.2 문제점
1. **눈꺼풀 경계 미고려**: 눈동자 윤곽이 눈꺼풀 실제 경계를 벗어나거나 침범하여 찌그러짐
2. **형태 유지 부족**: 눈동자가 원형/타원형 등 자연스러운 형태를 유지하기 어려움
3. **선형적 이동**: 단순 좌표 이동만으로 부자연스러운 변형 발생
4. **성능 문제**: 실시간 재계산 시 성능 저하 가능성

### 2.3 개선 필요 사항
- 눈동자 중심점 이동 시 눈꺼풀 랜드마크 기반 윤곽 재조정
- 눈꺼풀 경계 내에서의 자연스러운 형태 유지
- 동적 윤곽 계산에 따른 성능 최적화

## 3. 해결 방안 및 상세 계획

### 3.1 눈동자 윤곽 재계산 로직 도입

**파일**: `gui/face_edit/polygon_renderer/all_tab_drawer.py`

**수정 위치**: `_draw_all_tab_polygons` 함수 내 눈동자 그리기 로직

**추가 기능**:
1. **동적 윤곽 계산 함수**
   ```python
   def calculate_iris_contour(self, iris_center, eye_landmarks, original_iris_landmarks):
       """눈동자 중심점과 눈꺼풀 랜드마크를 기반으로 눈동자 윤곽 재계산"""
   ```

2. **형태 유지 로직**
   - 원형/타원형 형태 보장
   - 눈꺼풀 경계에 맞는 크기 조절
   - 비율 유지 기능

3. **캐싱 메커니즘**
   - 계산된 윤곽 캐싱
   - 중복 계산 방지

### 3.2 눈꺼풀 경계 내 형태 유지 강화

**파일**: `utils/face_morphing/polygon_morphing/core.py`

**수정 위치**: `clamp_iris_to_eye_region` 함수 및 `_prepare_iris_centers` 함수

**개선 내용**:
1. **경계 감지 로직 강화**
   - 눈꺼풀 랜드마크 정확히 사용 (`LEFT_EYE`, `RIGHT_EYE`)
   - 더 정밀한 경계 계산

2. **형태 보존 클램핑**
   - 단순 좌표 제한이 아닌 형태 기반 클램핑
   - 크기 조절로 경계 침범 방지

3. **마진 비율 동적 조절**
   - 눈 크기에 따른 적응적 마진
   - 더 넓은 이동 범위 허용

### 3.3 성능 최적화

**최적화 전략**:
1. **계산 결과 캐싱**
   - 눈동자 윤곽 계산 결과 캐싱
   - 중심점 변화가 있을 때만 재계산

2. **근사치 사용**
   - 복잡한 계산 대신 근사치 알고리즘 사용
   - 실시간 성능 확보

3. **비동기 처리**
   - 무거운 계산은 백그라운드에서 처리
   - UI 반응성 유지

## 4. 구현 순서

### 4.1 1단계: 눈동자 윤곽 재계산 로직 구현
- [x] `all_tab_drawer.py`에 `calculate_iris_contour` 함수 추가
- [x] 눈동자 중심점 기반 윤곽 재계산 로직 구현
- [x] 형태 유지 알고리즘 구현 (원형/타원형 보장)

### 4.2 2단계: 클램핑 로직 강화
- [x] `core.py`의 `clamp_iris_to_eye_region` 함수 개선
- [x] 눈꺼풀 랜드마크 정확히 사용하도록 수정
- [x] 형태 보존 클램핑 로직 추가

### 4.3 3단계: 성능 최적화
- [x] 캐싱 메커니즘 구현
- [x] 불필요한 재계산 제거
- [x] 실시간 성능 테스트 및 최적화

### 4.4 4단계: 테스트 및 검증
- [ ] 다양한 눈 크기/모양에서 테스트
- [ ] 경계 상황에서의 동작 확인
- [ ] 성능 벤치마킹

## 5. 예상 효과

### 5.1 움직임 개선
✅ **더 넓은 이동 범위**: 눈꺼풀 경계를 최대한 활용한 자연스러운 움직임
✅ **형태 유지**: 눈동자가 항상 자연스러운 원형/타원형 유지
✅ **부드러운 변형**: 선형 이동이 아닌 유기적인 형태 변화

### 5.2 사용자 경험 향상
✅ **직관적인 조작**: 드래그한 대로 자연스럽게 움직임
✅ **시각적 만족도**: 찌그러짐 없는 깔끔한 눈동자 모양
✅ **안정성**: 다양한 상황에서의 일관된 동작

### 5.3 기술적 개선
✅ **코드 품질**: 더 정교한 알고리즘으로 코드 품질 향상
✅ **성능**: 캐싱으로 실시간 성능 확보
✅ **확장성**: 추후 추가 기능 구현 용이

## 6. 주의사항

### 6.1 랜드마크 데이터 정확성
- `LEFT_EYE`, `RIGHT_EYE` 랜드마크의 정확성 확인
- 잘못된 랜드마크 처리 로직 필요

### 6.2 성능 저하 방지
- 실시간 계산 부하 최소화
- 프레임 드랍 방지를 위한 최적화

### 6.3 호환성 유지
- 기존 클램핑 기능과의 호환성
- 다른 탭/기능과의 충돌 방지

## 7. 테스트 계획

### 7.1 기능 테스트
1. **윤곽 재계산 테스트**
   - 다양한 중심점 위치에서 윤곽 재계산 확인
   - 형태 유지 기능 검증

2. **경계 테스트**
   - 눈꺼풀 경계에서의 동작 확인
   - 극단적인 위치에서의 안정성 검증

3. **성능 테스트**
   - 실시간 드래그 시 성능 측정
   - 캐싱 효과 확인

### 7.2 회귀 테스트
1. **기존 기능 확인**
   - 눈동자 드래그 기능 정상 작동
   - 클램핑 기능 호환성

2. **다른 기능 영향 확인**
   - 다른 랜드마크 조작에 영향 없는지 확인
   - UI 반응성 유지

## 8. 변경된 파일 목록

### 8.1 수정된 파일
1. **gui/face_edit/polygon_renderer/all_tab_drawer.py**
   - `calculate_iris_contour` 함수 추가
   - 눈동자 그리기 로직 수정
   - 캐싱 로직 추가

2. **utils/face_morphing/polygon_morphing/core.py**
   - `clamp_iris_to_eye_region` 함수 개선
   - `_prepare_iris_centers` 함수 수정
   - 형태 보존 클램핑 로직 추가

### 8.2 영향받는 파일
- `gui/face_edit/polygon_drag_handler.py` (드래그 핸들러)
- `gui/face_edit/slider_ui.py` (UI 관련)

## 9. 관련 문서

- **기술 문서**: `docs/iris_eyelid_integration.md` - 눈동자 윤곽과 눈꺼풀 랜드마크 연동 시스템
- **이전 작업**: `specs/task260123_1954.md` - 눈동자 이동 방식 개선
- **완료 작업**: `specs/task260124_2050.md` - 눈동자 탭으로 margin_ratio 슬라이더 이동

## 10. 다음 진행 방식

이 작업 계획서를 검토한 후, 4.1단계부터 순차적으로 진행합니다. 각 단계 완료 시 테스트를 거쳐 다음 단계로 진행합니다.

---

**작성일**: 2026-01-24  
**작성 시간**: 21:48  
**상태**: 대기  
**작성자**: AI Assistant
