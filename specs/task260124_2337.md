# 눈동자-눈꺼풀 상호작용 개선 계획

## 목표
눈동자가 눈꺼풀 경계에 가까워질 때 눈꺼풀을 미세하게 조정하여 더 큰 눈동자 움직임 범위와 현실적인 표현 구현

## 개선 사항

### 1. 눈꺼풀 경계 감지 시스템
- [ ] 눈동자와 눈꺼풀 랜드마크 간 거리 계산
- [ ] 경계 근접 임계값 설정 (예: 5-10픽셀)
- [ ] 눈동자 이동 방향 계산 (상/하/좌/우)

### 2. 눈꺼풀 동적 조정 로직
- [ ] 눈동자가 위쪽으로 이동 시: 상안견(위 눈꺼풀) 미세 상승
- [ ] 눈동자가 아래쪽으로 이동 시: 하안견(아래 눈꺼풀) 미세 하강
- [ ] 눈동자가 좌우로 이동 시: 해당 방향 눈꺼풀 미세 확장
- [ ] 조정 강도 계산 (거리에 비례하여 강도 조절)

### 3. UI 제어 기능 추가
- [ ] 눈동자-눈꺼풀 상호작용 활성화 체크박스
- [ ] 눈꺼풀 조정 강도 슬라이더 (0.0 ~ 1.0)
- [ ] 경계 감지 민감도 슬라이더 (1 ~ 20픽셀)

### 4. 기술 구현 세부사항

#### 4.1 랜드마크 인덱스 정의
- [ ] 왼쪽 눈꺼풀 랜드마크 인덱스 (33, 7, 163, 144, 145, 153, 154, 155, 133, 173, 157, 158, 159, 160, 161, 246)
- [ ] 오른쪽 눈꺼풀 랜드마크 인덱스 (362, 398, 384, 385, 386, 387, 388, 466, 263, 249, 390, 373, 374, 380, 381, 382)
- [ ] 상안견/하안견 분리 로직

#### 4.2 거리 계산 알고리즘
- [ ] 유클리드 거리 계산 함수
- [ ] 눈동자 중심점에서 눈꺼풀 각 포인트까지의 최소 거리
- [ ] 방향 벡터 계산 (눈동자 중심 → 눈꺼풀 포인트)

#### 4.3 조정량 계산
- [ ] 기본 조정량: `adjustment = max_distance - current_distance`
- [ ] 강도 계수 적용: `final_adjustment = adjustment * intensity * 0.1`
- [ ] 부드러운 보간: `lerp(original_pos, adjusted_pos, 0.3)`

### 5. 파일 수정 계획

#### 5.1 `all_tab_drawer.py`
- [ ] `calculate_iris_contour` 메서드 확장
- [ ] 눈꺼풀 조정 로직 추가
- [ ] 캐시 키에 눈꺼풀 상호작용 파라미터 포함

#### 5.2 `__init__.py`
- [ ] UI 변수 추가:
  ```python
  self.iris_eyelid_interaction = tk.BooleanVar(value=True)
  self.eyelid_adjustment_intensity = tk.DoubleVar(value=0.5)
  self.eyelid_detection_sensitivity = tk.DoubleVar(value=8.0)
  ```

#### 5.3 `slider_ui.py`
- [ ] 눈동자 탭에 새 프레임 추가
- [ ] 체크박스와 슬라이더 UI 구현

#### 5.4 `polygon_drag_handler.py`
- [ ] `apply_polygon_drag_final`에 눈꺼풀 조정 파라미터 전달
- [ ] `morph_face_by_polygons` 호출 시 새 파라미터 추가

### 6. 테스트 및 검증
- [ ] 눈동자를 극단적으로 위로 이동 시 상안견이 자연스럽게 상승하는지 확인
- [ ] 눈동자를 극단적으로 아래로 이동 시 하안견이 자연스럽게 하강하는지 확인
- [ ] 좌우 이동 시 눈꺼풀이 자연스럽게 확장되는지 확인
- [ ] UI 설정 변경 시 즉시 반영되는지 확인
- [ ] 기존 기능과의 호환성 확인

### 7. 성능 최적화
- [ ] 눈꺼풀 조정 계산을 캐싱하여 반복 계산 방지
- [ ] 불필요한 계산은 건너뛰는 조건문 추가
- [ ] 실시간 계산 시 부하 최소화

## 예상 효과
1. **더 큰 움직임 범위**: 눈동자가 눈꺼풀 경계를 넘어서는 것처럼 보이는 효과
2. **현실적인 표현**: 실제 사람의 눈 움직임과 유사한 자연스러움
3. **사용자 제어**: UI를 통해 상호작용 강도 조절 가능
4. **성능 유지**: 최적화된 알고리즘으로 기존 성능 저하 없음

## 구현 우선순위
1. 기본 거리 계산 및 경계 감지 (높음)
2. 눈꺼풀 조정 로직 구현 (높음)
3. UI 제어 기능 추가 (중간)
4. 성능 최적화 (중간)
5. 고급 보간 및 부드러운 움직임 (낮음)
