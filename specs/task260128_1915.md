# Task 260128_1915 — `apply_editing` 단계적 분해 계획

## 1. 배경
- `FaceEditPanel.apply_editing`은 @gui/face_edit/__init__.py#841-1304 범위, 약 460라인 규모의 메서드.
- 현재 하나의 함수가 **랜드마크 준비 → 이미지 변환 → 스타일 전송 → 나이 변환 → UI 갱신**을 모두 담당하여 중복 호출을 막기 어려움.
- 슬라이더/탭 변경 시 전체 파이프라인이 무조건 실행되면서 UI 프리즈와 로그 폭증 발생.

## 2. 목표
1. `apply_editing`을 단계별 헬퍼로 분리해 책임을 명확히 한다.
2. 상태 시그니처/캐시를 도입하여 **변경이 없을 때는 편집·렌더링을 건너뛰게** 한다.
3. 각 단계별로 재사용 가능한 로그/진단 훅을 추가해 문제 조사 시간을 단축한다.
4. 리팩터 과정에서 기존 기능(고급 모드, 폴리곤 표시, 스타일 전송 등)을 유지하고 회귀를 방지한다.
5. `gui/face_edit/__init__.py`에는 초기화/위젯 wiring만 남기고, 편집 로직은 전용 믹스인/모듈로 이동한다.

## 3. 아키텍처 초안
```
apply_editing
├─ _prepare_editing_context
├─ _ensure_landmark_sources
├─ _compute_transformed_landmarks (warp / non-warp)
├─ _apply_face_adjustments (wrapping face_morphing.apply_all_adjustments)
├─ _apply_style_transfer_if_requested
├─ _apply_age_transform_if_requested
├─ _update_previews_and_labels
└─ _refresh_overlays_and_polygons
```
- 최상위 메서드는 try/except + 상태 서명 관리만 담당.
- 각 헬퍼는 반환값/부수효과를 명시하고 독립 테스트 가능하도록 최소 책임만 가진다.

## 4. 작업 순서 & 체크리스트
1. **모듈 분리 선행**
   - [x] `EditingPipelineMixin` 파일 생성 및 import 정리
   - [x] `apply_editing`/연관 로직을 믹스인으로 이동, FaceEditPanel에는 호출만 남김
   - [x] Popup/Window 로직을 `PopupManagerMixin`으로 이동
   - [x] 지시선 스케일링 로직을 `GuideLineScalingMixin`으로 이동
   - [x] 탭 생성기(`_create_eye_tab`, `_create_mouth_tab`) 잔여 코드 제거 → `SliderUIMixin`/`WidgetCreatorMixin`에 위임 확인 *(슬라이더 헬퍼 공용 메서드화 완료)*
   - [x] 런처/기타 잔여 메서드(`show_face_edit_panel(self)` 등) 정리 및 필요 시 별도 모듈로 이동
   - [x] 구조 변경 후 기본 스모크 테스트 *(main.py 실행 + 슬라이더/탭/팝업 조작 확인)*
2. **상태 분석 및 설계**
   - [x] `apply_editing` 입력/출력/부수효과 목록화
   - [x] 상태 시그니처 정의 및 의존 관계 다이어그램 작성

   - 2.1 `apply_editing` I/O 및 부수효과 요약
      | 구분 | 항목 | 설명 |
      |------|------|------|
      | 입력 | `self.current_image`, `self.aligned_image` | 편집 기준 이미지. `aligned_image`가 있으면 우선 사용 |
      | 입력 | 슬라이더 값 (`DoubleVar`/`BooleanVar`) | 눈·코·입·윤곽 관련 조정 값, 개별 눈 영역 여부, 랜드마크 왜곡 모드 등 |
      | 입력 | 외부 모듈 | `utils.face_morphing`, `utils.style_transfer`, `utils.face_transform`, `PIL.Image`, `os` |
      | 출력 | `self.edited_image` | 변환이 완료된 최종 이미지를 저장 |
      | 출력 | `LandmarkManager` 상태 | `set_transformed_landmarks`, `set_custom_landmarks`, `set_original_landmarks` 호출을 통해 캐시 업데이트 |
      | 부수효과 | 프리뷰/오버레이 | `show_*_preview`, `update_eye_region_display`, `update_face_features_display`, `guide_lines_manager` 호출 등으로 UI 갱신 |
      | 부수효과 | 시그니처 캐시 | `_last_apply_editing_signature`를 갱신해 중복 실행을 건너뜀 |
      | 부수효과 | 고급 모드 폴리곤 | `apply_polygon_drag_final`, `update_polygons_only` 재호출로 커스텀 랜드마크 반영 |

   - 2.2 상태 시그니처 구성 요소
      현재 `_build_apply_editing_signature`가 수집하는 값과 의존 관계는 다음과 같다.

      ```
      base_image_id (aligned → current)
      ├─ slider_fields (23개 DoubleVar)
      ├─ bool_flags (eye_spacing / use_individual_eye_region / use_landmark_warping)
      ├─ style_path (스타일 이미지 경로)
      ├─ age_value (나이 조정치)
      ├─ color_strength / texture_strength (스타일 파라미터)
      └─ custom_signature (LandmarkManager에서 제공)
      ```

   - **변경 감지 흐름**: 입력 변수가 하나라도 변하면 새로운 튜플을 생성해 `_last_apply_editing_signature`와 비교한다. 동일 시 바로 반환, 다르면 파이프라인 수행 후 `_cache_apply_editing_signature()`를 호출한다.
   - **추가 가드 계획**: `apply_polygon_drag_final`에서도 동일한 시그니처를 공유해 드래그→편집 루프를 제거하고, `after_idle` 큐에 apply를 스케줄링해 UI 블로킹을 줄인다.
   - **시각 다이어그램**: 슬라이더/토글/외부 파일 → 시그니처 → 편집 파이프라인 → 랜드마크/미리보기 → 다시 시그니처 캐시 순환 구조로 생각하면 된다.
3. **컨텍스트/랜드마크 단계 추출**
   - [x] `_prepare_editing_context`, `_ensure_landmark_sources` 구현
   - [x] `_compute_transformed_landmarks`와 iris/랜드마크 헬퍼 추출 *( `_update_landmarks_for_editing`, `_ensure_iris_centers_from_original` )*
4. **이미지 변환 단계 추출**
   - [x] `_apply_face_adjustments` 래퍼 작성(예외/로그 관리)
   - [x] `_apply_style_transfer_if_requested`, `_apply_age_transform_if_requested` 분리
5. **UI 갱신 단계 추출**
   - [x] `_update_previews_and_labels` 구현
   - [x] `_refresh_region_overlays`, `_redraw_landmark_polygons_if_needed` 구현 *( `_refresh_overlays_and_polygons`, `_update_slider_labels` )*
6. **가드 및 스케줄링**
   - [ ] `_build_editing_state_signature` / `_cache_editing_state_signature` 작성
   - [ ] `apply_polygon_drag_final`과 시그니처 공유, 재귀 제거
   - [ ] 필요 시 `after_idle` 스케줄러 도입
7. **문서화 및 정비**
   - [ ] 새 믹스인/모듈에 docstring·로그 정책 정비
   - [ ] __init__.py가 초기화/바인딩 전용인지 재검증
8. **검증 및 회귀 테스트**
   - [ ] 슬라이더·고급 모드·스타일/나이 옵션별 동작 확인
   - [ ] 로그 감소·응답성 확인, 스모크 테스트 기록 (눈/코/입 각 2건 총 6건)

## 5. 리스크 및 완화
| 리스크 | 영향 | 완화 전략 |
|--------|-------|-----------|
| 단계 분리 중 상태 누락 | 편집 결과 오동작 | 컨텍스트 dict로 전달 값 명시, mypy/타입힌트 추가 |
| 성능 저하 | 헬퍼 호출 오버헤드 | 시그니처 가드로 불필요 호출 감소, 프로파일링 로그 |
| 기존 디버그 로그 손실 | 추적 어려움 | 공통 로그 헬퍼 도입, DEBUG 플래그 유지 |
| 테스트 누락 | 회귀 위험 | 체크리스트 기반 시나리오 완료 후 결과 기록 |

## 6. 산출물
- `gui/face_edit/__init__.py` 내 `apply_editing` 리팩터링 PR
- 신규 헬퍼 메서드 문서화 (docstring + 주석)
- `specs/task260128_1915.md` 업데이트 내역 + 테스트 로그 첨부

## 7. 진행 현황 (2026-01-29)
- 믹스인 구조 정리는 `EditingPipelineMixin`, `PopupManagerMixin`, `GuideLineScalingMixin` 생성까지 완료했으며 `FaceEditPanel`에서는 초기화 및 위젯 바인딩만 유지하는 방향으로 이동 중이다.
- 실행 중 발견된 회귀는 즉시 패치했다: `adjust_region_size_with_axis` 미수출로 인한 ImportError와 `_update_landmarks_after_editing`의 `base_image` 참조 오류를 각각 `utils.face_morphing.adjustments.__init__` 및 `editing_steps.py`에서 수정했다.
- 확대/축소 시 발생하던 `zoom_scale_edited` 속성 에러 및 편집 캔버스 휠 축소 미반영 문제를 해결하고, 원본/편집 미리보기의 배율·위치 동기화를 정비했다. 또한 지시선 토글/확대 시 표시가 사라지던 현상을 `update_guide_lines()`의 스케일 계산을 수정해 해결했다.
- 현재 `apply_editing`은 리팩터링된 헬퍼 세트를 사용하고 있으나, 체크리스트 2단계(상태 분석/시그니처 설계)와 6단계(가드 및 스케줄링), 7~8단계(문서화·회귀 테스트)는 아직 착수 전이다. 다음 작업은 상태 시그니처 정의와 `apply_polygon_drag_final` 연동, 그리고 테스트 로그 작성을 포함한다.
