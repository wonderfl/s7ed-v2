# Task 260128_1915 — `apply_editing` 단계적 분해 계획

## 1. 배경
- `FaceEditPanel.apply_editing`은 @gui/face_edit/__init__.py#841-1304 범위, 약 460라인 규모의 메서드.
- 현재 하나의 함수가 **랜드마크 준비 → 이미지 변환 → 스타일 전송 → 나이 변환 → UI 갱신**을 모두 담당하여 중복 호출을 막기 어려움.
- 슬라이더/탭 변경 시 전체 파이프라인이 무조건 실행되면서 UI 프리즈와 로그 폭증 발생.

## 2. 목표
1. `apply_editing`을 단계별 헬퍼로 분리해 책임을 명확히 한다.
2. 상태 시그니처/캐시를 도입하여 **변경이 없을 때는 편집·렌더링을 건너뛰게** 한다.
3. 각 단계별로 재사용 가능한 로그/진단 훅을 추가해 문제 조사 시간을 단축한다.
4. 리팩터 과정에서 기존 기능(고급 모드, 폴리곤 표시, 스타일 전송 등)을 유지하고 회귀를 방지한다.
5. `gui/face_edit/__init__.py`에는 초기화/위젯 wiring만 남기고, 편집 로직은 전용 믹스인/모듈로 이동한다.

## 3. 아키텍처 초안
```
apply_editing
├─ _prepare_editing_context
├─ _ensure_landmark_sources
├─ _compute_transformed_landmarks (warp / non-warp)
├─ _apply_face_adjustments (wrapping face_morphing.apply_all_adjustments)
├─ _apply_style_transfer_if_requested
├─ _apply_age_transform_if_requested
├─ _update_previews_and_labels
└─ _refresh_overlays_and_polygons
```
- 최상위 메서드는 try/except + 상태 서명 관리만 담당.
- 각 헬퍼는 반환값/부수효과를 명시하고 독립 테스트 가능하도록 최소 책임만 가진다.

## 4. 작업 순서 & 체크리스트
1. **모듈 분리 선행**
   - [x] `EditingPipelineMixin` 파일 생성 및 import 정리
   - [x] `apply_editing`/연관 로직을 믹스인으로 이동, FaceEditPanel에는 호출만 남김
   - [x] Popup/Window 로직을 `PopupManagerMixin`으로 이동
   - [x] 지시선 스케일링 로직을 `GuideLineScalingMixin`으로 이동
   - [ ] 탭 생성기(`_create_eye_tab`, `_create_mouth_tab`) 잔여 코드 제거 → `SliderUIMixin`/`WidgetCreatorMixin`에 위임 확인
   - [ ] 런처/기타 잔여 메서드(`show_face_edit_panel(self)` 등) 정리 및 필요 시 별도 모듈로 이동
   - [ ] 구조 변경 후 기본 스모크 테스트
2. **상태 분석 및 설계**
   - [ ] `apply_editing` 입력/출력/부수효과 목록화
   - [ ] 상태 시그니처 정의 및 의존 관계 다이어그램 작성
3. **컨텍스트/랜드마크 단계 추출**
   - [ ] `_prepare_editing_context`, `_ensure_landmark_sources` 구현
   - [ ] `_compute_transformed_landmarks`와 iris/랜드마크 헬퍼 추출
4. **이미지 변환 단계 추출**
   - [ ] `_apply_face_adjustments` 래퍼 작성(예외/로그 관리)
   - [ ] `_apply_style_transfer_if_requested`, `_apply_age_transform_if_requested` 분리
5. **UI 갱신 단계 추출**
   - [ ] `_update_previews_and_labels` 구현
   - [ ] `_refresh_region_overlays`, `_redraw_landmark_polygons_if_needed` 구현
6. **가드 및 스케줄링**
   - [ ] `_build_editing_state_signature` / `_cache_editing_state_signature` 작성
   - [ ] `apply_polygon_drag_final`과 시그니처 공유, 재귀 제거
   - [ ] 필요 시 `after_idle` 스케줄러 도입
7. **문서화 및 정비**
   - [ ] 새 믹스인/모듈에 docstring·로그 정책 정비
   - [ ] __init__.py가 초기화/바인딩 전용인지 재검증
8. **검증 및 회귀 테스트**
   - [ ] 슬라이더·고급 모드·스타일/나이 옵션별 동작 확인
   - [ ] 로그 감소·응답성 확인, 스모크 테스트 기록 (눈/코/입 각 2건 총 6건)

## 5. 리스크 및 완화
| 리스크 | 영향 | 완화 전략 |
|--------|-------|-----------|
| 단계 분리 중 상태 누락 | 편집 결과 오동작 | 컨텍스트 dict로 전달 값 명시, mypy/타입힌트 추가 |
| 성능 저하 | 헬퍼 호출 오버헤드 | 시그니처 가드로 불필요 호출 감소, 프로파일링 로그 |
| 기존 디버그 로그 손실 | 추적 어려움 | 공통 로그 헬퍼 도입, DEBUG 플래그 유지 |
| 테스트 누락 | 회귀 위험 | 체크리스트 기반 시나리오 완료 후 결과 기록 |

## 6. 산출물
- `gui/face_edit/__init__.py` 내 `apply_editing` 리팩터링 PR
- 신규 헬퍼 메서드 문서화 (docstring + 주석)
- `specs/task260128_1915.md` 업데이트 내역 + 테스트 로그 첨부
