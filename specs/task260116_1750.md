# 작업계획서: 슬라이더 폴리곤 실시간 업데이트 및 눈 변형 개선

## 작업 목표
슬라이더 조정 시 폴리곤이 실시간으로 업데이트되도록 하고, 눈 크기 변형 시 모든 눈 인덱스와 눈동자가 정확히 변형되도록 개선합니다.

## 문제 분석
1. **슬라이더 드래그 중 폴리곤 미업데이트**: 슬라이더를 드래그할 때 폴리곤이 업데이트되지 않아 사용자가 변경사항을 확인하기 어려움
2. **눈 인덱스 누락**: 일부 눈 인덱스(예: 7번)가 변형되지 않는 문제
3. **눈동자 미변형**: 눈 크기를 키워도 눈동자가 함께 변형되지 않음
4. **이전 포인트 잔존**: 슬라이더 조정 시 이전 크기의 포인트가 남아있어 중복 표시됨
5. **디버깅 어려움**: 어떤 포인트가 변형되지 않는지 확인하기 어려움

## 작업 계획

### 1. 슬라이더 드래그 중 폴리곤 실시간 업데이트
- **위치**: `gui/face_edit/morphing.py` `update_labels_only()`, `update_polygons_only()`
- **기능**:
  - 슬라이더 드래그 중 `update_labels_only()` 호출 시 폴리곤도 함께 업데이트
  - `update_polygons_only()` 함수 추가: 이미지 편집 없이 랜드마크만 계산하여 폴리곤 업데이트
  - `custom_landmarks`를 항상 원본 랜드마크 기준으로 계산하여 누적 변형 방지
- **예상 효과**: 슬라이더 조정 시 즉각적인 시각적 피드백 제공

### 2. 눈 인덱스 변형 보장
- **위치**: `utils/face_morphing.py` `transform_landmarks_for_eye_size()`
- **기능**:
  - 눈 인덱스(`LEFT_EYE_INDICES`, `RIGHT_EYE_INDICES`)를 다른 조건 무시하고 무조건 먼저 변형
  - MediaPipe 연결 정보를 사용하여 눈과 연결된 모든 포인트 찾기
  - 거리 기반 확인 범위 확대 (경계보다 1.5배 넓게)
- **예상 효과**: 모든 눈 인덱스가 정확히 변형됨

### 3. 눈동자 변형 추가
- **위치**: `utils/face_morphing.py` `transform_landmarks_for_eye_size()`
- **기능**:
  - 왼쪽 눈동자 인덱스 (468-472)를 왼쪽 눈 크기 변형에 포함
  - 오른쪽 눈동자 인덱스 (473-477)를 오른쪽 눈 크기 변형에 포함
  - 눈 인덱스와 동일하게 무조건 변형되도록 처리
- **예상 효과**: 눈 크기 조정 시 눈동자도 함께 변형됨

### 4. 이전 포인트 제거
- **위치**: `gui/face_edit/morphing.py` `update_polygons_only()`
- **기능**:
  - 폴리곤 업데이트 시 기존 랜드마크 포인트(`landmarks_items_original`)도 함께 제거
  - 태그(`"landmarks"`)로도 제거 시도하여 누락 방지
- **예상 효과**: 이전 크기의 포인트가 남지 않음

### 5. 인덱스 번호 표시 기능
- **위치**: `gui/face_edit/landmark_display.py`, `gui/face_edit/morphing.py`
- **기능**:
  - `_draw_landmarks_on_canvas()`에 `show_indices` 파라미터 추가
  - 랜드마크 포인트 옆에 인덱스 번호 텍스트 표시
  - UI에 "인덱스 표시" 체크박스 추가
  - `show_landmark_indices` 변수 추가
- **예상 효과**: 디버깅 시 어떤 포인트가 변형되지 않는지 쉽게 확인 가능

### 6. 디버깅 로그 추가
- **위치**: `utils/face_morphing.py` `transform_landmarks_for_eye_size()`
- **기능**:
  - MediaPipe 연결 포인트 목록 출력
  - 변형되지 않은 포인트 목록과 이유 출력 (인덱스, 좌표, 거리, 이유)
- **예상 효과**: 변형되지 않는 포인트의 원인 파악 용이

## 작업 단계
- [x] 1. 슬라이더 드래그 중 폴리곤 실시간 업데이트
  - [x] 1-1. `update_polygons_only()` 함수 추가
  - [x] 1-2. `update_labels_only()`에서 폴리곤 업데이트 호출
  - [x] 1-3. `custom_landmarks`를 항상 원본 기준으로 계산
- [x] 2. 눈 인덱스 변형 보장
  - [x] 2-1. 눈 인덱스를 무조건 먼저 변형하도록 수정
  - [x] 2-2. MediaPipe 연결 정보 활용
  - [x] 2-3. 거리 기반 확인 범위 확대
- [x] 3. 눈동자 변형 추가
  - [x] 3-1. 눈동자 인덱스 정의 (468-477)
  - [x] 3-2. 왼쪽/오른쪽 눈동자 인덱스를 각각 눈 크기 변형에 포함
- [x] 4. 이전 포인트 제거
  - [x] 4-1. `update_polygons_only()`에서 기존 랜드마크 포인트 제거
  - [x] 4-2. 태그로도 제거 시도
- [x] 5. 인덱스 번호 표시 기능
  - [x] 5-1. `_draw_landmarks_on_canvas()`에 `show_indices` 파라미터 추가
  - [x] 5-2. 인덱스 번호 텍스트 표시 로직 구현
  - [x] 5-3. UI에 체크박스 추가
- [x] 6. 디버깅 로그 추가
  - [x] 6-1. MediaPipe 연결 포인트 목록 출력
  - [x] 6-2. 변형되지 않은 포인트 목록 출력

## 작업 완료 내역
- 2026-01-16 17:50: `update_polygons_only()` 함수 추가 (이미지 편집 없이 랜드마크만 계산)
- 2026-01-16 17:50: `update_labels_only()`에서 폴리곤 업데이트 호출 추가
- 2026-01-16 17:50: 눈 인덱스를 무조건 먼저 변형하도록 수정 (다른 조건 무시)
- 2026-01-16 17:50: MediaPipe 연결 정보를 사용하여 눈과 연결된 모든 포인트 찾기
- 2026-01-16 17:50: 거리 기반 확인 범위 확대 (경계보다 1.5배 넓게)
- 2026-01-16 17:50: 눈동자 인덱스 (468-477)를 눈 크기 변형에 포함
- 2026-01-16 17:50: `update_polygons_only()`에서 기존 랜드마크 포인트 제거 추가
- 2026-01-16 17:50: 인덱스 번호 표시 기능 추가 (`show_indices` 파라미터, 체크박스)
- 2026-01-16 17:50: 디버깅 로그 추가 (MediaPipe 연결 포인트, 변형되지 않은 포인트 목록)

## 예상 효과
- **사용자 경험**: 슬라이더 조정 시 즉각적인 시각적 피드백 제공
- **정확성**: 모든 눈 인덱스와 눈동자가 정확히 변형됨
- **디버깅**: 변형되지 않는 포인트를 쉽게 확인 가능
- **품질**: 이전 포인트가 남지 않아 깔끔한 표시

## 주의사항
- `custom_landmarks`는 항상 `original_landmarks`를 기준으로 계산하여 누적 변형 방지
- 눈 인덱스는 다른 조건(경계, 거리, 제외 인덱스 등)을 무시하고 무조건 변형
- 눈동자 인덱스는 `refine_landmarks=True`일 때만 사용 가능 (468개 이상의 랜드마크 필요)
- 인덱스 번호 표시는 성능에 약간의 영향이 있을 수 있음 (선택적 사용)

## 구현 세부사항

### 1. update_polygons_only() 함수
```python
def update_polygons_only(self):
    """폴리곤만 업데이트 (슬라이더 드래그 중 호출, 이미지 편집 없이 랜드마크만 계산)"""
    # 원본 랜드마크를 기준으로 변형된 랜드마크 계산
    base_landmarks = self.original_landmarks or self.face_landmarks
    transformed = face_morphing.transform_landmarks_for_eye_size(...)
    self.custom_landmarks = transformed
    
    # 기존 폴리곤 및 포인트 제거
    # 새 폴리곤 그리기
```

### 2. 눈 인덱스 무조건 변형
```python
# 1단계: 왼쪽 눈 인덱스와 왼쪽 눈동자 인덱스는 무조건 먼저 변형
for idx in LEFT_EYE_INDICES + LEFT_IRIS_INDICES:
    if idx < len(landmarks) and idx not in transformed_indices:
        # 다른 조건 무시하고 무조건 변형
        transformed_landmarks[idx] = (...)
        transformed_indices.add(idx)
```

### 3. 눈동자 인덱스 정의
```python
# 왼쪽 눈동자: 468 (중심), 469, 470, 471, 472
# 오른쪽 눈동자: 473 (중심), 474, 475, 476, 477
LEFT_IRIS_INDICES = [468, 469, 470, 471, 472]
RIGHT_IRIS_INDICES = [473, 474, 475, 476, 477]
```
