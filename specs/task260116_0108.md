# 폴리곤 그리기 기능 개선 계획서

**작업 일시**: 2026-01-16 01:08  
**작업 목표**: 각 부위(눈, 눈썹, 코, 입)의 모든 랜드마크 포인트를 포함하는 완전한 폴리곤 그리기

## 문제 상황

### 현재 문제점
- 경로 찾기 실패 시 각도 순 정렬로 폴백하는데, 외곽선만 그려져서 내부 포인트가 누락됨
- 예: 눈썹 폴리곤이 5개 포인트만 표시 (실제로는 더 많은 포인트가 있어야 함)

### 원인 분석
- `_build_polygon_path_from_connections()` 함수에서 **불필요한 DFS 경로 찾기** 시도
- MediaPipe의 `FACEMESH_*` 연결 정보는 이미 메쉬 인덱스가 있는데, 굳이 경로를 찾으려고 함
- 각도 순 정렬이 외곽 포인트만 포함하여 내부 포인트가 빠짐

## 해결 방안

### 핵심 문제
- MediaPipe 연결 정보(`FACEMESH_*`)에 이미 메쉬 인덱스가 있는데, DFS로 경로를 찾으려는 것이 불필요함
- 먼저 **데이터가 제대로 있는지 확인** 필요

### 나중에 추가할 기능 (지금은 제외)
- Convex Hull 사용: 모든 포인트를 포함하는 폴리곤 그리기 (기능 추가 시 고려)

## 구현 단계

### 1단계: MediaPipe 연결 정보 데이터 확인
- [x] 각 `FACEMESH_*` 상수의 연결 정보 구조 확인
  - `FACEMESH_LEFT_EYE`: 16개 포인트 (인덱스: 249~466)
  - `FACEMESH_LEFT_EYEBROW`: 10개 포인트 (인덱스: 276~336)
  - `FACEMESH_RIGHT_EYE`: 16개 포인트 (인덱스: 7~246)
  - `FACEMESH_RIGHT_EYEBROW`: 10개 포인트 (인덱스: 46~107)
  - `FACEMESH_NOSE`: 24개 포인트 (인덱스: 1~440)
  - `FACEMESH_LIPS`: 40개 포인트 (인덱스: 0~415)
- [x] 연결 정보에서 모든 포인트 인덱스 수집 확인 (전체 116개 고유 포인트)
- [x] 실제 랜드마크 데이터와 매칭되는지 확인 (모든 인덱스 유효)
- [x] 테스트 코드 작성: `test/test_face_mesh_connections.py`

### 2단계: 데이터 확인 결과에 따른 다음 단계 결정
- [x] 데이터 확인 결과 검토
  - **결과**: 모든 부위의 연결 정보가 정상이며, 실제 랜드마크 데이터와 완벽하게 매칭됨
  - **결론**: MediaPipe 연결 정보(`FACEMESH_*`)는 이미 올바른 메쉬 인덱스를 포함하고 있음
- [x] FACEMESH_TESSELATION 확인
  - **결과**: TESSELATION은 468개 포인트를 모두 포함 (0~467)
  - **결과**: 각 부위의 모든 포인트가 TESSELATION에 포함됨 (100%)
- [x] 해결 방안 결정
  - **방법**: FACEMESH_TESSELATION에서 각 부위의 포인트만 필터링하여 폴리곤 경로 구성
  - 각 부위의 포인트 인덱스 리스트 사용
  - TESSELATION 연결 정보에서 해당 포인트들만 포함하는 연결 필터링
  - 필터링된 연결들을 사용해서 폴리곤 경로 구성

## 데이터 확인 결과

### 확인 완료 사항
1. ✅ 각 부위의 MediaPipe 연결 정보가 제대로 있음
2. ✅ 모든 랜드마크 포인트가 연결 정보에 포함됨 (116개 고유 포인트)
3. ✅ 실제 랜드마크 데이터(478개)와 모든 인덱스가 유효함

### 3단계: FACEMESH_TESSELATION 기반 폴리곤 생성 구현
- [x] `_build_polygon_path_from_connections()` 함수 개선
  - FACEMESH_TESSELATION에서 각 부위의 포인트만 필터링
  - 눈, 코, 입, 얼굴 외곽선의 경우 주변 한 줄 더 포함 (이웃 포인트 추가)
  - 필터링된 연결 정보를 그래프로 구성하여 삼각형 메쉬 찾기
  - 삼각형 메쉬를 개별 폴리곤으로 그려서 모든 포인트 포함 확인 가능
  - 불필요한 DFS 경로 찾기 제거
  - 삼각형을 찾지 못하면 각도 순 정렬로 폴백
- [x] `_draw_landmark_polygons()` 함수 개선
  - 눈, 눈썹, 코, 입, 얼굴 외곽선 각 부위별 폴리곤 그리기
  - 삼각형 메쉬를 개별 폴리곤으로 그리기 (4개씩 나눠서 처리)
  - 폴백 케이스 처리 (단일 폴리곤)
- [x] 테스트 및 검증
  - 각 부위별 폴리곤이 모든 포인트를 포함하는지 확인 ✅
  - 삼각형 메쉬로 그려져서 어떤 포인트가 빠졌는지 확인 가능 ✅
  - 눈, 코, 입, 얼굴 외곽선 주변 한 줄 더 포함되어 그려짐 ✅

## 최종 구현 결과

### 구현된 기능
1. ✅ FACEMESH_TESSELATION 기반 삼각형 메쉬 그리기
   - 각 부위(눈, 눈썹, 코, 입, 얼굴 외곽선)의 모든 포인트를 포함하는 삼각형 메쉬 구성
   - 삼각형들을 개별 폴리곤으로 그려서 누락 포인트 확인 가능
2. ✅ 주변 확장 기능
   - 눈, 코, 입, 얼굴 외곽선의 이웃 포인트를 자동으로 포함하여 주변 한 줄 더 그리기
   - TESSELATION 그래프를 사용하여 정확한 이웃 포인트 찾기
3. ✅ 폴백 처리
   - 삼각형을 찾지 못하면 각도 순 정렬로 단일 폴리곤 그리기
4. ✅ 얼굴 외곽선 추가
   - "윤곽" 탭에서 FACEMESH_FACE_OVAL을 사용하여 얼굴 외곽선 폴리곤 그리기

### 개선 사항
- 외곽선만 그려지는 문제 해결: 삼각형 메쉬로 모든 포인트 포함
- 포인트 누락 확인 가능: 삼각형 단위로 그려져서 빠진 포인트 확인 용이
- 모든 부위 주변 영역 확장: 눈, 코, 입, 얼굴 외곽선 모두 자동으로 주변 한 줄 더 포함
- 얼굴 외곽선 지원: 연결 정보를 사용하여 정확한 얼굴 외곽선 폴리곤 그리기

## 개선 방안

### 핵심 개선 사항
1. **FACEMESH_TESSELATION 활용**
   - MediaPipe의 전체 얼굴 메쉬 정보를 활용하여 정확한 삼각형 메쉬 구성
   - 각 부위의 연결 정보(`FACEMESH_*`)를 기반으로 TESSELATION에서 해당 영역만 필터링
   - 삼각형 메쉬를 개별 폴리곤으로 그려서 모든 포인트 포함 보장

2. **주변 영역 자동 확장**
   - 눈, 코, 입, 얼굴 외곽선의 경우 TESSELATION 그래프를 사용하여 이웃 포인트 자동 포함
   - 각 부위의 인덱스를 확인하여 해당 부위인 경우 주변 한 줄 더 포함
   - 사용자가 수동으로 포인트를 추가할 필요 없이 자동으로 확장

3. **삼각형 메쉬 기반 그리기**
   - 단일 폴리곤 경로 대신 삼각형 메쉬를 개별 폴리곤으로 그리기
   - 각 삼각형이 4개 점(3개 점 + 첫 번째 점 반복)으로 구성되어 순환 경로 보장
   - 삼각형 단위로 그려져서 어떤 포인트가 빠졌는지 시각적으로 확인 가능

4. **폴백 메커니즘**
   - 삼각형을 찾지 못하는 경우 각도 순 정렬로 단일 폴리곤 그리기
   - 모든 포인트를 포함하는 폴리곤을 보장하여 빈 화면 방지

### 기술적 개선
- **불필요한 DFS 제거**: 복잡한 경로 찾기 알고리즘 대신 TESSELATION의 연결 정보 직접 활용
- **그래프 기반 삼각형 찾기**: 3개의 연결이 순환하는 경우를 찾아 삼각형 메쉬 구성
- **부위별 최적화**: 각 부위의 특성에 맞게 주변 확장 여부 자동 결정

### 사용자 경험 개선
- **시각적 확인 용이**: 삼각형 메쉬로 그려져서 포인트 누락 여부를 쉽게 확인
- **자동 확장**: 주변 영역을 자동으로 포함하여 더 넓은 영역 표시
- **모든 부위 지원**: 눈, 눈썹, 코, 입, 얼굴 외곽선 모두 동일한 방식으로 처리

## 추가 개선 사항

### 주변 확장 레벨 선택 기능
- [x] 주변 확장 레벨 선택 UI 추가
  - 스핀박스로 확장 레벨 선택 (0~5, 기본값: 1)
  - 0: 확장 없음 (원본 포인트만)
  - 1: 한 줄 확장 (기본값)
  - 2: 두 줄 확장
  - 3 이상: 그 이상 확장
- [x] `_build_polygon_path_from_connections()` 함수에 확장 레벨 파라미터 추가
  - 확장 레벨에 따라 여러 번 이웃 포인트 추가
  - TESSELATION 그래프를 사용하여 레벨별로 이웃 포인트 찾기
  - 각 레벨마다 현재 레벨의 이웃 포인트를 찾아서 다음 레벨로 확장
- [x] UI 통합
  - 랜드마크 표시 옵션 영역에 확장 레벨 선택 UI 추가
  - 확장 레벨 변경 시 폴리곤 자동 업데이트
  - 모든 부위(눈, 눈썹, 코, 입, 얼굴 외곽선)에 확장 레벨 적용
