# 작업 계획서: MediaPipe 랜드마크 표시 기능 추가

**작업 일시**: 2026-01-09 14:41  
**작업 목표**: MediaPipe로 감지한 얼굴 랜드마크를 이미지에 시각적으로 표시하는 기능 추가

## 작업 배경
- MediaPipe를 사용하여 얼굴을 감지하고 있지만, 감지된 랜드마크를 시각적으로 확인할 수 없음
- 얼굴 추출 시 얼굴이 정확히 감지되었는지 확인하기 어려움
- 랜드마크 표시 기능을 통해 얼굴 감지 정확도를 시각적으로 확인 가능

## 작업 범위

### 1. 랜드마크 표시 기능 구현
- MediaPipe로 감지한 랜드마크를 이미지에 그리는 함수 추가
- 얼굴 윤곽선, 눈썹, 눈, 코, 입술 윤곽선 표시
- MediaPipe 공식 인덱스 사용

### 2. GUI 통합
- 얼굴 추출 패널에 랜드마크 표시 옵션 추가
- 체크박스로 표시/숨김 제어

## 작업 순서

### 1단계: 랜드마크 그리기 함수 구현
- [x] `utils/face_landmarks.py`에 `draw_landmarks()` 함수 추가
  - [x] MediaPipe 공식 상수 사용 (`FACEMESH_FACE_OVAL`, `FACEMESH_LEFT_EYEBROW`, 등)
  - [x] OpenCV 사용 가능 시 OpenCV로 그리기
  - [x] OpenCV 없을 시 PIL로 그리기
  - [x] 얼굴 윤곽선 (하늘색)
  - [x] 왼쪽 눈썹 (보라색)
  - [x] 오른쪽 눈썹 (분홍색)
  - [x] 왼쪽 눈 윤곽선 (빨간색)
  - [x] 오른쪽 눈 윤곽선 (빨간색)
  - [x] 코 윤곽선 (파란색)
  - [x] 입술 윤곽선 (초록색)
  - [x] 중심점 표시 제거 (윤곽선만 표시)

### 2단계: GUI 통합
- [x] `gui/_face_extract.py`에 랜드마크 표시 기능 추가
  - [x] `show_landmarks` BooleanVar 추가
  - [x] MediaPipe 체크박스 옆에 "랜드마크 표시" 체크박스 추가
  - [x] `extract_face()`에서 MediaPipe 사용 시 랜드마크 자동 감지 및 저장
  - [x] `show_original_preview()`에서 랜드마크 표시 옵션이 켜져 있으면 랜드마크 그리기
  - [x] 크롭된 영역에 맞게 랜드마크 좌표 자동 조정
  - [x] `on_landmarks_toggle()` 함수 추가

### 3단계: MediaPipe 공식 인덱스 사용
- [x] 임의로 작성한 인덱스 리스트 제거
- [x] MediaPipe 공식 상수 사용
  - [x] `FACEMESH_FACE_OVAL` - 얼굴 윤곽선
  - [x] `FACEMESH_LEFT_EYEBROW` - 왼쪽 눈썹
  - [x] `FACEMESH_RIGHT_EYEBROW` - 오른쪽 눈썹
  - [x] `FACEMESH_LEFT_EYE` - 왼쪽 눈
  - [x] `FACEMESH_RIGHT_EYE` - 오른쪽 눈
  - [x] `FACEMESH_NOSE` - 코
  - [x] `FACEMESH_LIPS` - 입술

### 4단계: 얼굴 영역 계산 개선
- [x] `utils/kaodata_image.py`의 얼굴 영역 계산 방식 개선
  - [x] 추정치 방식 제거 (눈 사이 거리 * 2.5 등)
  - [x] 실제 랜드마크 포인트의 min/max 값 사용
  - [x] `FACEMESH_FACE_OVAL` 포인트를 사용하여 정확한 얼굴 영역 계산
  - [x] MediaPipe import 추가 및 예외 처리
  - [x] 얼굴 윤곽선과 일치하는 영역 테두리 계산

## 기술 스택
- Python
- PIL/Pillow (이미지 처리)
- OpenCV (이미지 그리기, 선택적)
- MediaPipe (랜드마크 감지)

## 구현 세부사항

### 랜드마크 표시 색상 (BGR 형식)
- 얼굴 윤곽선: 하늘색 (0, 255, 255)
- 왼쪽 눈썹: 보라색 (255, 0, 255)
- 오른쪽 눈썹: 분홍색 (255, 192, 203)
- 왼쪽/오른쪽 눈 윤곽선: 빨간색 (255, 0, 0)
- 코 윤곽선: 파란색 (0, 0, 255)
- 입술 윤곽선: 초록색 (0, 255, 0)

### MediaPipe 공식 상수 사용
- MediaPipe Face Mesh의 공식 상수를 사용하여 정확한 랜드마크 연결 정보 활용
- 각 상수는 `[(시작점, 끝점), ...]` 형태의 튜플 리스트
- 공식 인덱스를 사용함으로써 정확도와 호환성 향상

### 좌표 조정
- 원본 이미지 기준 랜드마크 좌표를 크롭된 영역에 맞게 자동 조정
- 미리보기 이미지에 정확하게 표시되도록 좌표 변환

### 얼굴 영역 계산 개선
- **이전 방식**: 눈 사이 거리를 기준으로 추정 (눈 사이 거리 * 2.5 = 얼굴 너비)
- **개선된 방식**: 실제 랜드마크 포인트의 min/max X, Y 값을 사용하여 bounding box 계산
- `FACEMESH_FACE_OVAL`의 모든 포인트를 사용하여 얼굴 윤곽선과 일치하는 영역 계산
- 추정치 대신 실제 랜드마크 기반으로 정확도 향상
- 얼굴 영역 테두리가 윤곽선과 일치하도록 개선

## 주의사항
- MediaPipe가 없으면 랜드마크 표시 기능 사용 불가
- OpenCV가 없어도 PIL로 대체 가능
- Exception 발생 시 pass 금지, 모든 에러는 로그 출력
- 랜드마크 표시는 미리보기용이며, 실제 저장되는 이미지에는 영향 없음

## 완료 조건
- [x] `draw_landmarks()` 함수 구현 완료
- [x] 모든 윤곽선 표시 기능 구현 완료
- [x] GUI에 랜드마크 표시 옵션 통합 완료
- [x] MediaPipe 공식 인덱스 사용 완료
- [x] 좌표 조정 로직 구현 완료
- [x] 얼굴 영역 계산 방식 개선 완료 (추정치 → 실제 랜드마크 기반)

## 참고 사항
- 기존 작업 계획서: `specs/task260109_1311.md` (MediaPipe 적용)
- 관련 모듈:
  - `utils/face_landmarks.py`: `draw_landmarks()` 함수
  - `gui/_face_extract.py`: 얼굴 추출 패널, 랜드마크 표시 옵션
  - `utils/kaodata_image.py`: `extract_face_region()` 함수 (얼굴 영역 계산 개선)