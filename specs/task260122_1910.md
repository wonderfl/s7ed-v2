# 작업계획서: 눈동자 이동 방식 개선

## 1. 작업 목표
- 눈동자 이동 제약을 완화하고 사용자에게 관련 옵션을 제공합니다.
- 눈동자 윤곽의 자연스러운 이동을 위해 눈꺼풀 랜드마크와 연동을 강화합니다.
- 눈동자 확대/축소 효과를 개선하고 시각화 기능을 강화합니다.
- 변경된 로직을 테스트하고 디버깅할 수 있는 환경을 구축합니다.

## 2. 문제 분석
현재 눈동자 이동 관련 기능은 다음과 같은 문제점을 가지고 있습니다.
- **제약 조건의 한계**: 눈동자 이동에 대한 고정된 제약 조건이 있어 사용자가 자유롭게 조절하기 어렵습니다.
- **연동 부족**: 눈동자 윤곽과 눈꺼풀 랜드마크 간의 연동이 미흡하여, 눈동자 이동 시 눈 모양이 부자연스러울 수 있습니다.
- **시각적 효과 부족**: 확대/축소 효과 및 시각화가 충분히 강화되지 않아 사용자가 변화를 직관적으로 인지하기 어렵습니다.
- **디버깅의 어려움**: 변경된 눈동자 이동 로직을 체계적으로 테스트하고 디버깅할 수 있는 전용 도구가 부족합니다.

## 3. 작업 계획

### 3.1. 눈동자 이동 제약 완화 및 사용자 옵션 추가
- `clamp_iris_to_eye_region` 함수의 로직을 검토하고, 눈 영역 마진 조절 및 클램핑 강도 조절 매개변수를 추가합니다.
- `_prepare_iris_centers` 함수에서 `clamp_iris_to_eye_region` 호출 시, 새로운 매개변수를 활용하도록 수정합니다.
- UI에 "눈동자 이동 범위 제한" 토글 옵션과 "제한 마진 비율" 슬라이더를 추가하여 사용자가 `clamp_iris_to_eye_region`의 작동 여부 및 강도를 제어할 수 있도록 합니다.
- 이 옵션의 상태를 `_draw_iris_tab_polygons` 및 `_draw_all_tab_polygons` 함수로 전달하여 눈동자 중앙 포인트 렌더링 및 드래그 로직에 반영합니다.

### 3.2. 눈동자 윤곽과 눈꺼풀 랜드마크 연동 강화
- `_draw_iris_tab_polygons` 함수에서 눈동자 중앙 포인트 이동 시, 새로운 위치에 따라 눈동자 윤곽 폴리곤 (`LEFT_IRIS`, `RIGHT_IRIS`)의 각 점들이 함께 이동하도록 수정합니다.
- 이 때, 눈꺼풀 랜드마크 (`LEFT_EYE`, `RIGHT_EYE`)를 기준으로 눈동자 윤곽이 눈꺼풀 안쪽으로 자연스럽게 들어가는 효과를 구현합니다.
- 필요하다면 `_prepare_iris_centers` 함수에서 눈동자 윤곽 랜드마크의 변형을 처리하는 로직을 추가하거나 수정합니다.

### 3.3. 확대/축소 효과 개선 및 시각화 강화
- `_draw_iris_tab_polygons` 함수에서 눈동자 중앙 포인트의 이동 거리에 비례하여 눈동자 윤곽 폴리곤의 크기가 미세하게 조절되도록 구현하여 원근감 또는 움직임의 효과를 더합니다.
- `scale_ratio`가 눈동자 폴리곤에도 직접적으로 적용되도록 합니다.
- `_prepare_iris_centers` 함수에서 `scale_factor`가 눈동자 윤곽 랜드마크의 변형에도 적절하게 반영되는지 확인하고 필요하다면 수정합니다.

### 3.4. 테스트 및 디버깅
- `debug` 폴더에 `debug_iris_movement.py`와 같은 파일을 생성하여, 변경된 눈동자 이동 로직을 시각적으로 테스트하고 디버깅합니다.
- 다양한 눈동자 위치와 확대/축소 레벨에서 예상대로 동작하는지 확인합니다.

## 4. 작업 순서
1. [x] `utils/face_morphing/polygon_morphing/core.py` 수정:
   - [x] `clamp_iris_to_eye_region` 함수에 마진 조절 및 클램핑 강도 매개변수 추가
   - [x] `_prepare_iris_centers` 함수에서 새 매개변수를 사용하여 `clamp_iris_to_eye_region` 호출
2. [x] `gui/face_edit/__init__.py` 수정:
   - [x] `FaceEditPanel` 클래스에 `tk.BooleanVar` (`self.iris_clamping_enabled`) 및 `tk.DoubleVar` (`self.iris_clamping_margin_ratio`) 추가
   - [x] `_create_eye_tab`에 "눈동자 이동 범위 제한" 토글과 "제한 마진 비율" 슬라이더 UI 추가
   - [x] `apply_editing` 함수에서 UI 변수 값을 `face_morphing.apply_all_adjustments` 함수로 전달
3. [x] `utils/face_morphing/integration.py` 수정:
   - [x] `apply_all_adjustments` 함수 시그니처에 `clamping_enabled` 및 `margin_ratio` 파라미터 추가 및 `morph_face_by_polygons`로 전달
4. [x] `gui/face_edit/polygon_renderer/tab_drawers.py` 수정:
   - [x] `_draw_iris_tab_polygons` 함수 시그니처에 `clamping_enabled` 및 `margin_ratio` 파라미터 추가
   - [ ] `_draw_iris_tab_polygons` 함수 내에서 눈동자 중앙 포인트 이동 시 윤곽 폴리곤의 점들이 함께 이동하도록 수정 (눈꺼풀 랜드마크 연동)
   - [ ] `_draw_iris_tab_polygons` 함수 내에서 눈동자 중앙 포인트 이동 거리에 비례하여 윤곽 폴리곤 크기 조절 로직 추가
   - [ ] `scale_ratio`가 눈동자 폴리곤에 직접 적용되도록 수정
5. [x] `gui/face_edit/polygon_renderer/all_tab_drawer.py` 수정:
   - [x] `_draw_all_tab_polygons` 함수 시그니처에 `clamping_enabled` 및 `margin_ratio` 파라미터 추가
   - [ ] `_draw_all_tab_polygons` 함수 내에서 `draw_iris` 함수 호출 시 새 파라미터 전달
6. [ ] `utils/face_morphing/polygon_morphing/core.py` (재검토):
   - [ ] `_prepare_iris_centers` 함수에서 눈동자 윤곽 랜드마크 변형 및 `scale_factor` 반영 로직 재검토 및 수정
7. [ ] `debug` 폴더에 `debug_iris_movement.py` 파일 생성 및 디버깅 코드 작성
8. [ ] 전체 기능 통합 테스트 및 검증