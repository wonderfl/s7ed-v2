# 리팩토링 작업계획서: 큰 파일 분리

**작업 일시**: 2025-01-18 18:01  
**작업 목적**: 1000줄 이상의 큰 파일들을 기능별로 분리하여 유지보수성 향상

## 작업 배경

현재 프로젝트에 1000줄 이상의 큰 파일들이 다수 존재:
- `polygon_renderer.py`: 3,013줄
- `adjustments.py`: 2,524줄
- `morphing.py`: 2,150줄
- `polygon_morphing.py`: 1,844줄
- 기타 1000줄 이상 파일들

큰 파일은 유지보수, 테스트, 협업에 불리하므로 기능별로 분리 필요.

## 작업 범위

### 1단계: polygon_renderer.py 리팩토링 (3,013줄 → 약 500줄 이하 파일들로 분리)

**현재 구조**:
- `PolygonRendererMixin` 클래스
- 7개 주요 메서드:
  - `_draw_landmark_polygons`: 랜드마크 폴리곤 그리기
  - `_get_polygon_from_indices`: 인덱스로 폴리곤 생성
  - `_build_polygon_path_from_connections`: 연결 정보로 폴리곤 경로 생성
  - `on_polygon_line_click`: 폴리곤 라인 클릭 이벤트
  - `_fill_polygon_area`: 폴리곤 영역 채우기
  - `_update_connected_polygons`: 연결된 폴리곤 업데이트
  - `_draw_flipped_triangles`: 뒤집힌 삼각형 그리기

**분리 계획**:
- `gui/face_edit/polygon_renderer/` 폴더 생성
- `__init__.py`: PolygonRendererMixin 통합 클래스
- `drawing.py`: 폴리곤 그리기 관련 메서드 (`_draw_landmark_polygons`, `_fill_polygon_area`, `_draw_flipped_triangles`)
- `polygon_builder.py`: 폴리곤 생성 관련 메서드 (`_get_polygon_from_indices`, `_build_polygon_path_from_connections`)
- `interaction.py`: 폴리곤 상호작용 관련 메서드 (`on_polygon_line_click`, `_update_connected_polygons`)
- `utils.py`: 유틸리티 함수들

**작업 내용**:
- [x] `gui/face_edit/polygon_renderer/` 폴더 생성
- [x] 각 파일로 메서드 분리
- [x] `__init__.py`에서 Mixin 클래스 통합
- [x] `gui/face_edit/__init__.py`에서 import 경로 수정 (이미 올바름)
- [x] 기존 `polygon_renderer.py` 삭제 (백업: polygon_renderer.py.bak)
- [x] 테스트 및 동작 확인 (모든 메서드 정상 import 확인)

---

### 2단계: adjustments.py 리팩토링 (2,524줄 → 약 300-500줄 파일들로 분리)

**현재 구조**:
- 16개 조정 함수:
  - 눈 관련: `adjust_eye_size`, `adjust_eye_spacing`, `adjust_eye_position`
  - 코 관련: `adjust_nose_size`
  - 입 관련: `adjust_mouth_size`, `adjust_upper_lip_size`, `adjust_lower_lip_size`, `adjust_upper_lip_shape`, `adjust_lower_lip_shape`, `adjust_upper_lip_width`, `adjust_lower_lip_width`, `adjust_lip_vertical_move`
  - 얼굴 관련: `adjust_jaw`, `adjust_face_size`
  - 부위별: `adjust_region_size`, `adjust_region_position`

**분리 계획**:
- `utils/face_morphing/adjustments/` 폴더 생성
- `__init__.py`: 모든 함수 export
- `eye_adjustments.py`: 눈 관련 조정 함수들 (3개)
- `nose_adjustments.py`: 코 관련 조정 함수들 (1개)
- `mouth_adjustments.py`: 입 관련 조정 함수들 (8개)
- `face_adjustments.py`: 얼굴 전체 조정 함수들 (2개)
- `region_adjustments.py`: 부위별 조정 함수들 (2개)

**작업 내용**:
- [x] `utils/face_morphing/adjustments/` 폴더 생성
- [x] 각 파일로 함수 분리
- [x] `__init__.py`에서 모든 함수 export
- [x] 기존 import 경로 확인 및 수정 필요 여부 확인 (수정 불필요)
- [x] 기존 `adjustments.py` 삭제 (백업: adjustments.py.bak)
- [x] 테스트 및 동작 확인 (모든 함수 정상 import 확인)

---

### 3단계: morphing.py 리팩토링 (2,150줄 → 약 500-800줄 파일들로 분리)

**현재 구조**:
- `MorphingManagerMixin` 클래스
- 19개 주요 메서드:
  - UI 생성: `_create_face_alignment_ui`, `_create_face_morphing_ui`
  - 이벤트 핸들러: `on_alignment_change`, `on_individual_region_change`, `on_eye_spacing_change`, `on_eye_region_display_change`, `on_lip_region_display_change`, `on_region_selection_change`, `on_landmarks_display_change`, `on_morphing_change`
  - 편집 적용: `apply_alignment`, `apply_editing`, `reset_morphing`
  - 보정 로직: `_apply_common_sliders`, `_apply_common_sliders_to_landmarks`
  - 유틸리티: `update_labels_only`, `update_polygons_only`, `_get_region_indices`

**분리 계획**:
- `gui/face_edit/morphing/` 폴더 생성
- `__init__.py`: MorphingManagerMixin 통합 클래스
- `ui.py`: UI 생성 관련 메서드 (`_create_face_alignment_ui`, `_create_face_morphing_ui`)
- `handlers.py`: 이벤트 핸들러 메서드들 (on_* 메서드들)
- `logic.py`: 편집 적용 및 보정 로직 (`apply_alignment`, `apply_editing`, `reset_morphing`, `_apply_common_sliders`, `_apply_common_sliders_to_landmarks`)
- `utils.py`: 유틸리티 메서드 (`update_labels_only`, `update_polygons_only`, `_get_region_indices`)

**작업 내용**:
- [x] `gui/face_edit/morphing/` 폴더 생성
- [x] 각 파일로 메서드 분리
- [x] `__init__.py`에서 Mixin 클래스 통합
- [x] `gui/face_edit/__init__.py`에서 import 경로 수정 (이미 올바름)
- [x] 기존 `morphing.py` 삭제 (백업: morphing.py.bak)
- [x] 테스트 및 동작 확인 (모든 메서드 정상 import 확인)

---

### 4단계: polygon_morphing.py 리팩토링 (1,844줄 → 약 300-500줄 파일들로 분리)

**현재 구조**:
- 14개 함수:
  - 유틸리티: `_get_neighbor_points`, `_check_triangles_flipped`
  - 메인 함수: `morph_face_by_polygons`
  - 변환 함수들: `transform_points_for_eye_size`, `transform_points_for_nose_size`, `transform_points_for_jaw`, `transform_points_for_face_size`, `transform_points_for_mouth_size`, `transform_points_for_eye_position`, `transform_points_for_lip_shape`, `transform_points_for_lip_width`, `transform_points_for_lip_vertical_move`
  - 이동 함수들: `move_point_group`, `move_points`

**분리 계획**:
- `utils/face_morphing/polygon_morphing/` 폴더 생성
- `__init__.py`: 주요 함수 export
- `core.py`: 메인 모핑 함수 (`morph_face_by_polygons`)
- `transformations.py`: 포인트 변환 함수들 (10개)
- `movement.py`: 포인트 이동 함수들 (2개)
- `utils.py`: 유틸리티 함수들 (2개)

**작업 내용**:
- [x] `utils/face_morphing/polygon_morphing/` 폴더 생성
- [x] 각 파일로 함수 분리
- [x] `__init__.py`에서 주요 함수 export
- [x] 기존 import 경로 확인 및 수정 필요 여부 확인 (수정 불필요)
- [x] 기존 `polygon_morphing.py` 삭제 (백업: polygon_morphing.py.bak)
- [x] 테스트 및 동작 확인 (모든 함수 정상 import 확인)

---

## 작업 순서

1. **1단계**: polygon_renderer.py 리팩토링 (가장 큰 파일, GUI 관련)
2. **2단계**: adjustments.py 리팩토링 (유틸리티 함수들)
3. **3단계**: morphing.py 리팩토링 (GUI 관련)
4. **4단계**: polygon_morphing.py 리팩토링 (유틸리티 함수들)

각 단계는 독립적으로 진행 가능하며, 완료 후 테스트를 거쳐 다음 단계로 진행.

## 주의사항

1. **기존 기능 유지**: 리팩토링 후 기존 기능이 정상 동작해야 함
2. **Import 경로 수정**: 모든 import 경로를 새 구조에 맞게 수정
3. **테스트 필수**: 각 단계 완료 후 반드시 테스트 수행
4. **점진적 진행**: 한 번에 하나씩 진행하여 문제 발생 시 롤백 용이
5. **문서화**: 각 파일에 docstring 유지

## 예상 소요 시간

- 1단계: 약 2-3시간
- 2단계: 약 1-2시간
- 3단계: 약 2-3시간
- 4단계: 약 1-2시간
- **총 예상 시간**: 약 6-10시간

## 검증 방법

각 단계 완료 후:
1. 프로그램 실행하여 기본 기능 동작 확인
2. 얼굴 편집 기능 테스트
3. 폴리곤 렌더링 테스트
4. 모핑 기능 테스트
5. 에러 로그 확인

---

## 작업 진행 상황

- [x] 1단계: polygon_renderer.py 리팩토링 (완료: 2025-01-18 18:02)
- [x] 2단계: adjustments.py 리팩토링 (완료: 2025-01-18 18:06)
- [x] 3단계: morphing.py 리팩토링 (완료: 2025-01-18 18:07)
- [x] 4단계: polygon_morphing.py 리팩토링 (완료: 2025-01-18 18:10)

---

**작성일**: 2025-01-18 18:01  
**작성자**: AI Assistant
