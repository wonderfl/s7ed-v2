# 작업 계획서: 눈동자 이동 방식 개선 (task260122_1910)

## 1. 작업 목표

사용자가 눈동자 중심점을 드래그할 때 눈동자 윤곽이 찌그러지거나 부자연스럽게 변형되는 현상을 해결하고, 눈꺼풀 랜드마크에 맞춰 눈동자가 자연스럽게 움직이도록 개선합니다.

### 최종 결과:
*   ✅ 눈동자 중심점 드래그 시 눈동자 윤곽이 찌그러지지 않고 자연스러운 형태를 유지
*   ✅ 눈동자 윤곽이 눈꺼풀 랜드마크 범위 내에서 자연스럽게 연동되어 움직임
*   ✅ 기존 얼굴 랜드마크 드래그 기능에 대한 회귀 버그 없음

## 2. 현재 상태 분석 및 문제점 (찌그러짐 현상 원인)

현재 `gui/face_edit/polygon_renderer/all_tab_drawer.py`의 `_draw_all_tab_polygons` 함수 (또는 내부적으로 호출되는 `draw_iris` 함수)와 `gui/face_edit/polygon_renderer/tab_drawers.py`의 `_draw_iris_tab_polygons` 함수 모두에서 눈동자 중심점의 이동량을 계산하여 이 이동량을 눈동자 윤곽 랜드마크(`LEFT_IRIS`, `RIGHT_IRIS`)에 직접 오프셋(offset) 방식으로 적용하고 있습니다. 이 방식은 눈동자 윤곽의 형태를 유지한 채 단순히 평행 이동시키는 것에 가깝습니다.

**문제점:**
*   **눈꺼풀 경계 미고려**: 눈동자 윤곽이 눈꺼풀의 실제 경계를 벗어나거나 침범하여 찌그러져 보이는 현상이 발생할 수 있습니다.
*   **형태 유지 부족**: 눈동자가 원형/타원형 등 자연스러운 형태를 유지하기 어렵고, 선형적인 이동에 따른 부자연스러운 변형이 발생할 수 있습니다.

## 3. 해결 방안 및 상세 계획

### 3.1. 눈동자 윤곽과 눈꺼풀 랜드마크 연동 강화
눈동자 중심점 이동 시, 눈꺼풀 랜드마크(`LEFT_EYE`, `RIGHT_EYE`)를 기준으로 눈동자 윤곽이 동적으로 재조정되도록 로직을 개선합니다.

*   **1단계: 눈동자 윤곽 재계산 로직 도입 (주요 변경: `_draw_all_tab_polygons`)**
    *   `[gui/face_edit/polygon_renderer/all_tab_drawer.py](gui/face_edit/polygon_renderer/all_tab_drawer.py)`의 `_draw_all_tab_polygons` 함수 (또는 해당 함수 내에서 눈동자를 그리는 `draw_iris` 함수) 내에서, 눈동자 중심점(`left_iris_center_current`, `right_iris_center_current`)이 업데이트되면, `LEFT_EYE` 및 `RIGHT_EYE` 랜드마크를 활용하여 새로운 눈동자 윤곽 폴리곤의 최적 위치와 형태를 계산하는 로직을 추가합니다.
    *   **잠재적 문제**: 새로운 윤곽 계산 로직이 복잡해지면 성능 저하가 발생할 수 있습니다.
    *   **해결 방안**: 계산된 윤곽을 캐싱하거나, 근사치를 사용하여 연산 부하를 최소화합니다.

*   **2단계: 눈꺼풀 경계 내 눈동자 형태 유지**
    *   눈동자 윤곽이 항상 눈꺼풀 랜드마크로 정의된 영역(`LEFT_EYE`, `RIGHT_EYE`) 내에 존재하도록 제약 조건을 적용합니다. 눈동자가 눈꺼풀을 벗어나려고 할 때, 형태가 찌그러지는 대신 눈꺼풀 경계에 맞춰 크기가 조절되거나 이동이 제한되도록 합니다.
    *   `[utils/face_morphing/polygon_morphing/core.py](utils/face_morphing/polygon_morphing/core.py)`의 `_prepare_iris_centers` 함수에서 `clamp_iris_to_eye_region` 함수를 호출할 때, `eye_landmarks`를 `LEFT_EYE` 또는 `RIGHT_EYE` 랜드마크로 정확히 전달하여 클램핑 로직이 눈꺼풀 경계를 올바르게 사용하도록 합니다.
    *   **잠재적 문제**: 클램핑 로직이 너무 강하게 적용되면 눈동자 이동 범위가 제한되어 부자연스러울 수 있습니다.
    *   **해결 방안**: `margin_ratio` 파라미터를 조절하여 눈꺼풀 경계로부터 적절한 마진을 두어 자연스러운 이동 범위를 확보합니다.

*   **3단계: `[utils/face_morphing/polygon_morphing/core.py](utils/face_morphing/polygon_morphing/core.py)`의 `_prepare_iris_centers` 함수 수정**
    *   `LEFT_IRIS` 및 `RIGHT_IRIS` 랜드마크를 눈꺼풀 랜드마크에 맞춰 유기적으로 변형하는 로직을 추가/수정합니다. 단순히 오프셋을 적용하는 것이 아니라, 눈꺼풀의 크기와 형태 변화에 따라 눈동자 윤곽이 재배치되도록 합니다.

### 3.2. 눈동자 클램핑 기능 조절 UI 추가
눈동자 클램핑의 유연성(`margin_ratio`)과 활성화 여부(`clamping_enabled`)를 UI를 통해 사용자가 직접 조절할 수 있도록 옵션을 추가합니다.

*   **1단계: UI를 통한 `margin_ratio` 및 `clamping_enabled` 조절 옵션 추가**
    *   `[gui/face_edit/polygon_drag_handler.py](gui/face_edit/polygon_drag_handler.py)` 수정: `margin_ratio` 및 `clamping_enabled` 값을 Tkinter `DoubleVar`, `BooleanVar`로 UI와 연동.
    *   `[gui/face_edit/morphing/ui.py](gui/face_edit/morphing/ui.py)` (전체 탭 UI를 구성하는 적절한 파일) 수정: `margin_ratio`를 조절할 수 있는 슬라이더와 `clamping_enabled` 체크박스를 추가.
    *   UI에서 변경된 `margin_ratio` 및 `clamping_enabled` 값이 `morph_face_by_polygons` 함수로 올바르게 전달되도록 로직 수정.

### 3.3. 테스트 계획

1.  **시나리오 1: 눈동자 드래그 시 찌그러짐 해소 확인**
    *   다양한 인물의 얼굴 이미지에서 좌우 눈동자 중심점을 극단적인 위치까지 드래그하며, 눈동자 윤곽이 찌그러지지 않고 자연스러운 원형/타원형을 유지하는지 육안으로 확인합니다.
    *   **확인 사항**:
        *   로그에 `[얼굴모핑] 눈동자 윤곽 재계산 완료`와 같은 메시지가 출력되는지 확인.
        *   `_draw_all_tab_polygons` 및 `_prepare_iris_centers` 함수 내의 중간 변수(예: `adjusted_landmarks_left_iris`의 좌표 변화)를 로그로 출력하여 기대하는 대로 변형되는지 확인.

2.  **시나리오 2: 눈꺼풀 랜드마크 연동 및 경계 유지 확인**
    *   눈동자 중심점을 눈꺼풀 경계 가까이 드래그했을 때, 눈동자 윤곽이 눈꺼풀 랜드마크에 맞춰 자연스럽게 조정되는지, 그리고 눈꺼풀을 과도하게 벗어나지 않는지 확인합니다.
    *   **확인 사항**:
        *   `clamp_iris_to_eye_region` 함수가 올바르게 호출되며, 반환되는 클램핑된 좌표가 합리적인 범위 내에 있는지 로그로 확인.

3.  **시나리오 3: 일반 랜드마크 드래그 회귀 테스트**
    *   눈동자 관련 로직 수정 후, 눈꺼풀, 코, 입, 얼굴 윤곽 등 다른 얼굴 랜드마크를 드래그하는 기존 기능들이 `[specs/task260122_2244.md](specs/task260122_2244.md)`의 8번 항목에서 확인했던 것처럼 정상적으로 작동하는지 회귀 테스트를 수행합니다.

### 3.4. 디버그 스크립트 작성
*   `debug/debug_iris_movement.py` 파일을 작성하여, 눈동자 이동 및 변형 로직의 핵심 부분을 별도로 테스트하고 시각적으로 검증할 수 있도록 합니다. 이 스크립트는 다양한 입력 이미지와 드래그 좌표에 대한 결과를 출력하여 디버깅을 용이하게 합니다.

## 4. 예상 변경 파일 및 코드 스니펫

*   `[gui/face_edit/polygon_renderer/all_tab_drawer.py](gui/face_edit/polygon_renderer/all_tab_drawer.py)`
    *   `_recalculate_iris_contour_points` 함수 정의 수정 (scale_factor 파라미터 제거)
    *   `_draw_all_tab_polygons` 함수 (또는 `draw_iris` 내부 함수) 수정 (눈동자 윤곽 재계산 시 scale_factor 전달 제거)

*   `[gui/face_edit/polygon_drag_handler.py](gui/face_edit/polygon_drag_handler.py)`
    *   `_initialize_drag_variables` 메서드 추가 (Tkinter `BooleanVar` 및 `DoubleVar` 초기화)
    *   `apply_polygon_drag_final` 함수 수정 (UI 변수에서 `clamping_enabled` 및 `margin_ratio` 값 가져와 `morph_face_by_polygons`에 전달)
    *   **이전에 추가했던 `on_iris_center_drag` 함수 내의 `scale_factor` 계산 로직 삭제 (이전 단계에서 이미 수행)**

*   `[utils/face_morphing/polygon_morphing/core.py](utils/face_morphing/polygon_morphing/core.py)`
    *   `_prepare_iris_centers` 함수 수정 (눈동자 윤곽 랜드마크 변형 로직 강화 및 `clamp_iris_to_eye_region`에 정확한 `eye_landmarks` 전달)
    *   **이전에 `_recalculate_iris_contour_points` 함수 독스트링 수정 (scale_factor 설명 제거)**

*   `[gui/face_edit/morphing/ui.py](gui/face_edit/morphing/ui.py)`
    *   `UIMixin` 클래스에 `_create_face_tab` 메서드 추가 (전체 탭 UI 생성 및 `clamping_enabled` 체크박스, `margin_ratio` 슬라이더 포함)

---

## 5. 다음 진행 방식

이 계획서의 체크리스트를 기반으로 작업을 시작해도 괜찮을까요? 아니면 추가적인 논의가 필요할까요?

## 6. 체크리스트 (Todos)

### 6.1. 눈동자 윤곽과 눈꺼풀 랜드마크 연동 강화
*   [x] 3.1.1단계: `_draw_all_tab_polygons` 함수 (또는 `draw_iris` 내부 함수) 내에 눈동자 윤곽 재계산 로직 도입
*   [x] 3.1.2단계: 눈동자 윤곽이 눈꺼풀 경계 내에 유지되도록 제약 조건 적용
*   [x] 3.1.3단계: `_prepare_iris_centers` 함수 수정 (눈동자 윤곽 랜드마크 변형 로직 강화)

### 6.2. 눈동자 클램핑 기능 조절 UI 추가
*   [x] 3.2.1단계: UI를 통한 `margin_ratio` 및 `clamping_enabled` 조절 옵션 추가
    *   `[gui/face_edit/polygon_drag_handler.py](gui/face_edit/polygon_drag_handler.py)` 수정: `margin_ratio` 및 `clamping_enabled` 값을 Tkinter `DoubleVar`, `BooleanVar`로 UI와 연동
    *   `[gui/face_edit/morphing/ui.py](gui/face_edit/morphing/ui.py)` (전체 탭 UI를 구성하는 적절한 파일) 수정: `margin_ratio`를 조절할 수 있는 슬라이더와 `clamping_enabled` 체크박스를 추가
    *   UI에서 변경된 `margin_ratio` 및 `clamping_enabled` 값이 `morph_face_by_polygons` 함수로 올바르게 전달되도록 로직 수정

### 6.3. 테스트 계획
*   [x] 3.3.1단계: 시나리오 1 - 눈동자 드래그 시 찌그러짐 해소 확인 (육안 및 로그)
*   [x] 3.3.2단계: 시나리오 2 - 눈꺼풀 랜드마크 연동 및 경계 유지 확인 (육안 및 로그)
*   [x] 3.3.3단계: 시나리오 3 - 일반 랜드마크 드래그 회귀 테스트
*   [x] 3.4단계: `debug/debug_iris_movement.py` 디버그 스크립트 작성 및 활용
