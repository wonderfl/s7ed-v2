# 작업 계획서: 비슷한 얼굴 목록 표시/비교 기능

**작업 일시**: 2026-01-09 21:55  
**작업 목표**: 현재 보고 있는 이미지와 비슷한 얼굴을 찾아서 목록으로 표시하고 비교할 수 있는 기능 구현

## 작업 배경
- 이미지를 보고 작업하다 보면 비슷한 얼굴들이 많아서 구분이 어려움
- 현재 이미지와 비슷한 얼굴을 찾아서 비교할 수 있는 기능이 필요함
- 비슷한 얼굴 목록을 표시하고 클릭하면 해당 이미지로 이동할 수 있어야 함

## 작업 순서

### 1단계: 얼굴 특징 벡터 추출 함수 구현
- [x] `utils/face_landmarks.py`에 얼굴 특징 벡터 추출 함수 추가
  - 함수명: `extract_face_features_vector(image, landmarks=None)`
  - 랜드마크 기반 특징 벡터 생성
    - 눈 사이 거리 (정규화)
    - 코 위치 (정규화)
    - 입 위치 (정규화)
    - 얼굴 비율 (너비/높이)
    - 주요 랜드마크 포인트들의 상대적 위치
  - 반환: 특징 벡터 (numpy array 또는 list)
  - 랜드마크가 없으면 None 반환

### 2단계: 얼굴 유사도 계산 함수 구현
- [x] `utils/face_landmarks.py`에 유사도 계산 함수 추가
  - 함수명: `calculate_face_similarity(features1, features2)`
  - 코사인 유사도 또는 유클리드 거리 사용
  - 반환: 유사도 점수 (0.0 ~ 1.0, 1.0이 가장 유사)
- [ ] `utils/face_landmarks.py`에 여러 얼굴과 비교하는 함수 추가
  - 함수명: `find_similar_faces(reference_features, face_features_list, top_n=10)`
  - 모든 얼굴과 비교하여 유사도 점수 계산
  - 상위 N개 반환 (유사도 점수와 함께)

### 3단계: 비슷한 얼굴 검색 Mixin 구현
- [x] `gui/_face_extract_similar.py` 새 파일 생성
  - `SimilarFaceManagerMixin` 클래스 구현
  - `find_similar_faces()` 메서드: 현재 이미지와 비슷한 얼굴 찾기
  - 모든 이미지 파일을 순회하며 특징 벡터 추출 및 비교
  - 캐싱: 이미 추출한 특징 벡터는 파일별로 저장하여 재사용
  - 특징 벡터 캐시 파일: `{image_path}.s7ed.features` (JSON 또는 pickle)

### 4단계: UI에 비슷한 얼굴 목록 패널 추가
- [x] `gui/_face_extract.py`의 UI 생성 함수 수정
  - `_create_similar_faces_ui()` 함수 추가
  - 미리보기 영역 아래 또는 옆에 비슷한 얼굴 목록 패널 추가
  - 스크롤 가능한 리스트박스 또는 캔버스
  - 각 항목: 미리보기 이미지(썸네일), 파일명, 유사도 점수 표시
  - 클릭 시 해당 이미지로 이동
- [ ] "비슷한 얼굴 찾기" 버튼 추가
  - 클릭 시 현재 이미지와 비슷한 얼굴 검색
  - 검색 중 로딩 표시
  - 결과를 목록에 표시

### 5단계: 성능 최적화 및 캐싱
- [x] 특징 벡터 캐싱 구현
  - 이미지 파일의 해시값을 사용하여 캐시 키 생성
  - 파일 수정 시간 확인하여 캐시 무효화
  - 캐시 파일 저장/로드 함수 구현
- [ ] 비동기 검색 (선택사항)
  - 많은 이미지가 있을 경우 UI 블로킹 방지
  - 진행률 표시

## 구현 세부사항

### 얼굴 특징 벡터 구성
1. 눈 사이 거리 (정규화: 얼굴 너비 대비)
2. 코 위치 (정규화: 얼굴 중심 기준)
3. 입 위치 (정규화: 얼굴 중심 기준)
4. 얼굴 비율 (너비/높이)
5. 주요 랜드마크 포인트들의 상대적 좌표 (정규화)

### 유사도 계산
- 코사인 유사도 사용: `cosine_similarity = dot(f1, f2) / (norm(f1) * norm(f2))`
- 또는 유클리드 거리: `distance = sqrt(sum((f1 - f2)^2))`, 유사도 = 1 / (1 + distance)

### UI 레이아웃
- 비슷한 얼굴 목록 패널을 미리보기 영역 아래에 추가
- 또는 별도 탭/프레임으로 구성
- 각 항목: 썸네일(96x120), 파일명, 유사도 점수(예: 85.3%)
- 더블클릭 또는 클릭 시 해당 이미지 로드

### 캐싱 전략
- 특징 벡터를 JSON 파일로 저장: `{image_path}.s7ed.features`
- 이미지 파일의 수정 시간과 비교하여 캐시 유효성 확인
- 캐시가 있으면 재계산하지 않고 로드
