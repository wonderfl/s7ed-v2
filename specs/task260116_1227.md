# 얼굴 편집 패널 리팩토링 계획서

## 목적
큰 파일들을 기능별로 분리하여 유지보수성과 가독성 향상

## 현재 상태

### 파일 크기
- `preview.py`: 3,316줄 (가장 큼)
- `canvas.py`: 1,585줄
- `morphing.py`: 1,479줄
- `__init__.py`: 1,033줄
- `file.py`: 215줄
- `style.py`: 116줄
- `age.py`: 91줄

## 리팩토링 계획

### 1. preview.py 분리 (3,316줄 → 약 500-800줄씩)

#### 1.1 `polygon_renderer.py` (신규 생성)
**책임**: 폴리곤 그리기 관련 기능
- `_draw_landmark_polygons()` - 폴리곤 그리기
- `_build_polygon_path_from_connections()` - 폴리곤 경로 생성
- `_get_polygon_from_indices()` - 인덱스로 폴리곤 가져오기
- `_update_connected_polygons()` - 연결된 폴리곤 업데이트
- 폴리곤 확장 레벨 관련 로직

**예상 크기**: 약 800-1000줄

#### 1.2 `landmark_display.py` (신규 생성)
**책임**: 랜드마크 표시 관련 기능
- `_draw_landmarks_on_canvas()` - 랜드마크 그리기
- `_draw_selected_landmark_indicator()` - 선택된 랜드마크 표시
- `_update_connected_lines()` - 연결선 업데이트
- 랜드마크 포인트 표시 관련 로직

**예상 크기**: 약 500-700줄

#### 1.3 `tab_renderer.py` (신규 생성)
**책임**: 탭별 렌더링 로직
- `_get_target_indices_for_tab()` - 탭별 인덱스 가져오기
- 탭별 폴리곤 그리기 로직
- "눈", "눈썹", "코", "입", "윤곽", "전체" 탭별 처리

**예상 크기**: 약 400-600줄

#### 1.4 `preview.py` (리팩토링 후)
**책임**: 미리보기 UI 및 기본 표시 기능
- `_create_preview_ui()` - 미리보기 UI 생성
- `show_original_preview()` - 원본 이미지 표시
- `show_edited_preview()` - 편집된 이미지 표시
- `update_face_features_display()` - 얼굴 특징 표시 업데이트 (조정)
- 확대/축소 관련 기능

**예상 크기**: 약 800-1000줄

### 2. canvas.py 분리 (1,585줄 → 약 500-800줄씩)

#### 2.1 `canvas_drag_handler.py` (신규 생성)
**책임**: 캔버스 드래그 이벤트 처리
- `on_canvas_original_drag_start()` - 원본 드래그 시작
- `on_canvas_original_drag()` - 원본 드래그 중
- `on_canvas_original_drag_end()` - 원본 드래그 종료
- `on_canvas_edited_drag_start()` - 편집 드래그 시작
- `on_canvas_edited_drag()` - 편집 드래그 중
- `on_canvas_edited_drag_end()` - 편집 드래그 종료

**예상 크기**: 약 400-600줄

#### 2.2 `polygon_drag_handler.py` (신규 생성)
**책임**: 폴리곤 포인트 드래그 처리
- `on_polygon_drag_start()` - 폴리곤 드래그 시작
- `on_polygon_drag()` - 폴리곤 드래그 중
- `on_polygon_drag_end()` - 폴리곤 드래그 종료
- `apply_polygon_drag_final()` - 드래그 최종 적용
- `_find_nearest_landmark_for_drag()` - 가장 가까운 랜드마크 찾기

**예상 크기**: 약 500-700줄

#### 2.3 `canvas.py` (리팩토링 후)
**책임**: 캔버스 기본 이벤트 처리
- 캔버스 초기화
- 기본 이벤트 바인딩
- 좌표 변환 유틸리티

**예상 크기**: 약 300-500줄

### 3. morphing.py 분리 (1,479줄 → 약 500-800줄씩)

#### 3.1 `slider_ui.py` (신규 생성)
**책임**: 슬라이더 UI 생성
- 눈 크기 슬라이더 생성
- 코 크기 슬라이더 생성
- 입술 편집 슬라이더 생성
- 얼굴 크기 슬라이더 생성
- 슬라이더 생성 헬퍼 함수들

**예상 크기**: 약 600-800줄

#### 3.2 `morphing.py` (리팩토링 후)
**책임**: 모핑 관리 및 편집 적용
- `apply_editing()` - 편집 적용
- `on_morphing_change()` - 모핑 변경 처리
- 탭 생성 및 관리

**예상 크기**: 약 600-800줄

### 4. __init__.py 분리 (1,033줄 → 약 500-600줄)

#### 4.1 `widget_creator.py` (신규 생성)
**책임**: 위젯 생성 관련 기능
- `create_widgets()` - 위젯 생성
- 탭 생성 로직
- 버튼, 라벨 등 UI 요소 생성

**예상 크기**: 약 400-600줄

#### 4.2 `__init__.py` (리팩토링 후)
**책임**: 메인 클래스 정의 및 초기화
- `FaceEditPanel` 클래스 정의
- `__init__()` - 초기화
- 변수 초기화

**예상 크기**: 약 400-500줄

## 리팩토링 순서

### Phase 1: preview.py 분리 (우선순위 높음)
- [x] 1. `polygon_renderer.py` 생성 및 폴리곤 관련 함수 이동
- [x] 2. `landmark_display.py` 생성 및 랜드마크 표시 함수 이동
- [x] 3. `tab_renderer.py` 생성 및 탭별 렌더링 로직 이동
- [x] 4. `preview.py` 정리 및 import 추가
- [x] 5. Phase 1 기능 테스트 및 검증

### Phase 2: canvas.py 분리
- [x] 1. `canvas_drag_handler.py` 생성 및 드래그 이벤트 이동
- [x] 2. `polygon_drag_handler.py` 생성 및 폴리곤 드래그 이동
- [x] 3. `canvas.py` 정리 및 import 추가
- [x] 4. Phase 2 기능 테스트 및 검증

### Phase 3: morphing.py 분리
- [x] 1. `slider_ui.py` 생성 및 슬라이더 UI 생성 함수 이동
- [x] 2. `morphing.py` 정리 및 import 추가
- [x] 3. Phase 3 기능 테스트 및 검증

### Phase 4: __init__.py 분리
- [x] 1. `widget_creator.py` 생성 및 위젯 생성 함수 이동
- [x] 2. `__init__.py` 정리 및 import 추가
- [x] 3. Phase 4 기능 테스트 및 검증

## 진행 상황

**현재 상태**: 모든 Phase 완료 ✅
**시작일**: 2026-01-16
**완료일**: 2026-01-16 

## 주의사항

1. **기존 기능 유지**: 리팩토링 후에도 모든 기능이 정상 작동해야 함
2. **Mixin 패턴 유지**: 기존 Mixin 구조 유지
3. **순환 참조 방지**: import 순서 주의
4. **테스트**: 각 Phase 완료 후 기능 테스트 필수

## 예상 결과

### 리팩토링 후 파일 구조 (실제 결과)
```
gui/face_edit/
├── __init__.py (872줄) ✅
├── widget_creator.py (186줄) ✅
├── file.py (206줄)
├── style.py (113줄)
├── age.py (89줄)
├── preview.py (1,191줄) ✅
├── polygon_renderer.py (1,838줄) ✅
├── landmark_display.py (641줄) ✅
├── tab_renderer.py (50줄) ✅
├── canvas.py (400줄) ✅
├── canvas_drag_handler.py (421줄) ✅
├── polygon_drag_handler.py (378줄) ✅
├── morphing.py (748줄) ✅
└── slider_ui.py (711줄) ✅
```

### 개선 효과
- 최대 파일 크기: 3,316줄 → 1,838줄 (약 45% 감소)
- 평균 파일 크기: 약 1,500줄 → 약 700줄 (약 53% 감소)
- 가독성 향상: 기능별로 명확히 분리
- 유지보수성 향상: 수정 시 해당 파일만 확인
- 총 7개의 새로운 Mixin 클래스 생성으로 모듈화 완료

## 진행 방법

각 Phase를 순차적으로 진행하며, 각 단계마다:
1. 새 파일 생성
2. 관련 함수 이동
3. import 추가
4. 테스트 및 검증
5. 다음 Phase 진행
