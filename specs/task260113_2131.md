# 작업 계획서: 랜드마크 기반 얼굴 변형 기능 개선 (하이브리드 방식)

**작업 일시**: 2026-01-13 21:31  
**작업 목표**: MediaPipe 랜드마크 포인트를 활용한 얼굴 변형 기능 개선 및 고급 변형 기능 추가

## 작업 배경
- 현재 얼굴 편집 기능은 영역 기반 방식으로 잘 작동 중
- MediaPipe 랜드마크 포인트를 참조만 하고 직접 변형에는 활용하지 않음
- 랜드마크 포인트를 직접 이동시켜 더 정밀하고 자연스러운 얼굴 변형 가능
- Delaunay Triangulation + Warping 방식으로 더 정확한 변형 구현 가능

## 현재 상태 분석

### 기존 구조
1. `utils/face_morphing.py`: 얼굴 특징 보정 모듈
   - 영역 기반 변형 방식 (리사이즈 + 블렌딩)
   - 랜드마크 포인트를 영역 계산에만 사용
   - `adjust_eye_size()`, `adjust_nose_size()`, `adjust_mouth_size()` 등
2. `utils/face_landmarks.py`: MediaPipe 랜드마크 감지
   - 468개 랜드마크 포인트 감지
   - 주요 랜드마크 추출 (`get_key_landmarks()`)
3. `gui/face_edit/`: 얼굴 편집 패널
   - 슬라이더 기반 UI
   - 실시간 미리보기

### 참조하는 파일 목록
- `utils/face_morphing.py`: 얼굴 특징 보정 함수들
- `utils/face_landmarks.py`: MediaPipe 랜드마크 감지
- `gui/face_edit/morphing.py`: 얼굴 편집 UI 및 로직

## 작업 순서

### 1단계: 현재 방식 개선 (우선순위 높음)

#### 1-1. 랜드마크 포인트 계산 정밀도 향상
- [x] `_get_eye_region()` 함수 개선
  - 현재: 랜드마크 포인트의 min/max로 영역 계산
  - 개선: 더 정확한 경계 계산 (표준편차 기반 패딩 등)
  - 개선: 직사각형 영역 계산 (눈을 모두 포함, 비율 조정)
  - 개선: 모든 눈 포인트 포함 확인 및 영역 확장
- [x] `_get_mouth_region()` 함수 추가 (입 영역 계산 개선)
  - 현재: 입 중심점 기반 계산
  - 개선: 입술 랜드마크 포인트를 활용한 정확한 영역 계산
- [x] `_get_nose_region()` 함수 추가 (코 영역 계산 개선)
  - 현재: 코 끝점 기반 계산
  - 개선: 코 랜드마크 포인트를 활용한 정확한 영역 계산

#### 1-2. 블렌딩 알고리즘 개선
- [x] 가우시안 블러 마스크 최적화
  - 현재: 고정된 마스크 크기 또는 간단한 계산
  - 개선: 영역 크기에 비례한 동적 마스크 크기
  - 개선: 타원형 마스크를 더 정확하게 계산
- [x] 블렌딩 경계 개선
  - 현재: 선형 보간
  - 개선: 더 부드러운 경계 (시그모이드 함수 사용)
- [ ] 색상 보정 추가 (선택적, 향후 개선)
  - 변형된 영역과 주변 영역의 색상 일관성 유지
  - 히스토그램 매칭 또는 색상 전송

#### 1-3. 영역 경계 계산 최적화
- [x] 랜드마크 포인트 기반 경계 계산 개선
  - 모든 관련 랜드마크 포인트를 고려한 경계 계산
  - 표준편차 기반 동적 패딩 계산 적용
- [x] 패딩 계산 개선
  - 현재: 고정 비율 또는 간단한 계산
  - 개선: 랜드마크 포인트 분포를 고려한 동적 패딩 (표준편차 기반)
  - 개선: 최소 패딩 20%, 표준편차 2배 적용 (모든 포인트 포함 보장)
- [x] 눈 영역 계산 추가 개선
  - 직사각형 영역 계산 (비율 조정: 최대 1.5:1)
  - 모든 눈 포인트 포함 확인 및 영역 확장 로직 추가

### 2단계: 선택적 랜드마크 직접 변형 기능 추가 (향후)

#### 2-1. Delaunay Triangulation 기반 변형 함수 구현
- [x] `morph_face_by_landmarks()` 함수 추가
  - 원본 랜드마크와 변형된 랜드마크를 받아서 변형
  - Delaunay Triangulation으로 삼각형 메시 생성
  - 각 삼각형에 Affine Transformation 적용
  - Warping으로 이미지 변형
- [x] `scipy.spatial.Delaunay` 사용
  - scipy를 사용하여 Delaunay Triangulation 수행
  - requirements.txt에 scipy 추가
- [x] 경계 처리
  - 이미지 경계 포인트 추가 (4개 모서리)
  - 경계 밖 영역 처리

#### 2-2. 랜드마크 포인트 이동 함수 구현
- [x] `move_landmark_points()` 함수 추가
  - 특정 랜드마크 포인트를 이동
  - 주변 랜드마크 포인트도 자연스럽게 이동 (가우시안 가중치 기반)
- [x] 랜드마크 그룹 이동
  - [x] `move_landmark_group()` 함수 추가
  - [x] 눈, 코, 입 등 그룹 단위로 이동
  - [x] 그룹 내부 랜드마크 간 상대적 위치 유지

#### 2-3. 고급 변형 기능 통합
- [x] `apply_all_adjustments()` 함수에 랜드마크 직접 변형 옵션 추가
  - `use_landmark_warping` 파라미터 추가 (기본값: False)
  - True일 때 Delaunay Triangulation 방식 사용 (기본 구조 완성)
  - False일 때 기존 영역 기반 방식 사용
- [ ] 성능 최적화 (향후 개선)
  - 랜드마크 직접 변형은 계산 비용이 높으므로 선택적 사용
  - 캐싱 또는 최적화 기법 적용
- [x] 랜드마크 변형 로직 구현
  - [x] 각 편집 파라미터를 랜드마크 포인트 변형으로 변환
  - [x] 눈 크기 조정 랜드마크 변형 (`transform_landmarks_for_eye_size`)
  - [x] 코 크기 조정 랜드마크 변형 (`transform_landmarks_for_nose_size`)
  - [x] 입 크기 조정 랜드마크 변형 (`transform_landmarks_for_mouth_size`)
  - [x] 눈 위치 조정 랜드마크 변형 (`transform_landmarks_for_eye_position`)
  - [x] `apply_all_adjustments()`에 랜드마크 변형 로직 통합
  - [x] 입술 세부 편집 랜드마크 변형
    - [x] 입술 모양(두께) 조정 (`transform_landmarks_for_lip_shape`)
    - [x] 입술 너비 조정 (`transform_landmarks_for_lip_width`)
    - [x] 입술 수직 이동 조정 (`transform_landmarks_for_lip_vertical_move`)

#### 2-4. UI 통합
- [x] "고급 모드" 체크박스 추가
  - 랜드마크 직접 변형 모드 활성화/비활성화
  - 기본값: False (기존 방식 사용)
  - scipy 사용 가능 여부 표시
- [x] 랜드마크 포인트 시각화 및 드래그 기능
  - [x] 캔버스에서 랜드마크 포인트를 직접 드래그하여 이동
  - [x] 고급 모드일 때 랜드마크 포인트 크기 증가 (드래그 용이)
  - [x] 드래그 중 실시간 미리보기 업데이트
  - [x] 드래그 종료 시 최종 편집 적용

## 기술 사항

### Delaunay Triangulation
- MediaPipe의 468개 랜드마크 포인트를 삼각형 메시로 분할
- 각 삼각형은 3개의 랜드마크 포인트로 구성
- 삼각형 간 겹침 없이 전체 얼굴 영역 커버

### Affine Transformation
- 원본 삼각형 → 변형된 삼각형 매핑
- 3개의 점으로 Affine 변환 행렬 계산
- `cv2.getAffineTransform()` 사용

### Warping
- 각 삼각형 영역을 Affine 변환으로 변형
- `cv2.warpAffine()` 사용
- 경계 블렌딩으로 자연스러운 결과

### 성능 고려사항
- Delaunay Triangulation: O(n log n) 시간 복잡도
- 468개 포인트 기준 약 수백 개의 삼각형 생성
- 실시간 처리 가능하지만 기존 방식보다 느림
- 선택적 사용으로 성능과 품질 균형

## 구현 세부사항

### 1단계 개선 사항

#### 랜드마크 포인트 활용 개선
- 눈 영역: 16개 랜드마크 포인트 모두 활용
- 코 영역: 코 관련 랜드마크 포인트 활용 (약 20개)
- 입 영역: 입술 랜드마크 포인트 활용 (약 20개)

#### 블렌딩 개선
- 마스크 크기: `min(영역_너비, 영역_높이) / 4` (동적 계산)
- 가우시안 블러: 마스크 크기에 비례한 시그마 값
- 블렌딩 함수: 시그모이드 함수 또는 다항식 보간

### 2단계 구현 사항

#### Delaunay Triangulation
```python
# 의사 코드
1. 원본 랜드마크 포인트 리스트 생성
2. 이미지 경계 포인트 추가 (4개 모서리)
3. Delaunay Triangulation 수행
4. 변형된 랜드마크 포인트 계산
5. 각 삼각형에 대해:
   - 원본 삼각형 좌표 추출
   - 변형된 삼각형 좌표 계산
   - Affine 변환 행렬 계산
   - 삼각형 영역 Warping
6. 모든 삼각형 결과 합성
```

#### 랜드마크 포인트 이동
- 직접 이동: 사용자가 지정한 랜드마크 포인트 이동
- 주변 영향: 거리 기반 가중치로 주변 포인트도 이동
- 자연스러운 변형: 스프링 시스템 또는 가우시안 가중치

## 주의 사항
- 기존 코드 패턴과 일관성 유지
- 린터 오류 확인 필수
- 랜드마크가 감지되지 않을 경우 원본 이미지 반환
- Exception 발생 시 로그 출력 (pass 금지)
- 1단계 완료 후 테스트 완료 전까지 2단계 진행하지 않음
- 성능 테스트: 랜드마크 직접 변형은 느릴 수 있으므로 성능 측정 필요
- 메모리 사용량: Delaunay Triangulation 결과 캐싱 시 메모리 고려

## 작업 완료 상태
- [x] 1단계: 현재 방식 개선
  - [x] 1-1. 랜드마크 포인트 계산 정밀도 향상
    - [x] `_get_eye_region()` 개선 (직사각형 영역, 모든 포인트 포함)
    - [x] `_get_mouth_region()` 추가
    - [x] `_get_nose_region()` 추가
  - [x] 1-2. 블렌딩 알고리즘 개선 (시그모이드 함수 기반)
    - [x] `_sigmoid_blend_mask()` 함수 추가
    - [x] `_create_blend_mask()` 함수 추가
    - [x] 모든 편집 함수에 적용
  - [x] 1-3. 영역 경계 계산 최적화 (표준편차 기반 동적 패딩)
    - [x] 표준편차 기반 동적 패딩 계산
    - [x] 패딩 최소값 증가 (20%, 표준편차 2배)
    - [x] 모든 포인트 포함 확인 및 영역 확장
- [x] 2단계: 선택적 랜드마크 직접 변형 기능 추가 (기본 구조 완성)
  - [x] 2-1. Delaunay Triangulation 기반 변형 함수 구현
  - [x] 2-2. 랜드마크 포인트 이동 함수 구현
  - [x] 2-3. 고급 변형 기능 통합
    - [x] 기본 구조 완성
    - [x] 랜드마크 변형 로직 구현 (눈, 코, 입 크기 및 눈 위치)
  - [x] 2-4. UI 통합
    - [x] "고급 모드" 체크박스 추가
    - [x] 랜드마크 포인트 시각화 및 드래그 기능
  - [x] 입술 세부 편집 랜드마크 변형
    - [x] 입술 모양(두께) 조정
    - [x] 입술 너비 조정
    - [x] 입술 수직 이동 조정
  - [x] 랜드마크 그룹 이동 기능
    - [x] `move_landmark_group()` 함수 구현

## 참고 자료
- MediaPipe Face Mesh 랜드마크 인덱스: https://github.com/google/mediapipe/blob/master/mediapipe/python/solutions/face_mesh.py
- Delaunay Triangulation: OpenCV `Subdiv2D` 또는 scipy `spatial.Delaunay`
- Affine Transformation: OpenCV `getAffineTransform()`, `warpAffine()`

## 추가 개선 사항 (2026-01-13)

### 눈 영역 계산 개선
- ✅ 직사각형 영역 계산으로 변경
  - 눈의 가로/세로 비율을 고려한 직사각형 영역
  - 최대 1.5:1 비율로 제한 (너무 길쭉하지 않게)
- ✅ 모든 눈 포인트 포함 보장
  - 패딩 최소값 증가 (20%, 표준편차 2배)
  - 모든 포인트 포함 확인 및 영역 확장 로직 추가
- ✅ 크기 조정 시 비율 유지
  - 직사각형 영역으로 계산되어 단축도 장축과 비슷하게 늘어남
