# 작업 계획서: 눈동자 포인트 10개 → 중앙 포인트 2개로 대체 (방법 A)

**작업 일시**: 2026-01-18 17:06  
**작업 목적**: 눈동자 포인트 10개를 모두 제거하고 계산된 중앙 포인트 2개로 대체하여 정확도 향상 및 목표 달성

## 작업 배경

현재 코드는:
- contour 8개만 제거하고 중심점을 계산해서 추가
- 중심점 인덱스(468, 473)가 이미 MediaPipe에 존재하는데 계산하고 있음
- 변수명 불일치: `iris_contour_indices` 정의했는데 `iris_indices` 사용
- 매핑 테이블 없이 작동 중

## 문제점

1. **원래 목표와 불일치**: 원래 목표는 10개 → 2개였지만 현재는 8개 제거 + 2개 추가
2. **정확도 문제**: contour 포인트가 없으면 눈동자 내부 세부 변형이 제한적
3. **변수명 불일치**: 234줄에서 `iris_contour_indices` 정의, 266줄에서 `iris_indices` 사용 (NameError 발생 가능)
4. **매핑 복잡성**: 원본 인덱스와 Delaunay 배열 인덱스가 다를 수 있음

## 작업 목표

- **원래 목표 달성**: 눈동자 포인트 10개 → 중앙 포인트 2개로 대체
- **정확도 향상**: 계산된 중앙 포인트는 contour 포인트의 평균이므로 정보 손실 최소화
- **구현 단순화**: 드래그 시 좌표만 업데이트, 인덱스는 항상 배열 끝
- **매핑 단순화**: 인덱스는 항상 `len(landmarks) - 2`, `len(landmarks) - 1`

## 작업 단계

### 1단계: 변수명 수정 및 10개 모두 제거하도록 변경
**파일**: `utils/face_morphing/polygon_morphing.py`

- [x] 266줄: `iris_indices` 정의 및 사용 (변수명 불일치 해결)
- [x] 눈동자 포인트 10개 모두 제거 (contour 8개 + 중심점 2개)
  - contour 8개: 469-472, 474-477
  - 중심점 2개: 468, 473
- [x] 계산된 중앙 포인트 2개 추가 (contour 포인트의 평균)
- [x] 인덱스는 항상 배열 끝: `len(landmarks) - 2`, `len(landmarks) - 1`

**예상 시간**: 20분

### 2단계: 드래그 핸들러 수정
**파일**: `gui/face_edit/polygon_drag_handler.py`

- [x] `on_iris_center_drag`에서 계산된 중앙 포인트 좌표 업데이트
- [x] `custom_landmarks[len(custom) - 2]`, `custom_landmarks[len(custom) - 1]` 직접 업데이트
- [x] 별도 좌표 관리(`_left_iris_center_coord`, `_right_iris_center_coord`) 유지 (드래그 좌표 전달용)
- [x] LandmarkManager 동기화 확인

**예상 시간**: 25분

### 3단계: Delaunay 전달 로직 수정
**파일**: `utils/face_morphing/polygon_morphing.py`

- [x] `morph_face_by_polygons` 함수에서 눈동자 포인트 10개 모두 제거
- [x] 계산된 중앙 포인트 2개 추가 (전달된 좌표 사용 또는 계산)
- [x] `left_iris_center_coord`, `right_iris_center_coord` 파라미터 유지 (드래그 좌표 전달용)
- [x] 인덱스는 항상 배열 끝: `len(landmarks) - 2`, `len(landmarks) - 1`

**예상 시간**: 30분

### 4단계: 렌더러 수정
**파일**: `gui/face_edit/polygon_renderer.py`

- [x] 중심점 계산 로직 유지 (초기 계산용)
- [x] 계산된 중앙 포인트 사용하여 그리기 (배열 끝 인덱스에서 직접 가져오기)
- [x] 인덱스 표시: 실제 Delaunay 배열 인덱스 (`len(landmarks) - 2`, `len(landmarks) - 1`)

**예상 시간**: 20분

### 5단계: morphing.py 수정
**파일**: `gui/face_edit/morphing.py`

- [x] `_apply_common_sliders_to_landmarks`에서 중앙 포인트 좌표 업데이트
- [x] 사이즈 조정 시 계산된 중앙 포인트도 함께 변환
- [x] `apply_editing`에서 중앙 포인트 좌표 관리 유지

**예상 시간**: 25분

### 6단계: 테스트 및 검증
- [x] 중앙 포인트 인덱스가 올바르게 표시되는지 확인 (`len(landmarks) - 2`, `len(landmarks) - 1`)
- [x] 드래그가 정상 작동하는지 확인
- [x] Delaunay Triangulation이 올바르게 작동하는지 확인
- [x] 계산된 중앙 포인트가 contour 포인트의 평균인지 확인
- [x] 정확도가 향상되었는지 확인 (사용자 확인: 이미지가 깨끗하게 변환됨)

**예상 시간**: 30분

## 예상 효과

1. **목표 달성**: 원래 목표인 10개 → 2개로 대체 달성
2. **정확도 향상**: 계산된 중앙 포인트는 contour 포인트의 평균이므로 정보 손실 최소화
3. **구현 단순화**: 인덱스는 항상 배열 끝으로 고정되어 매핑 테이블 불필요
4. **버그 수정**: 변수명 불일치 문제 해결
5. **폴리곤 데이터 관리 호환**: Delaunay 배열이 깔끔하고 캐시 키가 안정적

## 주의사항

- 눈동자 포인트 10개 모두 제거 (contour 8개 + 중심점 2개)
- 계산된 중앙 포인트는 contour 포인트의 평균으로 계산
- 인덱스는 항상 배열 끝: `len(landmarks) - 2`, `len(landmarks) - 1`
- LEFT/RIGHT 매핑 원칙 유지 (절대 변경하지 않음)
- MediaPipe 정의 그대로 사용
- 기존 드래그 기능과의 호환성 유지

## 작업 상태

- [x] 1단계: 변수명 수정 및 10개 모두 제거
- [x] 2단계: 드래그 핸들러 수정
- [x] 3단계: Delaunay 전달 로직 수정
- [x] 4단계: 렌더러 수정
- [x] 5단계: morphing.py 수정
- [x] 6단계: 테스트 및 검증

## 작업 완료

**완료 일시**: 2026-01-18  
**최종 업데이트**: 2026-01-18 (morph_face_by_polygons 함수에 로직 추가)
**결과**: 모든 작업 단계 완료, 사용자 테스트 통과
- 이미지 변환이 깨끗하게 작동함
- 방법 A (10개 모두 제거 + 계산된 중앙 포인트 2개) 성공적으로 적용
- `morph_face_by_polygons` 함수에 눈동자 포인트 제거 및 중앙 포인트 추가 로직 구현 완료
- `left_iris_center_coord`, `right_iris_center_coord` 파라미터 추가 및 사용

## 참고 사항

- 원본 인덱스와 Delaunay 배열 인덱스 매핑:
  - 원본 0-467 → Delaunay 0-467 (그대로)
  - 원본 468-477 → 모두 제거됨 (10개)
  - 계산된 중앙 포인트 2개 추가 → Delaunay 배열 끝
  - 왼쪽 중앙 포인트: `len(landmarks) - 2`
  - 오른쪽 중앙 포인트: `len(landmarks) - 1`
  - 최종 랜드마크 개수: 478 - 10 + 2 = 470개

- 계산된 중앙 포인트:
  - 왼쪽: contour 포인트(474, 475, 476, 477)의 평균
  - 오른쪽: contour 포인트(469, 470, 471, 472)의 평균
  - 정보 손실 최소화 (평균값으로 경계 정보 일부 보존)

- 드래그 처리:
  - 드래그 시 좌표만 업데이트
  - `custom_landmarks[len(landmarks) - 2] = (new_x, new_y)`  # 왼쪽
  - `custom_landmarks[len(landmarks) - 1] = (new_x, new_y)`  # 오른쪽
