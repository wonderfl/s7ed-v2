# 작업 계획서: 얼굴 편집 패널 입 모양 수정 기능 추가

**작업 일시**: 2026-01-13 16:58  
**작업 목표**: 얼굴 편집 패널에 입 모양을 수정할 수 있는 기능 추가

## 작업 배경
- 현재 얼굴 편집 패널에는 눈, 코, 턱선, 얼굴 크기 조정 기능이 있음
- 입 탭은 UI에 존재하지만 플레이스홀더로만 되어 있음
- 입 모양 수정 기능이 없어 사용자가 입 크기나 너비를 조정할 수 없음
- 일관된 얼굴 편집 기능을 위해 입 모양 수정 기능 추가 필요

## 현재 상태 분석

### 기존 구조
1. `gui/face_edit/__init__.py`: 얼굴 편집 패널 메인 클래스
   - 눈, 코, 턱선, 얼굴 크기 관련 변수 정의됨
   - 입 관련 변수 없음
2. `gui/face_edit/morphing.py`: 얼굴 특징 보정 Mixin
   - `_create_mouth_tab()` 함수가 플레이스홀더로만 구현됨
   - `apply_editing()`에서 입 편집 적용 로직 없음
3. `utils/face_morphing.py`: 얼굴 모핑 유틸리티
   - `adjust_eye_size()`, `adjust_nose_size()`, `adjust_jaw()` 등 함수 존재
   - 입 관련 함수 없음
   - `apply_all_adjustments()`에 입 파라미터 없음

### 참조하는 파일 목록
- `gui/face_edit/__init__.py`: 얼굴 편집 패널 메인 클래스
- `gui/face_edit/morphing.py`: 얼굴 특징 보정 UI 및 로직
- `utils/face_morphing.py`: 얼굴 모핑 유틸리티 함수들

## 작업 순서

### 1단계: 입 편집 변수 추가
- [x] `gui/face_edit/__init__.py`에 입 관련 변수 추가
  - `mouth_size`: 입 크기 (0.5 ~ 2.0, 기본값: 1.0)
  - `mouth_width`: 입 너비 (0.5 ~ 2.0, 기본값: 1.0)

### 2단계: 입 편집 UI 구현
- [x] `gui/face_edit/morphing.py`의 `_create_mouth_tab()` 함수 구현
  - 입 크기 슬라이더 추가
  - 입 너비 슬라이더 추가
  - 눈/코 탭과 동일한 UI 패턴 적용
  - 라벨 업데이트 로직 추가 (`on_morphing_change()` 호출)

### 3단계: 입 편집 로직 구현
- [x] `utils/face_morphing.py`에 입 편집 함수 추가
  - `adjust_mouth_size()` 함수 구현 (입 크기 및 너비 조정 통합)
  - 랜드마크 기반으로 입 영역 계산 및 변형
  - 눈/코 편집과 동일한 패턴 적용 (리사이즈 + 블렌딩)

### 4단계: 입 편집 적용 로직 통합
- [x] `utils/face_morphing.py`의 `apply_all_adjustments()` 함수 수정
  - `mouth_size`, `mouth_width` 파라미터 추가
  - 입 편집 함수 호출 추가

### 5단계: 얼굴 편집 패널에서 입 편집 적용
- [x] `gui/face_edit/morphing.py`의 `apply_editing()` 함수 수정
  - `face_morphing.apply_all_adjustments()` 호출 시 입 파라미터 전달
  - `reset_morphing()` 함수에 입 변수 초기화 추가
  - `on_morphing_change()` 함수에 입 라벨 업데이트 추가

### 6단계: 테스트 및 검증
- [x] import 오류 확인 (린터 오류 없음)
- [x] 프로그램 실행 테스트 (사용자 확인 완료)
- [x] 입 모양 편집 기능 동작 확인 (사용자 확인 완료)
  - [x] 입 크기 조정 테스트
  - [x] 입 너비 조정 테스트
  - [x] 윗입술/아래입술 개별 조정 테스트
  - [x] 개별 적용 체크박스 동작 확인
  - [x] 다른 편집 기능과 함께 사용 시 동작 확인

### 7단계: 윗입술/아래입술 개별 적용 기능 추가
- [x] `gui/face_edit/__init__.py`에 윗입술/아래입술 변수 추가
  - `upper_lip_size`: 윗입술 크기 (0.5 ~ 2.0, 기본값: 1.0)
  - `upper_lip_width`: 윗입술 너비 (0.5 ~ 2.0, 기본값: 1.0)
  - `lower_lip_size`: 아래입술 크기 (0.5 ~ 2.0, 기본값: 1.0)
  - `lower_lip_width`: 아래입술 너비 (0.5 ~ 2.0, 기본값: 1.0)
  - `use_individual_lip_region`: 입술 개별 적용 여부 (Boolean, 기본값: False)
- [x] `gui/face_edit/morphing.py`의 `_create_mouth_tab()` 함수 수정
  - 개별 적용 체크박스 추가 (눈 편집과 동일한 패턴)
  - 윗입술 크기/너비 슬라이더 추가
  - 아래입술 크기/너비 슬라이더 추가
  - 개별 적용 모드에 따라 슬라이더 표시/숨김 처리
  - `on_individual_lip_region_change()` 함수 추가
- [x] `utils/face_morphing.py`에 윗입술/아래입술 편집 함수 추가
  - `adjust_upper_lip_size()` 함수 구현 (입 중심점 위쪽 영역 편집)
  - `adjust_lower_lip_size()` 함수 구현 (입 중심점 아래쪽 영역 편집)
  - 랜드마크 기반으로 윗입술/아래입술 영역 각각 계산
- [x] `utils/face_morphing.py`의 `apply_all_adjustments()` 함수 수정
  - 윗입술/아래입술 파라미터 추가
  - `use_individual_lip_region` 파라미터 추가
  - 개별 적용 여부에 따라 함수 호출 분기
- [x] `gui/face_edit/morphing.py`의 `apply_editing()` 함수 수정
  - 개별 적용 모드에 따라 파라미터 전달 분기 처리
  - `reset_morphing()` 함수에 윗입술/아래입술 변수 초기화 추가
  - `on_morphing_change()` 함수에 윗입술/아래입술 라벨 업데이트 추가

## 기술 사항
- Python 패키지 구조 유지
- 기존 눈/코 편집과 동일한 패턴 적용
- 랜드마크 기반 입 영역 계산
- 부드러운 블렌딩을 위한 가우시안 블러 마스크 사용
- MediaPipe Face Mesh 랜드마크 사용 (입 영역 인덱스 확인 필요)

## 구현 세부사항

### 입 영역 랜드마크
- MediaPipe Face Mesh의 입 관련 인덱스 사용
- 입 중심점: `key_landmarks['mouth']`
- 입 영역 계산: 입 중심점 기준으로 영역 계산

### 입 크기 조정
- 범위: 0.5 ~ 2.0 (기본값: 1.0)
- 입 영역을 리사이즈하여 크기 조정
- 부드러운 블렌딩 적용

### 입 너비 조정
- 범위: 0.5 ~ 2.0 (기본값: 1.0)
- 입 영역의 너비만 조정 (높이는 유지)
- 비율에 따라 리사이즈

## 주의 사항
- 기존 코드 패턴과 일관성 유지
- 린터 오류 확인 필수
- 랜드마크가 감지되지 않을 경우 원본 이미지 반환
- Exception 발생 시 로그 출력 (pass 금지)
- 테스트 완료 전까지 기존 기능에 영향 없도록 주의

## 작업 완료 상태
- ✅ 모든 단계 완료
- ✅ 테스트 완료 (사용자 확인)
- ✅ 윗입술/아래입술 개별 적용 기능 정상 동작 확인

## 추가 개선 사항 (2026-01-13)

### 이미지 위치 관리 개선
- ✅ "원래대로" 버튼 클릭 시 이미지가 캔버스 안으로 들어오도록 수정
  - `zoom_reset_original()` 함수에서 캔버스 크기 수정 (480x600)
  - `show_original_preview()`, `show_edited_preview()` 함수에 경계 제한 로직 추가
  - `is_resetting_position` 플래그를 사용하여 "원래대로" 버튼 클릭 시에만 경계 제한 적용
- ✅ 슬라이더 조정 시 편집된 이미지 위치 유지
  - `on_morphing_change()` 함수에서 `apply_editing()` 호출 전에 현재 위치 명시적으로 저장
  - `show_edited_preview()` 함수에서 이미 설정된 위치를 덮어쓰지 않도록 수정
  - 원본 이미지와 편집된 이미지 위치 동기화 개선
- ✅ 마우스 휠 확대/축소 시 마우스 위치를 중심으로 동작하도록 수정
  - 마우스 휠 핸들러에서 계산된 위치를 명시적으로 저장
  - `show_original_preview()` 함수에서 이미 설정된 위치를 덮어쓰지 않도록 수정
  - 편집된 이미지 위치도 동기화
- ✅ 원본 이미지와 편집된 이미지 드래그 시 양방향 동기화
  - 원본 이미지 드래그 시 편집된 이미지도 함께 이동
  - 편집된 이미지 드래그 시 원본 이미지도 함께 이동
