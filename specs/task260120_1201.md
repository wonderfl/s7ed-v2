# 로거 시스템 중복 출력 문제 해결 및 개선

**작성 일시**: 2026-01-20 12:01  
**최종 업데이트**: 2026-01-20  
**작업 목적**: 로거 시스템의 중복 출력 문제 해결 및 파일 로그 기록 기능 개선, 함수 이름 개선

## 문제 분석

### 현재 문제점

1. **중복 출력 문제**
   - `print_info()` 등 호출 시 콘솔에 로그가 2번 출력됨
   - `print_colored()`에서 직접 출력 + 로거의 콘솔 핸들러에서 출력

2. **파일 로그 기록 문제**
   - `log_*()` 함수에서 파일 핸들러에 직접 기록하려고 시도
   - `makeRecord()` 사용 시 포맷터가 제대로 적용되지 않을 수 있음
   - 파일 핸들러가 없을 때 기록되지 않음

3. **로거 구조 복잡성**
   - 콘솔 핸들러와 파일 핸들러를 분리하려는 시도가 복잡함
   - 임시 제거/추가 방식이 불안정함

## 해결 방안

### 목표
- 콘솔에는 색상 메시지가 한 번만 출력
- 파일 로그에도 정상적으로 기록 (파일 로그 활성화 시)
- 간단하고 안정적인 구조

### 현재 구조 분석
- `log_*()` 함수는 `print_*()` 내부에서만 호출됨 (외부 사용 없음)
- 분리할 필요 없음 → 하나의 함수로 통합 가능

### 해결 방법

**방법 1: 함수 통합 (추천)**
- `print_info()` 등에서 콘솔 출력 + 파일 기록 모두 처리
- `log_*()` 함수 제거 또는 내부 헬퍼 함수로 변경
- 콘솔 핸들러 비활성화 후 파일 핸들러만 사용하여 기록
- 장점: 구조 단순화, 중복 제거
- 단점: 없음

**방법 2: 별도 파일 로거 사용**
- 파일 로그용 별도 로거 생성
- 콘솔 출력과 파일 기록을 완전 분리
- 장점: 깔끔한 분리
- 단점: 로거 관리가 복잡해짐

**방법 3: Filter 사용**
- 콘솔 핸들러에 Filter 추가하여 특정 로그만 출력
- 장점: 로거 구조 변경 최소화
- 단점: Filter 로직이 필요

## 작업 계획

### 1단계: 현재 구조 분석
- [x] 로거 핸들러 구조 확인
- [x] 중복 출력 발생 지점 확인
- [x] 파일 로그 기록 동작 확인

### 2단계: 로그 형식 설정 추가
- [x] `_logging_config`에 `log_format`, `date_format` 추가
- [x] `_get_log_format()`, `_get_date_format()` 함수에서 `_logging_config` 값 사용
- [x] `config.load_logging_config()`에서 `log_format`, `date_format` 읽기
- [x] `config.save_logging_config()`에서 `log_format`, `date_format` 저장
- [x] `configure_logging()` 함수에 `log_format`, `date_format` 파라미터 추가

### 3단계: 해결 방법 선택 및 구현
- [x] 방법 1, 2, 3 중 선택 (방법 1 선택)
- [x] 선택한 방법으로 구현
- [x] 테스트 및 검증

### 4단계: 테스트
- [x] 콘솔 출력이 한 번만 되는지 확인
- [x] 파일 로그가 정상 기록되는지 확인
- [x] 로그 형식이 설정 파일에서 읽혀지는지 확인
- [x] 모든 로그 레벨 테스트

## 구현 방법 (방법 1 기준)

### 수정할 함수들

1. **출력 함수 이름 변경**
   - `print_error()` → `error()` (별칭: `err()`)
   - `print_warning()` → `warning()` (별칭: `warn()`)
   - `print_info()` → `info()`
   - `print_debug()` → `debug()` (별칭: `dbg()`)
   - `print_colored()` → `log_output()` (콘솔 출력만)
   - `print_log()` → `log_file()` (파일 기록만)

2. **`error()`, `warning()`, `info()`, `debug()` 함수**
   - `log_output()` 호출 (콘솔 출력)
   - 파일 로그 활성화 여부 확인 (`_logging_config['file_enabled']`)
   - 파일 로그가 활성화된 경우에만 `log_error()`, `log_warning()`, `log_info()`, `log_debug()` 호출

3. **`log_*()` 함수들**
   - 내부 헬퍼 함수로 유지 (외부 사용 없음)

### 설정 파일 연동

1. **별도 로그 설정 파일 사용**
   - 로그 설정을 `logging.json` 파일로 분리
   - `config.json`의 `logging` 섹션은 하위 호환성을 위해 지원 (자동 마이그레이션)
   - `config.load_logging_config()`에서 먼저 `logging.json` 확인, 없으면 `config.json`의 `logging` 섹션 확인
   - `config.save_logging_config()`에서 `logging.json`에 저장하고, `config.json`에서 `logging` 섹션 제거

2. **파일 로그 기록 여부**
   - `log_level` 설정으로 파일 로그 활성화 여부 제어
   - `log_level`이 유효한 레벨 값이면 파일 로그 활성화, 없거나 `null`, 빈 문자열, `"None"`이면 비활성화
   - `config.load_logging_config()`에서 `log_level` 값으로 `file_enabled` 결정
   - 기본값: `file_enabled = False` (파일 로그 비활성화)
   - `error()`, `warning()`, `info()`, `debug()` 등에서 `_logging_config['file_enabled']` 확인 후 파일 로그 기록 여부 결정

3. **로그 파일 형식 지정**
   - `_logging_config['log_format']` 추가 (기본값: `'%(asctime)s [%(levelname)s] [%(name)s] %(message)s'`)
   - `_logging_config['date_format']` 추가 (기본값: `'%Y-%m-%d %H:%M:%S'`)
   - `config.load_logging_config()`에서 설정 파일의 `log_format`, `date_format` 값을 읽어서 `_logging_config`에 반영
   - `_get_log_format()`, `_get_date_format()` 함수에서 `_logging_config` 값 사용
   - 설정 파일에 없으면 기본값 사용
   - `configure_logging()` 함수에 `log_format`, `date_format` 파라미터 추가
   - `config.save_logging_config()`에서 `log_format`, `date_format` 저장

4. **출력 레벨 설정**
   - `_logging_config['output_level']` 추가 (기본값: `INFO`)
   - 하위 호환성을 위해 `level`도 유지 (내부적으로 `output_level`과 동일하게 처리)
   - 설정 파일에서 `output_level` 또는 `level`로 설정 가능
   - `config.load_logging_config()`에서 설정 파일의 `output_level` 또는 `level` 값을 읽어서 `_logging_config`에 반영
   - `_setup_handlers()`에서 출력 핸들러의 레벨을 `output_level`로 설정
   - `configure_logging()` 함수에 `output_level` 파라미터 추가
   - `config.save_logging_config()`에서 `output_level` 저장

5. **파일 로그 레벨 설정**
   - `_logging_config['log_level']` 추가 (기본값: `output_level`과 동일)
   - 출력 레벨과 파일 저장 레벨을 독립적으로 설정 가능
   - 예: 출력은 INFO 이상, 파일은 WARNING 이상만 저장
   - `config.load_logging_config()`에서 설정 파일의 `log_level` 또는 `file_level` 값을 읽어서 `_logging_config`에 반영 (하위 호환성)
   - `_setup_handlers()`에서 파일 핸들러의 레벨을 `log_level`로 설정
   - `configure_logging()` 함수에 `log_level` 파라미터 추가
   - `config.save_logging_config()`에서 `log_level` 저장

6. **레벨별 색상 설정**
   - `_logging_config['colors']` 추가 (레벨별 색상 딕셔너리)
   - 기본값: DEBUG=CYAN, INFO=GREEN+BRIGHT, WARNING=YELLOW, ERROR=RED+BRIGHT, CRITICAL=MAGENTA+BRIGHT
   - 색상 형식: "COLOR" 또는 "COLOR+STYLE" (예: "GREEN+BRIGHT", "CYAN")
   - 지원 색상: BLACK, RED, GREEN, YELLOW, BLUE, MAGENTA, CYAN, WHITE
   - 지원 스타일: DIM, NORMAL, BRIGHT
   - `_parse_color_string()` 함수로 색상 문자열을 colorama 코드로 변환
   - `_get_color_for_level()` 함수에서 설정 파일의 색상 사용
   - `config.load_logging_config()`에서 설정 파일의 `colors` 값을 읽어서 `_logging_config`에 반영
   - `configure_logging()` 함수에 `colors` 파라미터 추가
   - `config.save_logging_config()`에서 `colors` 저장

7. **로그 파일 로테이션 설정**
   - `_logging_config['rotation_type']` 추가 ('size' 또는 'date', 기본값: 'size')
   - `rotation_type='size'`: 파일 크기 기반 로테이션 (`RotatingFileHandler` 사용)
     - `max_bytes`: 최대 파일 크기 (기본값: 10MB)
     - `backup_count`: 백업 파일 개수 (기본값: 5)
   - `rotation_type='date'`: 날짜별 로테이션 (`TimedRotatingFileHandler` 사용)
     - `rotation_when`: 로테이션 시점 ('S', 'M', 'H', 'D', 'W0'-'W6', 'midnight', 기본값: 'midnight')
     - `rotation_interval`: 로테이션 간격 (기본값: 1)
     - `backup_count`: 백업 파일 개수 (기본값: 5)
     - `filename_date`: 날짜별 파일명 패턴 (예: '%Y-%m-%d', None이면 TimedRotatingFileHandler 기본 형식 사용)
       - 예: `logs/s7ed.log` + `filename_date='%Y-%m-%d'` → `logs/s7ed_2026-01-20.log`
       - Python datetime 형식 사용 (`%Y`, `%m`, `%d`, `%H`, `%M`, `%S` 등)
     - `filename_prefix`: 파일명 접두사 (예: 'app_', None이면 기본 파일명 사용)
       - 예: `logs/s7ed.log` + `filename_prefix='app_'` → `logs/app_s7ed.log`
       - 예: `logs/s7ed.log` + `filename_prefix='app_'` + `filename_date='%Y-%m-%d'` → `logs/app_s7ed_2026-01-20.log`
   - `_setup_handlers()`에서 `rotation_type`에 따라 적절한 핸들러 선택
   - `rotation_type='date'`이고 `filename_date`가 지정된 경우, 파일명에 날짜 포함
   - `config.load_logging_config()`에서 설정 파일의 로테이션 관련 값 읽기
   - `configure_logging()` 함수에 로테이션 관련 파라미터 추가
   - `config.save_logging_config()`에서 로테이션 관련 설정 저장

8. **파일 로그 활성화 제어 방식 변경**
   - `file_enabled` 플래그 제거
   - `log_level` 설정으로 파일 로그 활성화 여부 제어
   - `log_level`이 유효한 레벨 값(`DEBUG`, `INFO`, `WARNING`, `ERROR`, `CRITICAL`)이면 파일 로그 활성화
   - `log_level`이 없거나 `null`, 빈 문자열(`""`), `"None"` (대소문자 구분 없음), 공백만 있으면 파일 로그 비활성화
   - `config.load_logging_config()`에서 `log_level` 값으로 `file_enabled` 결정
   - JSON 파싱 에러 시에도 기본값(파일 로그 비활성화) 사용

9. **함수 이름 변경 및 별칭 추가**
   - 출력 함수 이름 변경:
     - `print_error()` → `error()` (별칭: `err()`)
     - `print_warning()` → `warning()` (별칭: `warn()`)
     - `print_info()` → `info()`
     - `print_debug()` → `debug()` (별칭: `dbg()`)
     - `print_colored()` → `log_output()` (콘솔 출력만, 파일 기록 없음)
     - `print_log()` → `log_file()` (파일 기록만, 콘솔 출력 없음)
   - 하위 호환성을 위해 기존 `print_*` 함수명도 별칭으로 유지
   - `colored = log_output`, `log = log_file` 별칭 추가

## 주의사항

1. **성능**: 핸들러 제거/추가는 성능에 영향이 있을 수 있음
2. **스레드 안전성**: 멀티스레드 환경에서 핸들러 조작 시 주의 필요
3. **예외 처리**: 핸들러 조작 중 예외 발생 시 복구 필요

## 완료 조건

- [x] 콘솔에 로그가 한 번만 출력됨
- [x] 파일 로그가 정상적으로 기록됨 (파일 로그 활성화 시)
- [x] 모든 로그 레벨에서 정상 동작 확인
- [x] 기존 코드와 호환성 유지
- [x] 함수 이름 개선 (`print_*` → 짧은 이름, 별칭 지원)
- [x] `file_enabled` 플래그 제거, `log_level`로 파일 로그 제어
- [x] `filename_date`, `filename_prefix` 변수명 변경
- [x] JSON 파싱 에러 시 안전한 처리
- [x] 문서 업데이트 (`logging_config_guide.md`, `README.md`, `logging.json.example`)

## 주요 변경 사항 요약

### 설정 파일 변경
- `file_name_pattern` → `filename_date`
- `file_name_prefix` → `filename_prefix`
- `file_enabled` 플래그 제거 → `log_level` 설정으로 파일 로그 활성화 제어

### 함수 이름 변경
- `print_error()` → `error()` (별칭: `err()`)
- `print_warning()` → `warning()` (별칭: `warn()`)
- `print_info()` → `info()`
- `print_debug()` → `debug()` (별칭: `dbg()`)
- `print_colored()` → `log_output()` (콘솔 출력만)
- `print_log()` → `log_file()` (파일 기록만)

### 파일 로그 활성화 제어
- `log_level`이 유효한 레벨 값이면 파일 로그 활성화
- `log_level`이 없거나 `null`, 빈 문자열(`""`), `"None"` (대소문자 구분 없음), 공백만 있으면 파일 로그 비활성화
