# 사이즈 확대 시 블렌딩 대신 오버라이트 적용

**작성 일시**: 2026-01-20 01:51  
**작업 목적**: 사이즈를 확대할 때 블렌딩이 아니라 오버라이트가 되도록 수정하여 겹쳐 보이는 문제 해결

## 문제 분석

### 현재 문제점

**문제**: 사이즈를 확대하면 블렌딩이 아니라서 매핑이 오버라이트 돼야 하는데, 변경/교체 시 겹쳐 보임

**현재 동작**:
- 모든 크기 조정 함수에서 확대/축소 관계없이 항상 블렌딩 사용
- 확대 시 (ratio > 1.0): 원본 영역과 새 영역이 겹쳐서 블렌딩되어 겹쳐 보임
- 축소 시 (ratio < 1.0): 블렌딩이 적절함

**영향**:
- 확대 시 원본 영역이 남아있어 겹쳐 보임
- 변경/교체 시 시각적으로 혼란

## 작업 계획

### 수정 원칙

1. **확대/축소 모두**: 블렌딩 비율 선택 가능
   - 블렌딩 비율 파라미터 추가 (기본값: 1.0 = 완전 블렌딩, 0.0 = 완전 오버라이트)
   - 사용자가 블렌딩 강도를 선택할 수 있도록
   - 완전 오버라이트(blend_ratio=0.0)일 때는 새 영역으로 완전히 덮어쓰기
   - 블렌딩(blend_ratio>0.0)일 때는 원본과 새 영역을 블렌딩
   - 원본 영역 제거 불필요: 덮어쓰기만으로 충분함

### 수정 대상 파일

1. **`utils/face_morphing/adjustments/region_adjustments.py`**
   - 함수: `adjust_region_size`
   - 추가 파라미터: `blend_ratio` (기본값: 1.0, 0.0~1.0)
   - 블렌딩 비율에 따라 새 영역을 덮어쓰기 (확대/축소 모두)

2. **`utils/face_morphing/adjustments/face_adjustments.py`**
   - 함수: `adjust_face_size`
   - 추가 파라미터: `blend_ratio` (기본값: 1.0, 0.0~1.0)
   - 블렌딩 비율에 따라 새 영역을 덮어쓰기 (확대/축소 모두)

3. **`utils/face_morphing/adjustments/eye_adjustments.py`**
   - 함수: `adjust_eye_size`
   - 추가 파라미터: `blend_ratio` (기본값: 1.0, 0.0~1.0)
   - 블렌딩 비율에 따라 새 영역을 덮어쓰기 (확대/축소 모두)

4. **`utils/face_morphing/adjustments/nose_adjustments.py`**
   - 함수: `adjust_nose_size`
   - 추가 파라미터: `blend_ratio` (기본값: 1.0, 0.0~1.0)
   - 블렌딩 비율에 따라 새 영역을 덮어쓰기 (확대/축소 모두)

5. **`utils/face_morphing/adjustments/mouth_adjustments.py`**
   - 함수: `adjust_mouth_size`, `adjust_upper_lip_size`, `adjust_lower_lip_size` 등
   - 추가 파라미터: `blend_ratio` (기본값: 1.0, 0.0~1.0)
   - 블렌딩 비율에 따라 새 영역을 덮어쓰기 (확대/축소 모두)

## 구현 방법

### 블렌딩 비율 적용 로직 (확대/축소 모두)

```python
# 블렌딩 비율 (기본값: 1.0 = 완전 블렌딩, 0.0 = 완전 오버라이트)
blend_ratio = max(0.0, min(1.0, blend_ratio))  # 0.0~1.0 범위로 제한

# 원본 이미지 복사
result = img_array.copy()

# 새로운 위치에 블렌딩 적용 (블렌딩 비율 적용)
region_area = result[new_y1:new_y2, new_x1:new_x2]
mask = _create_blend_mask(actual_width, actual_height, mask_type='ellipse')
mask_adjusted = mask * blend_ratio  # 블렌딩 비율 적용

if region_area.shape[:2] == region_final.shape[:2]:
    for c in range(3):
        # blend_ratio=0.0: 완전 오버라이트 (새 영역만)
        # blend_ratio=1.0: 완전 블렌딩 (원본과 새 영역 블렌딩)
        region_area[:, :, c] = (region_area[:, :, c] * (1 - mask_adjusted) + 
                               region_final[:, :, c] * mask_adjusted).astype(np.uint8)
```

**참고**: 원본 영역 제거 불필요
- 완전 오버라이트(blend_ratio=0.0): 새 영역으로 완전히 덮어쓰면 원본은 자연스럽게 사라짐
- 블렌딩(blend_ratio>0.0): 원본과 새 영역이 블렌딩되므로 원본 제거 불필요

## 작업 단계

- [x] 1. 각 크기 조정 함수에 `blend_ratio` 파라미터 추가 (기본값: 1.0) ✅
- [x] 2. `region_adjustments.py`의 `adjust_region_size` 함수 수정 ✅
  - 블렌딩 비율 적용 (덮어쓰기만으로 충분)
- [x] 3. `face_adjustments.py`의 `adjust_face_size` 함수 수정 ✅
  - 블렌딩 비율 적용 (덮어쓰기만으로 충분)
- [x] 4. `eye_adjustments.py`의 `adjust_eye_size` 함수 수정 ✅
  - 블렌딩 비율 적용 (덮어쓰기만으로 충분)
- [x] 5. `nose_adjustments.py`의 `adjust_nose_size` 함수 수정 ✅
  - 블렌딩 비율 적용 (덮어쓰기만으로 충분)
- [x] 6. `mouth_adjustments.py`의 크기 조정 함수들 수정 ✅
  - [x] `adjust_mouth_size` - 블렌딩 비율 적용 (덮어쓰기만으로 충분) ✅
  - [x] `adjust_upper_lip_size` - 블렌딩 비율 적용 (덮어쓰기만으로 충분) ✅
  - [x] `adjust_lower_lip_size` - 블렌딩 비율 적용 (덮어쓰기만으로 충분) ✅
- [x] 7. GUI에 블렌딩 비율 슬라이더 추가 ✅
  - [x] `__init__.py`에 `blend_ratio` 변수 추가 (기본값: 1.0) ✅
  - [x] 전체 탭에 블렌딩 비율 슬라이더 추가 (0.0~1.0 범위) ✅
  - [x] 슬라이더 변경 시 `blend_ratio` 값 업데이트 ✅
- [x] 8. 호출하는 쪽에서 `blend_ratio` 파라미터 전달 가능하도록 수정 ✅
  - [x] `morphing/logic.py`의 `_apply_common_sliders`에서 `blend_ratio` 전달 ✅
  - [x] `morphing/editing_steps.py`의 `_prepare_editing_parameters`에서 `blend_ratio` 전달 ✅
  - [x] `utils/face_morphing/integration.py`의 `apply_all_adjustments`에서 `blend_ratio` 전달 ✅
  - [x] 모든 크기 조정 함수 호출 시 `blend_ratio` 파라미터 추가 ✅
  - [x] `reset_morphing` 함수에 `blend_ratio` 초기화 추가 ✅
- [x] 9. 테스트 및 검증 (확대 시 겹침 없음 확인, 블렌딩 비율 조절 확인) ✅
- [x] 10. 폴리곤 매핑에서도 블렌딩 비율 통일 및 완전 덮어쓰기 지원 ✅
  - [x] `polygon_morphing/core.py`의 `morph_face_by_polygons` 함수에 블렌딩 비율 로직 통일 ✅
  - [x] `blend_ratio = 1.0`일 때 변형된 픽셀 영역에서 원본 제거하여 완전 덮어쓰기 구현 ✅
  - [x] 변형된 픽셀 위치 추적 마스크 추가 ✅

### 추가 작업: 초기화 시 original_iris_landmarks 유지 버그 수정 (2026-01-20)

초기화 버튼을 누를 때 `original_iris_landmarks`가 사라지는 문제를 수정했습니다.

#### 발견된 문제
1. 초기화 후 눈동자가 안 보임
2. 초기화 전에 `original_iris_landmarks`가 있었는데 초기화 후에 `None`이 됨
3. 다른 이미지를 선택하고 다시 원래 이미지를 선택하면 잘 나오는데, 초기화하면 안 나옴

#### 원인 분석
1. `reset(keep_original=True)`는 `_original_iris_landmarks`를 건드리지 않음 (정상)
2. 하지만 초기화 후 재감지 로직에서 `set_original_landmarks`를 호출하면서 468개 랜드마크를 받으면 `_original_iris_landmarks = None`으로 설정됨
3. 이미지 로딩 시 설정된 `original_iris_landmarks`가 덮어씌워짐

#### 수정 내용

**1. `set_original_landmarks`에서 468개 받을 때 기존 값 유지**
- **파일**: `gui/face_edit/landmark_manager.py`
- **문제**: 468개 랜드마크를 받으면 무조건 `_original_iris_landmarks = None`으로 설정
- **수정**: 
  - [x] 468개를 받았을 때 기존 `original_iris_landmarks`가 있으면 유지하도록 수정 (128-131줄)
  - [x] 기타 경우에도 기존 값을 유지하도록 수정 (135-137줄)

**2. 초기화 후 재감지 로직 제거**
- **파일**: `gui/face_edit/morphing/logic.py`
- **문제**: 초기화 후 `original_iris_landmarks`가 없으면 재감지하는 로직이 있음
- **수정**: 
  - [x] 초기화 후 재감지 로직 제거 (1004-1017줄)
  - [x] 이미지 로딩 시 설정된 `original_iris_landmarks`가 `reset(keep_original=True)`로 유지되므로 재감지 불필요

**3. 디버깅 로그 추가**
- **파일**: `gui/face_edit/morphing/logic.py`
- **수정**: 
  - [x] 초기화 전/후 `original_iris_landmarks` 상태 확인 로그 추가 (984-995줄)

#### 수정된 파일
1. `gui/face_edit/landmark_manager.py`
   - `set_original_landmarks`: 468개를 받았을 때 기존 `original_iris_landmarks` 유지
   - 기타 경우에도 기존 값 유지

2. `gui/face_edit/morphing/logic.py`
   - `reset_morphing`: 초기화 후 재감지 로직 제거
   - 디버깅 로그 추가

#### 테스트 결과
- [x] 초기화 후 `original_iris_landmarks` 유지 확인
- [x] 초기화 후 눈동자 표시 정상 동작 확인
- [x] 이미지 로딩 시 설정된 값이 초기화 후에도 유지됨 확인

## 주의사항

1. **기존 동작 유지**: 블렌딩은 기본값 1.0으로 기존대로 유지
2. **원본 영역 제거 불필요**: 덮어쓰기만으로 충분함
   - 완전 오버라이트(blend_ratio=0.0): 새 영역으로 완전히 덮어쓰면 원본은 자연스럽게 사라짐
   - 블렌딩(blend_ratio>0.0): 원본과 새 영역이 블렌딩되므로 원본 제거 불필요
3. **경계 처리**: 이미지 경계를 넘어가는 경우 적절히 처리
4. **일관성**: 모든 크기 조정 함수에서 동일한 로직 적용 (확대/축소 모두)

## 완료 조건

- [x] 블렌딩 비율 파라미터 추가 확인 (기본값: 1.0) ✅
- [x] GUI에 블렌딩 비율 슬라이더 추가 확인 ✅
- [x] 블렌딩 비율 슬라이더로 조정 가능 확인 (0.0~1.0) ✅
- [x] 블렌딩 비율 0.0일 때 완전 오버라이트 확인 (덮어쓰기만으로 충분) ✅
- [x] 블렌딩 비율 1.0일 때 완전 블렌딩 확인 ✅
- [x] 확대 시 겹쳐 보이는 문제 해결 확인 (blend_ratio=1.0으로 완전 덮어쓰기) ✅
- [x] 축소 시 겹쳐 보이는 문제 해결 확인 ✅
- [x] 모든 크기 조정 함수에서 일관된 동작 확인 ✅
- [x] 폴리곤 매핑에서도 블렌딩 비율 통일 및 완전 덮어쓰기 지원 확인 ✅
- [x] 초기화 시 original_iris_landmarks 유지 확인 완료 ✅
