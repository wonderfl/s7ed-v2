# 작업계획서: 폴리곤 수정 성능 추가 최적화

## 작업 목표
폴리곤 수정 시 적용 시간을 더 단축하기 위해 UI 업데이트 최적화, 이미지 리사이즈 캐싱, 조기 종료 최적화를 수행합니다.

## 문제 분석
1. **UI 업데이트**: `show_edited_preview()`와 `update_face_features_display()`가 항상 호출되어 불필요한 처리 발생
2. **이미지 리사이즈**: 동일한 크기로 매번 리사이즈하여 시간 낭비
3. **삼각형 처리**: 모든 삼각형을 처리하지만 선택한 포인트 주변만 처리해도 충분

## 작업 계획

### 1. UI 업데이트 최적화
- **위치**: `gui/face_edit/polygon_drag_handler.py` 255-259줄
- **현재 문제**:
  - `show_edited_preview()`: 이미지가 변경되지 않아도 항상 호출
  - `update_face_features_display()`: 랜드마크 표시가 비활성화되어 있어도 체크만 하고 호출 안 함 (이미 최적화됨)
- **개선 방안**:
  - `show_edited_preview()`: 이전 이미지와 비교하여 변경되었을 때만 호출
  - 또는 이미지 해시를 사용하여 변경 감지
- **예상 효과**: 약 20-40% 성능 향상 (UI 업데이트 시간 단축)

### 2. 이미지 리사이즈 캐싱
- **위치**: `gui/face_edit/preview.py` 364-369줄
- **현재 문제**: 
  - 매번 이미지 리사이즈 수행
  - 동일한 크기 요청 시에도 재계산
- **개선 방안**:
  - 리사이즈 결과 캐싱
  - 해시 키: (이미지 id, display_width, display_height)
  - 캐시 크기 제한 (LRU 방식)
- **예상 효과**: 약 10-20% 성능 향상 (UI 반응성 향상)

### 3. 조기 종료 최적화 (롤백됨)
- **위치**: `utils/face_morphing.py` 2735줄 이후 (삼각형 처리 루프)
- **문제**: 
  - 선택한 포인트 주변만 처리하면 다른 영역의 픽셀이 매핑되지 않음
  - 이미지 변형은 전체 이미지의 모든 픽셀을 처리해야 함
- **결과**: 롤백 - 전체 삼각형 처리로 복원
- **대안**: 다른 방식의 최적화 필요 (예: 변경된 랜드마크 주변만 우선 처리하되 전체는 처리)

## 작업 단계
- [x] 1. UI 업데이트 최적화
  - [x] 1-1. 이미지 변경 감지 로직 추가 (이전 이미지와 비교)
  - [x] 1-2. `show_edited_preview()` 조건부 호출 구현
  - [ ] 1-3. 테스트 및 검증
- [x] 2. 이미지 리사이즈 캐싱
  - [x] 2-1. 리사이즈 캐시 딕셔너리 추가
  - [x] 2-2. 해시 키 생성 로직 구현
  - [x] 2-3. LRU 캐시 구현 (캐시 크기 제한)
  - [x] 2-4. `show_edited_preview()`와 `show_original_preview()`에 캐싱 적용
  - [ ] 2-5. 테스트 및 검증
- [x] 3. 조기 종료 최적화
  - [x] 3-1. 삼각형-포인트 연결 관계 미리 계산
  - [x] 3-2. 선택한 포인트 주변 삼각형 필터링 로직 구현
  - [x] 3-3. 삼각형 처리 루프에 필터링 적용
  - [x] 3-4. 롤백: 전체 이미지 매핑을 위해 모든 삼각형 처리 필요 (이미지 매핑 문제 발생)

## 작업 완료 내역
- 2026-01-16 14:26: 이미지 변경 감지 변수 추가 (`_last_edited_image_hash`)
- 2026-01-16 14:26: 리사이즈 캐시 변수 추가 (`_resize_cache`, `_resize_cache_max_size`)
- 2026-01-16 14:26: UI 업데이트 최적화 구현 (이미지 해시 비교)
- 2026-01-16 14:26: 이미지 리사이즈 캐싱 구현 (`show_edited_preview()`, `show_original_preview()`)
- 2026-01-16 14:26: 조기 종료 최적화 구현 (선택한 포인트 주변 삼각형만 처리)
- 2026-01-16 14:30: 조기 종료 최적화 롤백 (이미지 매핑 문제 발생 - 전체 삼각형 처리 필요)

## 예상 효과
- **전체 성능**: 약 50-130% 추가 성능 향상
- **UI 반응성**: 이미지 리사이즈 캐싱으로 즉각적인 반응
- **처리 시간**: 조기 종료로 변경 범위가 작을 때 대폭 단축

## 주의사항
- 이미지 변경 감지 시 메모리 사용 고려
- 리사이즈 캐시 크기 제한 필요 (메모리 관리)
- 조기 종료 시 품질 저하 없이 처리 범위만 축소
- 기존 기능 동작 보장

## 구현 세부사항

### 1. UI 업데이트 최적화
```python
# 이전 이미지 해시 저장
self._last_edited_image_hash = None

# 이미지 변경 감지
current_hash = hash(self.edited_image.tobytes())
if current_hash != self._last_edited_image_hash:
    self.show_edited_preview()
    self._last_edited_image_hash = current_hash
```

### 2. 이미지 리사이즈 캐싱
```python
# 클래스 변수로 캐시 추가
self._resize_cache = {}
self._resize_cache_max_size = 10

# 해시 키 생성
cache_key = (id(self.edited_image), display_width, display_height)
if cache_key in self._resize_cache:
    resized = self._resize_cache[cache_key]
else:
    resized = self.edited_image.resize(...)
    # LRU 캐시 관리
    if len(self._resize_cache) >= self._resize_cache_max_size:
        # 가장 오래된 항목 제거
        oldest_key = next(iter(self._resize_cache))
        del self._resize_cache[oldest_key]
    self._resize_cache[cache_key] = resized
```

### 3. 조기 종료 최적화
```python
# 선택한 포인트 주변 삼각형만 필터링
if selected_point_indices is not None:
    # 삼각형-포인트 연결 관계 미리 계산
    point_to_triangles = {}
    for simplex_idx, simplex in enumerate(tri.simplices):
        for point_idx in simplex:
            if point_idx not in point_to_triangles:
                point_to_triangles[point_idx] = []
            point_to_triangles[point_idx].append(simplex_idx)
    
    # 선택한 포인트 주변 삼각형만 수집
    relevant_simplices = set()
    for selected_idx in selected_point_indices:
        if selected_idx in point_to_triangles:
            relevant_simplices.update(point_to_triangles[selected_idx])
    
    # 필터링된 삼각형만 처리
    simplices_to_process = list(relevant_simplices) if relevant_simplices else range(len(tri.simplices))
else:
    simplices_to_process = range(len(tri.simplices))

for simplex_idx in simplices_to_process:
    simplex = tri.simplices[simplex_idx]
    # ... 기존 처리 로직 ...
```
