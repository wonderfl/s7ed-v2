# 작업 계획서: 각 부위별 크기 조절 및 위치 이동 기능 추가

**작업 일시**: 2026-01-17 20:38  
**작업 목표**: 전체 탭에서 선택된 부위별로 크기 조절과 위치 이동을 위한 슬라이더 추가 (각 부위의 중심점을 기준으로 개별 조절)

## 요약
- **총 부위 개수**: 12개 (개별 부위 11개 + Tesselation 1개)
  - 개별 부위: face_oval, left_eye, right_eye, left_eyebrow, right_eyebrow, nose, **upper_lips**, **lower_lips**, left_iris, right_iris, contours
  - Tesselation: 전체 메시 조절용
- **슬라이더 개수**: 고정 5개 (선택된 모든 부위에 공통 적용)
  - Center Offset X/Y, Size, Position X/Y
  - 선택된 부위 개수와 무관하게 항상 최대 5개
  - 각 부위의 중심점을 기준으로 개별 적용
- **입술 분리**: lips를 upper_lips와 lower_lips로 분리 (인덱스 기반 구분, 고개를 틀어도 안정적)

## 작업 배경
- 현재 전체 탭에는 부위 선택 체크박스만 있음
- 각 부위별로 크기를 조절하거나 위치를 이동할 수 있는 기능이 없음
- 여러 부위가 선택되었을 때 각 부위의 중심점을 기준으로 개별 조절이 필요함
- 입술을 위/아래로 분리하여 각각 독립적으로 조절할 수 있도록 요청됨
  - 인덱스 기반 구분으로 고개를 틀어도 안정적으로 동작

## 작업 범위

### 1. Tesselation 별도 모드 처리
- Tesselation 선택 시 다른 부위 선택 불가 (상호 배타적)
- 개별 부위 선택 시 Tesselation 선택 불가
- Tesselation은 "전체 조절" 모드로 처리

### 2. 각 부위별 중심점 계산 함수 추가
- 모든 부위(11개, Tesselation 제외)에 대한 중심점 계산 함수 추가
- `utils/face_morphing/region_extraction.py`에 함수 추가
- 부위별 MediaPipe 연결 정보를 사용하여 중심점 계산
- **중심점 오프셋 지원**: 중심점 자체를 이동시킬 수 있도록 오프셋 파라미터 추가
- **입술 분리**: lips를 upper_lips와 lower_lips로 분리 (인덱스 기반 구분)
  - Upper Lips 인덱스: [61, 185, 40, 39, 37, 0, 267, 269, 270, 409, 291, 375, 321, 405, 314, 17, 84]
  - Lower Lips 인덱스: [181, 91, 146, 78, 95, 88, 178, 87, 14, 317, 402, 318, 324]
  - 인덱스 기반 구분으로 고개를 틀어도 안정적으로 동작

### 3. 각 부위별 크기 조절 함수 추가
- 각 부위의 중심점(오프셋 포함)을 기준으로 크기 조절
- `utils/face_morphing/adjustments.py`에 함수 추가
- 또는 기존 함수를 확장하여 모든 부위 지원

### 4. 각 부위별 위치 이동 함수 추가
- 각 부위의 중심점(오프셋 포함)을 기준으로 위치 이동
- `utils/face_morphing/adjustments.py`에 함수 추가
- **눈동자 제한사항**: 눈동자는 눈 안에 있으므로 위치 이동이 제한적일 수 있음 (검토 필요)

### 5. UI에 동적 슬라이더 추가
- 선택된 부위에 대해 공통 슬라이더 생성 (최대 5개 고정)
- 선택된 모든 부위에 공통으로 적용되는 5개 슬라이더:
  - Center Offset X (중심점 오프셋 X) - 각 부위의 중심점에 개별 적용
  - Center Offset Y (중심점 오프셋 Y) - 각 부위의 중심점에 개별 적용
  - Size (크기) - 각 부위의 중심점 기준으로 개별 적용
  - Position X (위치 이동 X) - 각 부위의 중심점 기준으로 개별 이동
  - Position Y (위치 이동 Y) - 각 부위의 중심점 기준으로 개별 이동
- **공통 적용 방식**: 슬라이더 값은 하나지만, 선택된 각 부위의 중심점을 기준으로 개별 적용
- 부위 선택 변경 시 슬라이더는 유지 (값은 그대로, 적용 대상만 변경)
- 아무 부위도 선택되지 않으면 슬라이더 숨김 또는 비활성화
- Tesselation 선택 시에도 동일하게 5개 슬라이더 표시

### 6. 변수 추가
- 공통 슬라이더 변수 5개만 사용 (부위 개수와 무관)
  - center_offset_x: 선택된 모든 부위의 중심점 오프셋 X
  - center_offset_y: 선택된 모든 부위의 중심점 오프셋 Y
  - size: 선택된 모든 부위의 크기 비율
  - position_x: 선택된 모든 부위의 위치 이동 X
  - position_y: 선택된 모든 부위의 위치 이동 Y
- **공통 적용 원리**: 슬라이더 값은 하나지만, 선택된 각 부위의 중심점을 기준으로 개별 적용
- Tesselation 선택 시에도 동일한 5개 변수 사용
- **입술 분리**: upper_lips와 lower_lips를 선택하면 각각의 중심점 기준으로 개별 적용

## 작업 순서

### 1단계: Tesselation 별도 모드 처리
- [ ] `gui/face_edit/slider_ui.py`의 체크박스 생성 함수 수정
  - Tesselation 선택 시 다른 부위 체크박스 비활성화
  - 개별 부위 선택 시 Tesselation 체크박스 비활성화
  - 상호 배타적 선택 로직 구현

### 2단계: 각 부위별 중심점 계산 함수 추가
- [ ] `utils/face_morphing/region_extraction.py`에 `_get_region_center()` 함수 추가
  - 부위 이름을 받아서 해당 부위의 중심점 반환
  - MediaPipe 연결 정보를 사용하여 중심점 계산
  - 중심점 오프셋 파라미터 추가 (offset_x, offset_y)
  - 지원 부위: face_oval, left_eye, right_eye, left_eyebrow, right_eyebrow, nose, upper_lips, lower_lips, left_iris, right_iris, contours, tesselation
  - Tesselation도 개별 부위와 동일하게 중심점 계산 (전체 메시의 중심점)
  - **입술 분리 처리**: 
    - upper_lips: UPPER_LIP_INDICES = [61, 185, 40, 39, 37, 0, 267, 269, 270, 409, 291, 375, 321, 405, 314, 17, 84] 사용
    - lower_lips: LOWER_LIP_INDICES = [181, 91, 146, 78, 95, 88, 178, 87, 14, 317, 402, 318, 324] 사용
    - 인덱스 기반 구분으로 고개를 틀어도 안정적으로 동작

### 3단계: 각 부위별 크기 조절 함수 추가
- [ ] `utils/face_morphing/adjustments.py`에 `adjust_region_size()` 함수 추가
  - 부위 이름, 크기 비율, 중심점을 받아서 해당 부위만 크기 조절
  - 중심점을 기준으로 스케일링
  - 기존 `adjust_eye_size()`, `adjust_nose_size()` 등의 패턴 참고

### 4단계: 각 부위별 위치 이동 함수 추가
- [ ] `utils/face_morphing/adjustments.py`에 `adjust_region_position()` 함수 추가
  - 부위 이름, 이동 거리(x, y), 중심점(오프셋 포함)을 받아서 해당 부위만 이동
  - 중심점(오프셋 포함)을 기준으로 이동
  - 기존 `adjust_eye_position()` 패턴 참고
  - **눈동자 제한사항**: 눈동자는 눈 안에 있으므로 위치 이동 범위 제한 검토

### 5단계: 변수 추가 및 UI 구조 설계
- [ ] `gui/face_edit/__init__.py`에 공통 슬라이더 변수 추가
  - 5개 변수만 추가: center_offset_x, center_offset_y, size, position_x, position_y
  - 선택된 부위 개수와 무관하게 항상 5개 변수만 사용
  - Tesselation 선택 시에도 동일한 5개 변수 사용
  - **입술 분리**: 기존 lips 체크박스를 upper_lips, lower_lips로 분리
    - UI 체크박스: "Upper Lips", "Lower Lips"로 표시
    - 여러 부위 선택 시 각 부위의 중심점 기준으로 개별 적용
- [ ] UI 레이아웃 설계
  - 부위 선택 체크박스를 2열로 변경 (좌측 몰아서 배치)
  - 선택된 부위에 대한 슬라이더를 동적으로 생성하는 영역 추가
  - Tesselation 선택 시에도 5개 슬라이더 표시 (개별 부위와 동일)

### 6단계: 동적 슬라이더 UI 구현
- [ ] `gui/face_edit/slider_ui.py`의 `_create_face_tab()` 함수 수정
  - 부위 선택 체크박스를 2열로 변경
  - "Region Adjustment" 섹션 추가
  - 공통 슬라이더 5개 생성 (부위 선택 개수와 무관)
  - 슬라이더: Center Offset X, Center Offset Y, Size, Position X, Position Y
  - 부위 선택 변경 시 슬라이더는 유지 (값은 그대로, 적용 대상만 변경)
  - 아무 부위도 선택되지 않으면 슬라이더 숨김 또는 비활성화
  - Tesselation 선택 시에도 동일하게 5개 슬라이더 표시

### 7단계: 슬라이더 변경 이벤트 처리
- [ ] `gui/face_edit/morphing.py`에 슬라이더 변경 이벤트 핸들러 추가
  - 공통 슬라이더 값 변경 시 선택된 모든 부위에 적용
  - 각 부위의 중심점을 기준으로 개별 변형 적용
  - 여러 부위가 선택된 경우 각 부위를 순차적으로 변형 (각 부위의 중심점 기준)

### 8단계: 통합 함수 수정
- [ ] `utils/face_morphing/integration.py`의 `apply_all_adjustments()` 함수 수정
  - 공통 슬라이더 값(5개)을 받아서 선택된 부위에 적용
  - 선택된 각 부위의 중심점을 기준으로 개별 변형 적용
  - 여러 부위 선택 시 각 부위를 순차적으로 처리

## 관련 파일

### 수정할 파일
1. `utils/face_morphing/region_extraction.py` - 중심점 계산 함수 추가
2. `utils/face_morphing/adjustments.py` - 부위별 크기/위치 조절 함수 추가
3. `utils/face_morphing/integration.py` - 통합 함수 수정
4. `gui/face_edit/__init__.py` - 변수 추가
5. `gui/face_edit/slider_ui.py` - 동적 슬라이더 UI 추가
6. `gui/face_edit/morphing.py` - 슬라이더 변경 이벤트 처리

### 참고할 파일
- `utils/face_morphing/adjustments.py` - `adjust_eye_size()`, `adjust_eye_position()`, `adjust_upper_lip_shape()`, `adjust_lower_lip_shape()` 등
- `utils/face_morphing/region_extraction.py` - `_get_eye_region()`, `_get_nose_region()` 등
- `gui/face_edit/landmark_display.py` - `UPPER_LIP_INDICES`, `LOWER_LIP_INDICES` 정의 참고

## 구현 세부사항

### 각 부위별 중심점 계산
```python
def _get_region_center(region_name, landmarks):
    """부위별 중심점 계산"""
    # MediaPipe 연결 정보를 사용하여 해당 부위의 모든 포인트 수집
    # 포인트들의 평균 좌표 계산
    return (center_x, center_y)
```

### 각 부위별 중심점 계산 (오프셋 포함)
```python
def _get_region_center(region_name, landmarks, center_offset_x=0.0, center_offset_y=0.0):
    """부위별 중심점 계산 (오프셋 포함)"""
    # 1. MediaPipe 연결 정보를 사용하여 해당 부위의 모든 포인트 수집
    # 2. 포인트들의 평균 좌표 계산 (기본 중심점)
    # 3. 오프셋 적용: center_x + center_offset_x, center_y + center_offset_y
    return (center_x + center_offset_x, center_y + center_offset_y)
```

### 선택된 부위에 공통 적용
```python
def apply_common_adjustments(image, selected_regions, center_offset_x=0.0, center_offset_y=0.0, 
                             size=1.0, position_x=0.0, position_y=0.0, landmarks=None):
    """선택된 모든 부위에 공통 슬라이더 값 적용 (각 부위의 중심점 기준으로 개별 적용)"""
    # 1. 선택된 부위 목록 순회
    # 2. 각 부위의 중심점 계산 (오프셋 포함)
    # 3. 각 부위에 대해 개별적으로 변형 적용:
    #    - 중심점 오프셋 적용
    #    - 위치 이동 적용 (각 부위의 중심점 기준)
    #    - 크기 조절 적용 (각 부위의 중심점 기준)
    # 4. 모든 변형을 순차적으로 적용하여 최종 이미지 생성
```

### 각 부위별 크기 조절 (내부 함수)
```python
def adjust_region_size(image, region_name, size_ratio=1.0, center_offset_x=0.0, center_offset_y=0.0, landmarks=None):
    """부위별 크기 조절 (중심점 오프셋 포함 기준) - 내부 함수"""
    # 1. 부위 중심점 계산 (오프셋 포함)
    # 2. 부위 영역 추출
    # 3. 오프셋이 적용된 중심점 기준으로 스케일링
    # 4. 블렌딩하여 원본 이미지에 적용
```

### 각 부위별 위치 이동 (내부 함수)
```python
def adjust_region_position(image, region_name, position_x=0.0, position_y=0.0, 
                          center_offset_x=0.0, center_offset_y=0.0, landmarks=None):
    """부위별 위치 이동 (중심점 오프셋 + 추가 이동) - 내부 함수"""
    # 1. 부위 중심점 계산 (오프셋 포함)
    # 2. 부위 영역 추출
    # 3. 오프셋이 적용된 중심점 + 추가 이동(position_x, position_y)으로 이동
    # 4. 블렌딩하여 원본 이미지에 적용
    # **눈동자 제한사항**: 눈동자는 눈 안에 있으므로 이동 범위 제한 필요
```

## 주의사항
1. **Tesselation 별도 처리**: Tesselation과 개별 부위는 상호 배타적 선택
2. **중심점 오프셋**: 각 부위의 중심점 자체를 이동시킬 수 있어야 함
3. **눈동자 제한사항**: 눈동자는 눈 안에 있으므로 위치 이동이 제한적일 수 있음 (검토 필요)
4. 각 부위의 중심점을 정확히 계산해야 함
5. 여러 부위가 선택된 경우 공통 슬라이더 값이 각 부위의 중심점 기준으로 개별 적용
6. 변형 순서: 중심점 오프셋 → 위치 이동 → 크기 조절
7. 성능 고려: 선택된 부위만 처리
8. UI 공간 절약: 2열 레이아웃 사용, 슬라이더는 고정 5개로 제한
9. **공통 적용 원리**: 슬라이더 값은 하나지만, 각 부위의 중심점을 기준으로 개별 변형 적용
9. **입술 분리**: 
   - 인덱스 기반 구분 사용 (y 좌표 비교 방식은 고개를 틀면 부정확)
   - Upper Lips와 Lower Lips는 각각 독립적으로 선택 및 조절 가능
   - 입술 인덱스는 `gui/face_edit/landmark_display.py`에 이미 정의되어 있음

## 완료 기준
- [ ] Tesselation과 개별 부위 상호 배타적 선택 구현
- [ ] 모든 부위(12개, Tesselation 포함)에 대한 중심점 계산 함수 구현 (오프셋 포함)
  - 입술 분리: upper_lips, lower_lips 각각 인덱스 기반으로 정확히 구분
- [ ] 모든 부위에 대한 크기 조절 함수 구현 (중심점 오프셋 기준)
- [ ] 모든 부위에 대한 위치 이동 함수 구현 (중심점 오프셋 + 추가 이동)
- [ ] 눈동자 위치 이동 제한사항 검토 및 적용
- [ ] 선택된 부위에 대해 공통 슬라이더 생성 (고정 5개)
  - 선택된 부위 개수와 무관하게 항상 최대 5개 슬라이더
  - 각 부위의 중심점을 기준으로 개별 적용
- [ ] Tesselation 선택 시에도 5개 슬라이더 표시 (개별 부위와 동일)
- [ ] 슬라이더 변경 시 해당 부위만 올바르게 변형
- [ ] 여러 부위 동시 선택 시 공통 슬라이더 값이 각 부위의 중심점 기준으로 개별 적용됨
- [ ] 입술 분리 검증: 고개를 틀어도 upper_lips와 lower_lips가 정확히 구분됨
- [ ] 아무 부위도 선택되지 않으면 슬라이더가 숨김 또는 비활성화됨
