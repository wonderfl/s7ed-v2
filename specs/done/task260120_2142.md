# 작업계획서: morph_face_by_polygons 함수 리팩토링

## 작업 목표
약 990줄의 거대한 `morph_face_by_polygons` 함수를 기능별로 분리하여 가독성, 유지보수성, 테스트 가능성을 향상시킵니다.

## 문제 분석

### 현재 상태
- **함수 크기**: 약 990줄 (100줄~1089줄)
- **파일 위치**: `utils/face_morphing/polygon_morphing/core.py`
- **복잡도**: 매우 높음 (다중 책임, 깊은 중첩, 긴 로직)

### 문제점
1. **가독성 저하**: 함수가 너무 길어서 전체 흐름 파악 어려움
2. **유지보수 어려움**: 특정 기능 수정 시 전체 함수를 이해해야 함
3. **테스트 어려움**: 단위 테스트 작성이 거의 불가능
4. **버그 발생 가능성**: 복잡한 로직으로 인한 실수 가능성 증가
5. **재사용 불가**: 내부 로직을 다른 곳에서 재사용하기 어려움

## 작업 계획

### 1. 함수 분리 계획

#### 1.1 입력 검증 및 전처리 함수
- **함수명**: `_validate_and_prepare_inputs`
- **위치**: `utils/face_morphing/polygon_morphing/core.py`
- **책임**:
  - 의존성 확인 (OpenCV, scipy)
  - 랜드마크 유효성 검사
  - PIL Image를 numpy 배열로 변환
- **예상 크기**: 약 50줄
- **입력**: image, original_landmarks, transformed_landmarks
- **출력**: img_array, img_width, img_height (또는 None)

#### 1.2 눈동자 포인트 처리 함수
- **함수명**: `_prepare_iris_centers`
- **위치**: `utils/face_morphing/polygon_morphing/core.py`
- **책임**:
  - 눈동자 인덱스 가져오기
  - 눈동자 포인트 제거
  - 중앙 포인트 계산 또는 전달된 좌표 사용
  - 좌표 스케일링 및 오프셋 조정
- **예상 크기**: 약 300줄
- **입력**: original_landmarks, transformed_landmarks, left_iris_center_coord, right_iris_center_coord, left_iris_center_orig, right_iris_center_orig, img_width, img_height
- **출력**: original_landmarks_no_iris, transformed_landmarks_no_iris, original_points_array, transformed_points_array, iris_indices

#### 1.3 Delaunay Triangulation 구성 함수
- **함수명**: `_create_delaunay_triangulation`
- **위치**: `utils/face_morphing/polygon_morphing/core.py`
- **책임**:
  - 경계 포인트 추가
  - Delaunay Triangulation 생성
  - 캐싱 처리
- **예상 크기**: 약 50줄
- **입력**: original_points_array
- **출력**: tri (Delaunay 객체)

#### 1.4 뒤집힌 삼각형 검사 함수
- **함수명**: `_check_and_fix_flipped_triangles`
- **위치**: `utils/face_morphing/polygon_morphing/core.py`
- **책임**:
  - 뒤집힌 삼각형 감지
  - 문제 포인트 복원
- **예상 크기**: 약 30줄
- **입력**: original_points_array, transformed_points_array, tri
- **출력**: transformed_points_array (수정됨)

#### 1.5 바운딩 박스 계산 및 다운샘플링 함수
- **함수명**: `_calculate_bounding_box_and_downsample`
- **위치**: `utils/face_morphing/polygon_morphing/core.py`
- **책임**:
  - 바운딩 박스 계산 (캐시 사용)
  - 다운샘플링 판단 및 실행
  - GPU 가속 시도
- **예상 크기**: 약 150줄
- **입력**: original_landmarks_no_iris, transformed_landmarks_no_iris, img_array, img_width, img_height, cached_original_bbox
- **출력**: working_img, working_width, working_height, scale_factor, min_x, min_y, max_x, max_y, min_x_orig_bbox, min_y_orig_bbox, max_x_orig_bbox, max_y_orig_bbox

#### 1.6 픽셀 단위 변형 매핑 함수
- **함수명**: `_apply_triangulation_morphing`
- **위치**: `utils/face_morphing/polygon_morphing/core.py`
- **책임**:
  - 각 픽셀에 대해 삼각형 찾기
  - 정변환 행렬 계산 및 적용
  - 픽셀 샘플링 및 매핑
- **예상 크기**: 약 400줄
- **입력**: working_img, working_width, working_height, original_points_array, transformed_points_array, tri, min_x, min_y, max_x, max_y
- **출력**: result (변형된 이미지 배열)

#### 1.7 후처리 함수
- **함수명**: `_post_process_morphed_image`
- **위치**: `utils/face_morphing/polygon_morphing/core.py`
- **책임**:
  - 빈 공간 채우기 (inpainting)
  - 업샘플링 (다운샘플링했던 경우)
  - 블렌딩 비율 적용
- **예상 크기**: 약 100줄
- **입력**: result, img_array, img_width, img_height, scale_factor, min_x_orig_bbox, min_y_orig_bbox, max_x_orig_bbox, max_y_orig_bbox, blend_ratio
- **출력**: result (최종 이미지 배열)

#### 1.8 메인 함수 리팩토링
- **함수명**: `morph_face_by_polygons` (유지)
- **위치**: `utils/face_morphing/polygon_morphing/core.py`
- **책임**:
  - 전체 흐름 조율
  - 각 단계 함수 호출
  - 예외 처리
- **예상 크기**: 약 100줄 (현재 990줄에서 대폭 감소)
- **변경 사항**: 내부 로직을 위의 헬퍼 함수들로 대체

### 2. 작업 순서

1. [x] **1단계**: 입력 검증 및 전처리 함수 분리
   - [x] `_validate_and_prepare_inputs` 함수 생성
   - [x] 기존 코드에서 해당 부분 추출 및 이동
   - [x] 메인 함수에서 새 함수 호출하도록 수정
   - [ ] 테스트 및 검증 (다음 단계 진행 전에 필요)

2. [x] **2단계**: 눈동자 포인트 처리 함수 분리
   - [x] `_prepare_iris_centers` 함수 생성
   - [x] 중앙 포인트 계산 로직 포함
   - [x] 메인 함수에서 새 함수 호출하도록 수정
   - [ ] 테스트 및 검증 (다음 단계 진행 전에 필요)

3. [x] **3단계**: Delaunay Triangulation 구성 함수 분리
   - [x] `_create_delaunay_triangulation` 함수 생성
   - [x] 캐싱 로직 포함
   - [x] 메인 함수에서 새 함수 호출하도록 수정
   - [ ] 테스트 및 검증 (다음 단계 진행 전에 필요)

4. [x] **4단계**: 뒤집힌 삼각형 검사 함수 분리
   - [x] `_check_and_fix_flipped_triangles` 함수 생성
   - [x] 메인 함수에서 새 함수 호출하도록 수정
   - [ ] 테스트 및 검증 (다음 단계 진행 전에 필요)

5. [x] **5단계**: 바운딩 박스 계산 및 다운샘플링 함수 분리
   - [x] `_calculate_bounding_box_and_downsample` 함수 생성 (약 160줄)
   - [x] 바운딩 박스 계산 (캐시 활용)
   - [x] 다운샘플링 판단 및 실행
   - [x] GPU 가속 로직 포함
   - [x] 랜드마크 좌표 스케일 조정
   - [x] Delaunay 재계산
   - [x] 메인 함수에서 새 함수 호출
   - [ ] 테스트 및 검증

6. [x] **6단계**: 픽셀 단위 변형 매핑 함수 분리
   - [x] `_apply_triangulation_morphing` 함수 생성 (약 270줄)
   - [x] 랜드마크 변형 확인 및 조기 종료
   - [x] 삼각형 찾기 (청크 단위 처리)
   - [x] 정변환 행렬 계산 및 적용
   - [x] 삼각형 유효성 검사
   - [x] Bilinear interpolation
   - [x] 블렌딩 비율 처리
   - [x] 메인 함수에서 새 함수 호출
   - [ ] 테스트 및 검증

7. [x] **7단계**: 후처리 함수 분리
   - [x] `_post_process_morphed_image` 함수 생성 (약 120줄)
   - [x] 빈 공간 채우기 (inpainting) 로직 포함
   - [x] 업샘플링 로직 포함
   - [x] 블렌딩 비율 적용 로직 포함
   - [x] 메인 함수에서 새 함수 호출
   - [ ] 테스트 및 검증

8. [ ] **8단계**: 메인 함수 리팩토링
   - `morph_face_by_polygons` 함수를 위의 헬퍼 함수들을 호출하도록 수정
   - 전체 흐름 테스트 및 검증

9. [ ] **9단계**: 통합 테스트
   - 모든 기능이 정상 동작하는지 확인
   - 성능 비교 (리팩토링 전후)
   - 기존 호출 코드와의 호환성 확인

### 3. 테스트 계획

- [ ] 각 헬퍼 함수에 대한 단위 테스트 작성
- [ ] 통합 테스트로 전체 흐름 검증
- [ ] 성능 테스트 (리팩토링 전후 비교)
- [ ] 실제 사용 시나리오 테스트 (얼굴 편집 패널에서 테스트)

### 4. 주의사항

1. **하위 호환성 유지**: 함수 시그니처 변경 없이 내부만 리팩토링
2. **성능 유지**: 리팩토링으로 인한 성능 저하 방지
3. **예외 처리**: 기존 예외 처리 로직 유지
4. **로깅**: 기존 로그 메시지 유지
5. **점진적 진행**: 한 번에 하나씩 함수를 분리하여 안정성 확보

## 예상 효과

- **가독성 향상**: 각 함수가 단일 책임을 가지므로 이해하기 쉬움
- **유지보수성 향상**: 특정 기능 수정 시 해당 함수만 수정하면 됨
- **테스트 가능성 향상**: 각 함수를 독립적으로 테스트 가능
- **재사용성 향상**: 헬퍼 함수들을 다른 곳에서도 사용 가능
- **버그 감소**: 작은 함수로 분리하여 버그 발생 가능성 감소

## 리스크

- **리팩토링 중 버그 발생 가능성**: 점진적으로 진행하여 최소화
- **성능 저하 가능성**: 함수 호출 오버헤드 (미미할 것으로 예상)
- **테스트 부족**: 각 단계마다 충분한 테스트 필요
