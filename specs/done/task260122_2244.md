# 작업계획서: 눈동자 중심점 드래그 버그 테스트 및 검증 ✅ 완료

**AI는 모르는 걸 모른다. 테스트하고 결과를 꼭 확인한다.**

**작업 상태: ✅ 완료 (2026-01-22)**

## 1. 작업 목표 ✅

**우선순위: 최우선 (버그 수정)** - **완료**

눈동자 중심점을 드래그할 때 눈동자는 움직이지 않고 머리만 움직이는 버그를 수정합니다.

**최종 결과**: 
- ✅ 눈동자만 움직이고 머리는 고정됨
- ✅ 양쪽 눈동자(Left/Right Iris) 모두 정상 작동
- ✅ 다양한 이미지 크기에서 테스트 완료 (680x897, 500x750, 800x1440)
- ✅ Git commit 및 push 완료

## 2. 현재 상태 분석 ✅

### 2.1. 최종 상태

#### 버그 수정 완료 ✅
**완료**: 눈동자 드래그 버그가 성공적으로 수정되었습니다.

#### 실제 수정된 내용 ✅

**근본 원인 3가지 발견 및 수정:**

1. **스케일링 문제** (`utils/face_morphing/polygon_morphing/core.py`)
   - 중심점 좌표가 잘못된 스케일링으로 눈 영역 밖에 배치됨
   - 해결: 중심점이 이미지 범위 안에 있으면 스케일링하지 않도록 수정
   - 잘못된 offset 계산으로 인한 좌표 오류 해결

2. **원본 좌표 미초기화** (`gui/face_edit/landmark_manager.py`)
   - 새 이미지 로드 시 이전 이미지의 원본 iris center 좌표가 남아있음
   - 해결: `reset(keep_original=False)` 시 `_original_left_iris_center_coord`와 `_original_right_iris_center_coord`도 초기화

3. **뒤집힌 삼각형 복원 문제** (`utils/face_morphing/polygon_morphing/core.py`)
   - 중심점이 뒤집힌 삼각형의 문제 포인트로 감지되어 원본으로 복원됨
   - 해결: 중심점 인덱스(468, 469)를 `protected_indices`에 추가하여 복원에서 제외

#### 탭 렌더러 연동
눈동자 중심점 드래그는 두 곳에서 호출됩니다:

1. **`gui/face_edit/polygon_renderer/all_tab_drawer.py`** (디폴트)
   - `_draw_all_tab_polygons` 함수에서 눈동자 중심점 렌더링
   - All 탭에서 모든 랜드마크 표시 (기본 탭)

2. **`gui/face_edit/polygon_renderer/tab_drawers.py`**
   - `_draw_iris_tab_polygons` 함수에서 눈동자 중심점 렌더링
   - Eye 탭에서 눈 관련 랜드마크만 표시

**중요**: 두 파일 모두 `polygon_drag_handler.py`의 동일한 드래그 핸들러 함수를 호출하므로, 드래그 로직 수정은 자동으로 모든 탭에 적용됩니다.

### 2.2. 수정된 핵심 로직

```python
# 눈동자 중심점만 변경한 경우 확인
is_iris_center_only = isinstance(last_selected_index, str) and last_selected_index in ('left', 'right')

# 눈동자 중심점만 변경한 경우 원본 랜드마크 사용
if is_iris_center_only:
    original_face = self.landmark_manager.get_original_face_landmarks()
    if original_face is not None:
        custom_landmarks_for_morph = list(original_face)  # 복사본 생성
    else:
        custom_landmarks_for_morph = self.landmark_manager.get_custom_landmarks()
```

이 로직으로 눈동자 중심점만 드래그할 때 다른 얼굴 랜드마크(468개)는 원본 그대로 유지하고, 중앙 포인트 2개만 변경하도록 합니다.

### 2.3. 문제 원인 요약

1. **원인**: `custom_landmarks_for_morph`가 드래그로 변형된 468개 랜드마크를 사용
2. **증상**: 눈동자 중심점만 드래그해도 Delaunay Triangulation에 의해 머리 전체가 변형됨
3. **해결**: 눈동자 중심점만 드래그할 때는 468개 랜드마크를 원본으로 설정하고 중앙 포인트 2개만 변경

## 3. 테스트 계획

### 3.1. 테스트 환경 구성

- 테스트 이미지: `test/` 폴더의 얼굴 이미지 사용
- 테스트 방법: GUI 실행 후 수동 테스트
- **기본 탭**: "All" 탭 (디폴트)에서 우선 테스트, 이후 "Eye" 탭에서도 확인

### 3.2. 테스트 시나리오

#### 시나리오 1: All 탭에서 왼쪽 눈동자 중심점 드래그
1. 얼굴 편집 패널 열기
2. **"All" 탭 선택 (디폴트)**
3. 왼쪽 눈동자 중심점(빨간 점) 드래그
4. **예상 결과**: 왼쪽 눈동자만 이동, 머리는 움직이지 않음
5. **확인 사항**:
   - 로그에 "중심점 드래그 시작 (left)" 출력
   - 로그에 "마지막 선택 포인트: 중앙 포인트 (left)" 출력
   - `custom_landmarks_for_morph`가 원본으로 설정됨

#### 시나리오 2: All 탭에서 오른쪽 눈동자 중심점 드래그
1. 얼굴 편집 패널 열기
2. **"All" 탭 선택 (디폴트)**
3. 오른쪽 눈동자 중심점(빨간 점) 드래그
4. **예상 결과**: 오른쪽 눈동자만 이동, 머리는 움직이지 않음
5. **확인 사항**:
   - 로그에 "중심점 드래그 시작 (right)" 출력
   - 로그에 "마지막 선택 포인트: 중앙 포인트 (right)" 출력

#### 시나리오 2-1: Eye 탭에서도 동일하게 동작하는지 확인
1. "Eye" 탭으로 전환
2. 왼쪽/오른쪽 눈동자 중심점 드래그
3. **예상 결과**: All 탭과 동일하게 동작
4. **확인 사항**: 탭 간 일관성 확인

#### 시나리오 3: 일반 랜드마크 포인트 드래그 (회귀 테스트)
1. 눈꺼풀, 입, 코 등의 일반 랜드마크 포인트 드래그
2. **예상 결과**: 해당 부위만 변형됨 (기존 기능 정상 동작)
3. **확인 사항**:
   - `is_iris_center_only`가 False로 판단됨
   - 일반적인 `custom_landmarks_for_morph` 사용

#### 시나리오 4: 눈동자 드래그 후 슬라이더 조정
1. 눈동자 중심점 드래그
2. 얼굴 크기/위치 슬라이더 조정
3. **예상 결과**: 눈동자 위치가 유지되면서 슬라이더 효과 적용
4. **확인 사항**:
   - 드래그 포인트 백업/복원 로직 정상 동작

### 3.3. 로그 확인 항목

테스트 시 다음 로그 메시지를 확인합니다:

```
[얼굴편집] 중심점 드래그 시작 (left/right): 시작 좌표=(x, y)
[얼굴편집] 중심점 드래그 종료 (left/right): 최종 좌표 - left=(x, y), right=(x, y)
[얼굴편집] 마지막 선택 포인트: 중앙 포인트 (left/right)
[얼굴편집] apply_polygon_drag_final: landmark_manager에서 가져온 중앙 포인트 - left=(x, y), right=(x, y)
[얼굴편집] apply_polygon_drag_final: 원본 중앙 포인트 - left_orig=(x, y), right_orig=(x, y)
```

### 3.4. 디버그 스크립트 작성 (선택적)

필요 시 `debug/test_iris_drag_fix.py` 스크립트를 작성하여 자동화된 테스트를 수행합니다.

## 4. 검증 기준

### 4.1. 성공 기준

- ✅ 눈동자 중심점 드래그 시 눈동자만 이동
- ✅ 머리, 얼굴 윤곽, 다른 부위는 움직이지 않음
- ✅ 일반 랜드마크 드래그는 기존대로 정상 동작
- ✅ 로그에 올바른 메시지 출력
- ✅ `is_iris_center_only` 플래그 정상 감지

### 4.2. 실패 시 조치

다음 경우 추가 수정이 필요합니다:

1. **머리가 여전히 움직이는 경우**:
   - `custom_landmarks_for_morph` 설정 로직 재확인
   - `is_iris_center_only` 플래그 감지 로직 재확인

2. **눈동자가 움직이지 않는 경우**:
   - 중앙 포인트 좌표 전달 로직 확인
   - `morph_face_by_polygons` 파라미터 확인

3. **일반 랜드마크 드래그가 작동하지 않는 경우**:
   - 회귀 버그 발생, 조건 분기 로직 수정 필요

## 5. 추가 고려사항

### 5.1. 관련 작업과의 통합

- **task260122_1910**: 눈동자 이동 방식 개선 작업과 연관
- 이 버그 수정이 완료되면 task260122_1910의 눈동자 윤곽 연동 작업을 진행할 수 있음

### 5.2. 성능 고려사항

- 원본 랜드마크 복사 시 리스트 복사 오버헤드 최소화
- LandmarkManager 캐싱 활용

### 5.3. 향후 개선 방향

버그 수정이 확인되면 다음 작업 진행:
1. 눈동자 윤곽과 눈꺼풀 랜드마크 연동 강화
2. 눈동자 확대/축소 효과 개선
3. 시각화 강화

## 6. 작업 순서

### 6.1. 현재 작업 (task260122_2244) - 버그 수정 ✅ 완료

#### A. 버그 재현 및 확인 ✅
1. [x] 테스트 환경 준비 (GUI 실행, 테스트 이미지 로드)
2. [x] 버그 재현: All 탭에서 눈동자 중심점 드래그 시 머리가 움직이는지 확인
3. [x] 로그 확인: 현재 어떤 값들이 전달되는지 확인

#### B. 버그 수정 ✅
4. [x] 근본 원인 3가지 수정:
   - [x] `utils/face_morphing/polygon_morphing/core.py`: 스케일링 로직 수정
   - [x] `gui/face_edit/landmark_manager.py`: 원본 좌표 초기화 추가
   - [x] `utils/face_morphing/polygon_morphing/core.py`: 중심점 보호 로직 추가

#### C. 수정 후 테스트 ✅
5. [x] 시나리오 1: All 탭에서 왼쪽 눈동자 중심점 드래그 테스트
6. [x] 시나리오 2: All 탭에서 오른쪽 눈동자 중심점 드래그 테스트
7. [x] 시나리오 2-1: Eye 탭에서도 동일하게 동작하는지 확인
8. [x] 시나리오 3: 일반 랜드마크 드래그 회귀 테스트 (기존 기능 정상 동작 확인)
9. [x] 시나리오 4: 눈동자 드래그 후 슬라이더 조정 테스트

#### D. 최종 검증 ✅
10. [x] 로그 메시지 확인 및 검증
11. [x] 성공 기준 달성 여부 확인
12. [x] 테스트 결과 문서화 및 버그 수정 완료 확인
13. [x] Git commit 및 push 완료

### 6.2. 단기 계획 작업 순서 (1-2주 내)

#### task260122_1910 완료
8. [ ] 눈동자 윤곽과 눈꺼풀 랜드마크 연동 강화
   - [ ] `_draw_iris_tab_polygons` 함수 수정: 눈동자 중앙 포인트 이동 시 윤곽 폴리곤 함께 이동
   - [ ] 눈꺼풀 랜드마크 기준 자연스러운 눈동자 윤곽 구현
   - [ ] `_prepare_iris_centers` 함수에 눈동자 윤곽 랜드마크 변형 로직 추가

9. [ ] 확대/축소 효과 개선 및 시각화 강화
   - [ ] 눈동자 중앙 포인트 이동 거리 비례 크기 조절
   - [ ] `scale_ratio` 눈동자 폴리곤 직접 적용
   - [ ] `_prepare_iris_centers`에서 `scale_factor` 반영 확인

10. [ ] 테스트 및 디버깅
    - [ ] `debug/debug_iris_movement.py` 작성
    - [ ] 다양한 시나리오 테스트



### 6.3. 중기 계획 작업 순서 (1-2개월 내)

#### 눈동자 관련 기능 추가
13. [ ] 눈동자 색상 변경 기능
    - [ ] 눈동자 영역 자동 감지 로직 구현
    - [ ] HSV 색상 조정 슬라이더 UI 추가
    - [ ] 자연스러운 색상 블렌딩 알고리즘 구현

14. [ ] 눈동자 크기 조절 기능
    - [ ] 눈동자 윤곽 스케일링 로직 구현
    - [ ] 눈꺼풀과의 충돌 방지 로직
    - [ ] 미리보기 기능 추가



#### 성능 최적화
16. [ ] 캐싱 전략 개선
    - [ ] Delaunay Triangulation 캐시 최적화
    - [ ] 바운딩 박스 캐시 개선
    - [ ] LandmarkManager 캐시 효율화

17. [ ] GPU 가속 확장
    - [ ] GPU 가속 대상 연산 선정
    - [ ] CUDA/OpenCL 활용 검토

18. [ ] 메모리 사용 최적화
    - [ ] 불필요한 복사 제거
    - [ ] 참조 관리 개선

#### 사용성 개선
19. [ ] 실시간 미리보기 강화
    - [ ] 드래그 중 실시간 변형 표시
    - [ ] 프레임률 개선

20. [ ] 실행 취소/다시 실행 기능
    - [ ] 변경 이력 스택 구현
    - [ ] Ctrl+Z/Ctrl+Y 단축키 지원

21. [ ] 프리셋 기능
    - [ ] 설정 저장/불러오기 기능
    - [ ] 기본 프리셋 제공

### 6.4. 장기 계획 작업 순서 (3-6개월 내)

#### AI 기반 기능
22. [ ] AI 얼굴 보정
    - [ ] 얼굴 대칭성 자동 보정
    - [ ] 자연스러운 표정 생성
    - [ ] 연령대별 얼굴 변환

23. [ ] 스타일 전송 개선
    - [ ] 정교한 스타일 전송 알고리즘
    - [ ] 다양한 스타일 프리셋

#### 일괄 처리 기능
24. [ ] 배치 편집
    - [ ] 여러 이미지 동시 처리
    - [ ] 동일한 설정 일괄 적용

25. [ ] 자동화 스크립트
    - [ ] Python API 제공
    - [ ] CLI 모드 지원

#### 플러그인 시스템
26. [ ] 확장 가능한 구조
    - [ ] 플러그인 인터페이스 정의
    - [ ] 서드파티 플러그인 지원

27. [ ] 커뮤니티 기능
    - [ ] 플러그인 마켓플레이스
    - [ ] 사용자 프리셋 공유

## 7. 향후 개선 계획

### 7.1. 단기 계획 (이번 작업 완료 후)

#### 7.1.1. task260122_1910 완료
눈동자 이동 방식 개선 작업의 남은 부분 완료:

1. **눈동자 윤곽과 눈꺼풀 랜드마크 연동 강화**
   - `_draw_iris_tab_polygons` 함수에서 눈동자 중앙 포인트 이동 시 윤곽 폴리곤(`LEFT_IRIS`, `RIGHT_IRIS`)의 각 점들이 함께 이동
   - 눈꺼풀 랜드마크(`LEFT_EYE`, `RIGHT_EYE`)를 기준으로 눈동자 윤곽이 눈꺼풀 안쪽으로 자연스럽게 들어가는 효과 구현
   - `_prepare_iris_centers` 함수에서 눈동자 윤곽 랜드마크 변형 처리 로직 추가/수정

2. **확대/축소 효과 개선 및 시각화 강화**
   - 눈동자 중앙 포인트 이동 거리에 비례하여 눈동자 윤곽 폴리곤 크기 미세 조절 (원근감 효과)
   - `scale_ratio`가 눈동자 폴리곤에 직접 적용되도록 수정
   - `_prepare_iris_centers` 함수에서 `scale_factor`가 눈동자 윤곽 랜드마크 변형에 적절히 반영

3. **테스트 및 디버깅**
   - `debug/debug_iris_movement.py` 파일로 변경된 눈동자 이동 로직 시각적 테스트
   - 다양한 눈동자 위치와 확대/축소 레벨에서 동작 검증

#### 7.1.2. task260120_2142 완료
morph_face_by_polygons 리팩토링 마무리:

1. **8단계: 메인 함수 리팩토링**
   - `morph_face_by_polygons` 함수를 헬퍼 함수 호출 구조로 최종 정리
   - 전체 흐름 검증

2. **9단계: 통합 테스트**
   - 모든 기능 정상 동작 확인
   - 성능 비교 (리팩토링 전후)
   - 기존 호출 코드와의 호환성 확인

### 7.2. 중기 계획

#### 7.2.1. 눈동자 관련 기능 추가
1. **눈동자 색상 변경 기능**
   - 눈동자 영역 자동 감지
   - HSV 색상 조정 슬라이더
   - 자연스러운 색상 블렌딩

2. **눈동자 크기 조절 기능**
   - 눈동자 윤곽 스케일링
   - 눈꺼풀과의 충돌 방지
   - 미리보기 기능

3. **눈동자 회전 기능**
   - 중심점 기준 회전
   - 각도 제한 (자연스러운 범위)

#### 7.2.2. 성능 최적화
1. **캐싱 전략 개선**
   - Delaunay Triangulation 캐시 최적화
   - 바운딩 박스 캐시 개선
   - LandmarkManager 캐시 효율화

2. **GPU 가속 확장**
   - 더 많은 연산을 GPU로 이전
   - CUDA/OpenCL 활용 검토

3. **메모리 사용 최적화**
   - 불필요한 복사 제거
   - 참조 관리 개선

#### 7.2.3. 사용성 개선
1. **실시간 미리보기 강화**
   - 드래그 중 실시간 변형 표시
   - 프레임률 개선

2. **실행 취소/다시 실행 기능**
   - 변경 이력 스택 구현
   - Ctrl+Z/Ctrl+Y 단축키 지원

3. **프리셋 기능**
   - 자주 사용하는 설정 저장/불러오기
   - 기본 프리셋 제공

### 7.3. 장기 계획

#### 7.3.1. AI 기반 기능
1. **AI 얼굴 보정**
   - 얼굴 대칭성 자동 보정
   - 자연스러운 표정 생성
   - 연령대별 얼굴 변환

2. **스타일 전송 개선**
   - 더 정교한 스타일 전송 알고리즘
   - 다양한 스타일 프리셋

#### 7.3.2. 일괄 처리 기능
1. **배치 편집**
   - 여러 이미지 동시 처리
   - 동일한 설정 일괄 적용

2. **자동화 스크립트**
   - Python API 제공
   - CLI 모드 지원

#### 7.3.3. 플러그인 시스템
1. **확장 가능한 구조**
   - 플러그인 인터페이스 정의
   - 서드파티 플러그인 지원

2. **커뮤니티 기능**
   - 플러그인 마켓플레이스
   - 사용자 프리셋 공유

### 7.4. 우선순위

**현재 작업 (task260122_2244) = 최우선 - 버그 수정 완료가 최우선 과제**

향후 작업 우선순위:
1. **최우선**: 버그 수정 및 회귀 테스트 (현재 작업)
2. **높음**: task260122_1910 완료 (눈동자 이동 방식 개선), task260120_2142 완료 (리팩토링 마무리)
3. **중간**: 눈동자 관련 기능 추가, 성능 최적화
4. **낮음**: AI 기반 기능, 일괄 처리, 플러그인 시스템

**중요**: 현재 버그 수정(1-7번 작업)이 완료되고 검증되기 전까지 다른 작업은 시작하지 않습니다.

### 7.5. 마일스톤

- **M1 (현재 작업 - 최우선)**: 눈동자 드래그 버그 수정 완료 및 검증 ⭐
  - 목표: 버그 완전 해결 및 회귀 테스트 통과
  - 성공 기준: 눈동자만 이동, 머리는 고정, 일반 드래그 정상 동작
  
- **M2 (1-2주)**: task260122_1910 완료, task260120_2142 완료
- **M3 (1개월)**: 눈동자 관련 기능 추가 (색상, 크기, 회전)
- **M4 (2개월)**: 성능 최적화 및 사용성 개선
- **M5 (3-6개월)**: AI 기반 기능 및 고급 기능 구현

**주의**: M1 완료 전까지 M2 이후 작업은 시작하지 않습니다.

## 8. 참고 파일

### 8.1. 수정된 파일
- `gui/face_edit/polygon_drag_handler.py`: 드래그 핸들러 (수정 완료)
  - 모든 탭에서 공통으로 사용되는 드래그 로직

### 8.2. 연동된 파일 (자동 적용)
- `gui/face_edit/polygon_renderer/all_tab_drawer.py`: All 탭 렌더러 (디폴트)
  - `_draw_all_tab_polygons` 함수에서 눈동자 중심점 렌더링
- `gui/face_edit/polygon_renderer/tab_drawers.py`: 개별 탭 렌더러
  - `_draw_iris_tab_polygons` 함수에서 눈동자 중심점 렌더링 (Eye 탭)

### 8.3. 모핑 로직
- `utils/face_morphing/polygon_morphing/core.py`: 모핑 로직
- `utils/face_morphing/integration.py`: 모핑 통합

### 8.4. 작업계획서
- `specs/task260122_2233.md`: 이전 작업계획서 (코드 수정)
- `specs/task260122_1910.md`: 눈동자 이동 방식 개선 작업계획서
- `specs/task260120_2142.md`: morph_face_by_polygons 리팩토링 작업계획서

### 8.5. 로그
- `logs/s7ed_260122.log`: 실행 로그
