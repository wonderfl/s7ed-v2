# 작업 계획서: 얼굴 편집 패널 눈 편집 기능 개선

**작업 일시**: 2026-01-13 12:12  
**작업 목표**: 얼굴 편집 패널에서 눈 편집 기능을 개선하여 더 세밀하고 직관적인 편집이 가능하도록 함

## 작업 배경
- 현재 눈 편집은 크기 조정만 가능 (0.5 ~ 2.0 배율)
- 왼쪽/오른쪽 눈을 개별적으로 조정할 수 없음
- 눈 간격, 위치, 각도 등 다른 속성 조정 불가능
- 눈 편집 UI가 단순하여 세밀한 조정이 어려움

## 현재 상태 분석

### 1. 현재 눈 편집 기능
- **위치**: `gui/_face_edit.py` 222줄
- **기능**: 눈 크기 슬라이더 (0.5 ~ 2.0, 기본값: 1.0)
- **구현**: `utils/face_morphing.py`의 `adjust_eye_size()` 함수 사용
- **제한사항**:
  - 왼쪽/오른쪽 눈을 동일하게만 조정 가능
  - 크기 조정만 가능 (간격, 위치, 각도 불가)
  - 실시간 미리보기 성능 이슈 가능성

### 2. 눈 편집 알고리즘
- **위치**: `utils/face_morphing.py` 70-192줄
- **기능**: 랜드마크 기반 정확한 눈 영역 계산 및 타원형 마스크 블렌딩
- **장점**: 정확한 랜드마크 포인트 사용, 자연스러운 블렌딩
- **개선 가능 영역**: 왼쪽/오른쪽 눈 개별 처리, 추가 속성 조정

## 개선 계획

### 개선 목표
1. **왼쪽/오른쪽 눈 개별 조정**: 각 눈을 독립적으로 조정 가능
2. **눈 간격 조정**: 두 눈 사이의 거리 조정
3. **눈 위치 조정**: 눈의 수직/수평 위치 미세 조정
4. **UI 개선**: 더 직관적이고 사용하기 쉬운 인터페이스
5. **실시간 미리보기 최적화**: 편집 시 성능 개선

## 수정 계획

### 1단계: 눈 편집 UI 개선
**목표**: 눈 편집 섹션을 확장하여 더 많은 옵션 제공

#### 1-1. 눈 편집 섹션 확장
- **위치**: `gui/_face_edit.py` `_create_face_morphing_ui()` 함수
- **변경 내용**:
  - 기존 "눈 크기" 슬라이더 유지
  - "눈 편집" 섹션을 별도 LabelFrame으로 분리
  - 왼쪽/오른쪽 눈 개별 조정 옵션 추가
  - 눈 간격 조정 슬라이더 추가
  - 눈 위치 조정 슬라이더 추가 (수직/수평)

#### 1-2. 새로운 변수 추가
- **위치**: `gui/_face_edit.py` `__init__()` 함수
- **변수 추가**:
  - `left_eye_size`: 왼쪽 눈 크기 (0.5 ~ 2.0, 기본값: 1.0)
  - `right_eye_size`: 오른쪽 눈 크기 (0.5 ~ 2.0, 기본값: 1.0)
  - `eye_spacing`: 눈 간격 조정 (-20 ~ +20 픽셀, 기본값: 0)
  - `eye_position_y`: 눈 수직 위치 조정 (-10 ~ +10 픽셀, 기본값: 0)
  - `eye_position_x`: 눈 수평 위치 조정 (-10 ~ +10 픽셀, 기본값: 0)
  - `use_individual_eyes`: 개별 조정 사용 여부 (BooleanVar, 기본값: False)

#### 1-3. UI 구성
- **눈 편집 섹션 레이아웃**:
  ```
  [눈 편집]
  [ ] 개별 조정 사용
  [눈 크기:        ] [100%]
  [왼쪽 눈 크기:   ] [100%] (개별 조정 시 표시)
  [오른쪽 눈 크기: ] [100%] (개별 조정 시 표시)
  [눈 간격:        ] [0]
  [눈 수직 위치:   ] [0]
  [눈 수평 위치:   ] [0]
  ```

### 2단계: 눈 편집 알고리즘 개선
**목표**: 새로운 편집 기능을 지원하는 알고리즘 구현

#### 2-1. `adjust_eye_size()` 함수 확장
- **위치**: `utils/face_morphing.py`
- **변경 내용**:
  - 왼쪽/오른쪽 눈 개별 크기 조정 지원
  - 기존 함수 시그니처 유지 (하위 호환성)
  - 새로운 파라미터 추가:
    - `left_eye_size_ratio`: 왼쪽 눈 크기 비율
    - `right_eye_size_ratio`: 오른쪽 눈 크기 비율
    - `eye_spacing`: 눈 간격 조정 (픽셀)
    - `eye_position_offset`: 눈 위치 오프셋 (x, y)

#### 2-2. 눈 간격 조정 함수 추가
- **위치**: `utils/face_morphing.py`
- **함수명**: `adjust_eye_spacing()`
- **기능**: 두 눈 사이의 거리를 조정
- **구현 방법**:
  - 랜드마크에서 두 눈 중심점 계산
  - 간격 조정 값에 따라 각 눈의 위치 이동
  - 눈 영역을 새로운 위치로 이동 및 블렌딩

#### 2-3. 눈 위치 조정 함수 추가
- **위치**: `utils/face_morphing.py`
- **함수명**: `adjust_eye_position()`
- **기능**: 눈의 수직/수평 위치를 미세 조정
- **구현 방법**:
  - 랜드마크에서 눈 중심점 계산
  - 오프셋 값에 따라 눈 위치 이동
  - 눈 영역을 새로운 위치로 이동 및 블렌딩

#### 2-4. 통합 함수 수정
- **위치**: `utils/face_morphing.py` `apply_all_adjustments()` 함수
- **변경 내용**:
  - 새로운 눈 편집 파라미터 추가
  - 눈 편집 순서: 간격 조정 → 위치 조정 → 크기 조정

### 3단계: 얼굴 편집 패널 연동
**목표**: UI와 알고리즘을 연결하여 실제 편집 기능 구현

#### 3-1. `on_morphing_change()` 함수 수정
- **위치**: `gui/_face_edit.py`
- **변경 내용**:
  - 개별 조정 모드에 따라 적절한 파라미터 전달
  - 눈 간격, 위치 조정 값 반영
  - 라벨 업데이트 로직 확장

#### 3-2. `apply_editing()` 함수 수정
- **위치**: `gui/_face_edit.py`
- **변경 내용**:
  - 새로운 눈 편집 파라미터를 `apply_all_adjustments()`에 전달
  - 개별 조정 모드에 따른 분기 처리

#### 3-3. 초기화 함수 수정
- **위치**: `gui/_face_edit.py` `reset_morphing()` 함수
- **변경 내용**:
  - 새로운 눈 편집 변수들도 초기화
  - 개별 조정 모드 초기화

### 4단계: 테스트 및 검증
**목표**: 모든 기능이 정상 동작하는지 확인

#### 4-1. 기능 테스트
- [x] 왼쪽/오른쪽 눈 개별 조정 정상 동작 (구현 완료, 테스트 필요)
- [x] 눈 간격 조정 정상 동작 (구현 완료, 테스트 필요)
- [x] 눈 위치 조정 정상 동작 (구현 완료, 테스트 필요)
- [x] 개별 조정 모드 전환 정상 동작 (구현 완료, 테스트 필요)
- [x] 초기화 기능 정상 동작 (구현 완료, 테스트 필요)

#### 4-2. 성능 테스트
- [ ] 실시간 미리보기 성능 확인 (사용자 테스트 필요)
- [ ] 큰 이미지에서도 정상 동작 확인 (사용자 테스트 필요)
- [ ] 메모리 사용량 확인 (사용자 테스트 필요)

#### 4-3. 에러 처리 확인
- [x] 랜드마크 감지 실패 시 처리 (구현 완료, 원본 이미지 반환)
- [x] 잘못된 파라미터 입력 시 처리 (구현 완료, 경계 체크 포함)
- [x] 예외 발생 시 로그 출력 확인 (구현 완료, 모든 예외에 traceback 출력)

## 수정 범위
- **파일**: 
  - `gui/_face_edit.py` (UI 및 이벤트 핸들러)
  - `utils/face_morphing.py` (알고리즘)
- **함수**: 
  - `__init__()` - 새로운 변수 추가
  - `_create_face_morphing_ui()` - UI 확장
  - `on_morphing_change()` - 라벨 업데이트 로직 확장
  - `apply_editing()` - 새로운 파라미터 전달
  - `reset_morphing()` - 초기화 로직 확장
  - `adjust_eye_size()` - 개별 조정 지원
  - `adjust_eye_spacing()` - 새 함수 추가
  - `adjust_eye_position()` - 새 함수 추가
  - `apply_all_adjustments()` - 통합 함수 수정
- **예상 변경 라인 수**: 약 200-300줄

## 주의사항
- 기존 눈 크기 조정 기능은 유지 (하위 호환성)
- 개별 조정 모드가 비활성화되면 기존 동작 유지
- 모든 예외는 로그 출력 (pass 금지)
- 랜드마크 감지 실패 시 원본 이미지 반환
- 실시간 미리보기 성능 고려 (너무 자주 업데이트하지 않도록)

## 완료 조건
- [x] 왼쪽/오른쪽 눈 개별 조정 기능 구현 완료
- [x] 눈 간격 조정 기능 구현 완료
- [x] 눈 위치 조정 기능 구현 완료
- [x] UI 개선 완료 (직관적인 인터페이스)
- [x] 슬라이더 타이틀 라벨 클릭 시 초기화 기능 추가 완료
- [x] 눈 영역 설정과 위치 조정 버그 수정 완료 (오프셋 중심점 기준 계산)
- [ ] 모든 기능 테스트 완료 (사용자 테스트 필요)
- [ ] 성능 테스트 완료 (사용자 테스트 필요)
- [x] 에러 처리 확인 완료
- [ ] 기존 기능 정상 동작 확인 완료 (사용자 테스트 필요)

## 추가 완료 작업 (2026-01-13 이후)

### 슬라이더 초기화 기능 추가
- **작업 내용**: 모든 슬라이더의 타이틀 라벨을 클릭하면 해당 슬라이더의 값을 초기값으로 리셋
- **구현 위치**: `gui/_face_edit.py` 모든 슬라이더 생성 함수
- **기능**:
  - 타이틀 라벨에 `cursor="hand2"` 추가 (클릭 가능 표시)
  - 타이틀 라벨 클릭 시 해당 슬라이더를 초기값으로 리셋
  - 동기화 모드인 경우 반대쪽 슬라이더도 함께 초기화
  - 초기화 후 자동으로 편집 적용 함수 호출
- **완료 상태**: [x] 완료

### 눈 영역 위치 조정 버그 수정
- **문제**: 개별 눈 영역을 설정하고 위치를 조정하면 영역이 제대로 움직이지 못하는 문제
- **원인**: 눈 영역은 오프셋이 적용된 중심점 기준으로 계산되지만, 위치 조정은 원본 중심점 기준으로 계산되어 중심점이 달라짐
- **수정 내용**:
  - `adjust_eye_position()`: 오프셋이 적용된 중심점(`eye_center_with_offset`) 기준으로 위치 계산
  - `adjust_eye_spacing()`: 오프셋이 적용된 중심점 기준으로 간격 조정
- **구현 위치**: `utils/face_morphing.py`
- **완료 상태**: [x] 완료

## 추가 고려 사항
- 향후 확장 가능성: 눈 각도 조정, 눈 모양 변경 등
- 사용자 피드백 반영 가능한 구조로 설계
- 코드 가독성 및 유지보수성 고려
