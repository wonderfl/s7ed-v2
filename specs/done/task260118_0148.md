# 작업 계획서: 눈동자 영역을 중앙 포인트만 포함하도록 수정

**작업 일시**: 2026-01-18 01:48  
**작업 목적**: Delaunay Triangulation에서 눈동자 포인트(468-477)를 각 눈동자의 중앙 포인트 2개로 대체하여 삼각형 메시 단순화 및 왜곡 감소

## 작업 배경

현재 모든 눈동자 포인트(468-477, 총 10개)가 Delaunay Triangulation에 포함되어 있어:
- 눈동자 영역의 삼각형이 복잡함
- 눈동자와 눈 영역을 연결하는 삼각형에서 왜곡 발생 가능
- 눈동자 맵핑 시 아티팩트 발생 가능

## 작업 목표

- 각 눈동자의 중앙 포인트만 Delaunay Triangulation에 포함
- 왼쪽 눈동자(468-472) → 중앙 포인트 1개
- 오른쪽 눈동자(473-477) → 중앙 포인트 1개
- 총 10개 포인트 → 2개 포인트로 감소

## 작업 단계

### 1단계: 눈동자 중앙 포인트 계산 함수 작성
**파일**: `utils/face_morphing/polygon_morphing.py`

- `_calculate_iris_centers(landmarks)` 함수 추가
  - 왼쪽 눈동자 인덱스(468-472)의 평균 좌표 계산
  - 오른쪽 눈동자 인덱스(473-477)의 평균 좌표 계산
  - 반환: (left_iris_center, right_iris_center)

### 2단계: Delaunay 호출 전 눈동자 포인트 변환
**파일**: `utils/face_morphing/polygon_morphing.py`
**함수**: `morph_face_by_polygons`

- `original_landmarks`에서 눈동자 포인트를 중앙 포인트로 변환
  - 눈동자 인덱스(468-477) 제거
  - 왼쪽 눈동자 중앙 포인트 추가 (인덱스: len(original_landmarks) - 10)
  - 오른쪽 눈동자 중앙 포인트 추가 (인덱스: len(original_landmarks) - 9)
- `transformed_landmarks`에서도 동일하게 변환
- 인덱스 매핑 정보 저장 (나중에 변형된 중앙 포인트를 원래 인덱스에 매핑하기 위해)

### 3단계: 변형된 랜드마크에서 눈동자 처리
**파일**: `gui/face_edit/morphing.py`
**함수**: `_apply_common_sliders_to_landmarks`

- 눈동자 변형 로직 수정
  - 개별 포인트 변형 대신 중앙 포인트만 변형
  - 변형된 중앙 포인트를 `updated_landmarks`에 저장
  - 인덱스는 기존 눈동자 인덱스 유지 (468-477)

### 4단계: 인덱스 매핑 처리
**파일**: `utils/face_morphing/polygon_morphing.py`

- Delaunay Triangulation에서 생성된 삼각형의 인덱스를 원래 인덱스로 매핑
- 눈동자 중앙 포인트 인덱스를 원래 눈동자 인덱스(468-477)로 매핑
- 삼각형 변환 시 올바른 포인트 참조 보장

### 5단계: 테스트 및 검증
- 눈동자 영역이 정상적으로 변형되는지 확인
- 삼각형 메시가 올바르게 생성되는지 확인
- 이미지 변형 시 아티팩트가 감소했는지 확인

## 예상 효과

1. **삼각형 메시 단순화**: 눈동자 포인트 10개 → 2개로 감소
2. **왜곡 감소**: 눈동자 영역의 삼각형이 단순해져 왜곡 가능성 감소
3. **성능 향상**: 포인트 수 감소로 계산 속도 향상
4. **안정성 향상**: 눈동자와 눈 영역을 연결하는 삼각형의 안정성 향상

## 주의사항

- 눈동자 내부의 세부 변형은 불가능 (중앙 포인트 기준 변형만 가능)
- 기존 눈동자 변형 로직과의 호환성 유지 필요
- 인덱스 매핑이 올바르게 처리되어야 함

## 작업 상태

- [x] 1단계: 눈동자 중앙 포인트 계산 함수 작성
- [x] 2단계: Delaunay 호출 전 눈동자 포인트 변환
- [x] 3단계: 변형된 랜드마크에서 눈동자 처리
- [x] 4단계: 인덱스 매핑 처리
- [x] 5단계: 테스트 및 검증
- [x] 6단계: 눈동자 중앙 포인트 드래그 기능 추가
- [x] 7단계: 중앙 포인트 표시 문제 수정

## 추가 작업 (2026-01-18)

### 6단계: 눈동자 중앙 포인트 드래그 기능 추가
**파일**: `gui/face_edit/polygon_renderer.py`, `gui/face_edit/polygon_drag_handler.py`, `gui/face_edit/landmark_display.py`

- [x] 중앙 포인트에 드래그 이벤트 바인딩
  - Tesselation 선택 시: 왼쪽/오른쪽 눈동자 중앙 포인트에 드래그 이벤트 바인딩
  - 개별 선택 시: `left_iris`/`right_iris` 선택 시 중앙 포인트에 드래그 이벤트 바인딩
- [x] 드래그 함수 추가 (`polygon_drag_handler.py`)
  - `on_iris_center_drag_start`: 드래그 시작 (특별한 인덱스 -1: 왼쪽, -2: 오른쪽)
  - `on_iris_center_drag`: 드래그 중 (모든 눈동자 포인트를 함께 이동)
  - `on_iris_center_drag_end`: 드래그 종료 (변형 적용)
- [x] 드래그 동작 구현
  - 중앙 포인트를 드래그하면 해당 눈동자의 모든 포인트(468-472 또는 473-477)가 함께 이동
  - 이동량은 중앙 포인트의 이동량과 동일
- [x] 선택 표시 처리
  - 특별한 인덱스(-1, -2)는 연결선 하이라이트 생략

### 7단계: 중앙 포인트 표시 문제 수정
**파일**: `gui/face_edit/polygon_renderer.py`, `gui/face_edit/polygon_drag_handler.py`

- [x] 중앙 포인트 표시 조건 수정
  - 중앙 포인트를 폴리곤 조건(`left_iris_points and len(left_iris_points) >= 3`)과 독립적으로 표시
  - 폴리곤이 그려지지 않아도 중앙 포인트는 표시됨
  - Tesselation 선택 시와 개별 선택 시 모두 적용
- [x] 드래그 종료 후 폴리곤 재그리기
  - 드래그 종료 후 `show_landmark_polygons`가 체크되어 있으면 `update_face_features_display()` 호출
  - 중앙 포인트 위치가 업데이트된 랜드마크 기준으로 다시 그려짐

## 작업 완료

모든 단계가 완료되었습니다. 눈동자 포인트(468-477, 10개)가 각 눈동자의 중앙 포인트 2개로 대체되어 Delaunay Triangulation에 포함됩니다.

**추가 완료 사항**:
- 눈동자 중앙 포인트 드래그 기능으로 사용자가 중앙 포인트를 직접 조작할 수 있음
- 중앙 포인트가 항상 표시되며, 드래그 후에도 올바르게 업데이트됨
