# 작업계획서: 리팩토링 및 코드 정리

**작업 일시**: 2026-01-17 18:31  
**작업 완료**: 2026-01-17 18:40  
**작업 목표**: 코드 품질 개선, 작업룰 위반 수정, 사용하지 않는 코드 정리  
**작업 상태**: 작업 1, 2 완료 (작업 3, 4는 별도 작업으로 진행 예정)

## 작업 배경

프로젝트 코드베이스를 검토한 결과, 리팩토링이 필요한 부분들이 발견되었습니다.

### 발견된 문제점

1. **작업룰 위반** (즉시 수정 필요)
   - `utils/config.py` 93줄: `except: pass` 사용 (작업룰 8번 위반)
   - `utils/kaodata_image.py` 35줄: `except: pass` 사용 (작업룰 8번 위반)
   - `main.py` 16-17줄: `except ImportError: pass` 사용 (선택적 import이지만 로그 출력 권장)
   
2. **버그 가능성** (즉시 수정 필요)
   - `main.py` 49줄: `cities` 변수 참조 오류 (정의되지 않은 변수 사용)
   
3. **사용하지 않는 코드** (정리 권장)
   - `main.py` 97-123줄: 주석 처리된 명령줄 인터페이스 코드
   - `main.py` 126-136줄: 주석 처리된 테스트 코드
   - `main.py` 87줄: `_load` 변수 정의하지만 사용하지 않음
   - `gui/gui.py` 25줄: `_value` 전역 변수 정의했지만 사용하지 않음
   - `commands/files.py` 28줄: 주석 처리된 코드 (`#_saves = "./saves"`)
   - `commands/files.py` 213-214줄: 주석 처리된 import 코드

4. **대용량 파일** (리팩토링 고려)
   - `utils/face_morphing.py`: 4,505줄 (매우 큼, 리팩토링 필요)
   - `gui/face_edit/polygon_renderer.py`: 2,060줄 (큼, 리팩토링 고려)
   - `gui/face_extract/__init__.py`: 1,242줄 (큼, 이미 리팩토링 진행 중)
   - `gui/face_edit/preview.py`: 1,226줄 (큼, 리팩토링 고려)
   - `gui/_face_similar.py`: 1,151줄 (큼, 리팩토링 고려)
   - `utils/kaodata_image.py`: 1,084줄 (큼, 리팩토링 고려)
   - `gui/face_edit/morphing.py`: 984줄 (큼, 리팩토링 고려)
   - `gui/face_edit/__init__.py`: 971줄 (큼, 리팩토링 고려)
   - `utils/face_landmarks.py`: 923줄 (큼, 리팩토링 고려)

5. **구조적 개선** (선택적)
   - `globals.py`: 전역 변수 43개로 과다, 상수와 변수 혼재
   - `gui/gui.py`: 전역 변수 `_app`, `_root` 의존성
   - GUI 모듈에서 121개 이상의 전역 변수 참조

## 작업 범위

### 작업 1: 작업룰 위반 수정 (필수)

#### 1-1. `utils/config.py` 예외 처리 개선
- **위치**: `utils/config.py` 88-93줄
- **현재 코드**:
```python
except:
    pass  # 기존 파일이 손상된 경우 무시
```
- **수정 내용**:
  - `except Exception as e:` 형식으로 변경
  - 로거를 사용하여 에러 로그 출력
  - 작업룰 8번 준수: 모든 예외는 반드시 로그 출력
- **예상 결과**: 예외 발생 시 추적 가능

#### 1-2. `utils/kaodata_image.py` 예외 처리 개선
- **위치**: `utils/kaodata_image.py` 30-36줄
- **현재 코드**:
```python
try:
    import absl.logging
    absl.logging.set_verbosity(absl.logging.ERROR)
    import logging
    logging.getLogger('absl').setLevel(logging.ERROR)
except:
    pass
```
- **수정 내용**:
  - `except Exception as e:` 형식으로 변경
  - 로거를 사용하여 에러 로그 출력 (선택적 import이므로 WARNING 레벨 권장)
  - 작업룰 8번 준수: 모든 예외는 반드시 로그 출력
- **예상 결과**: 예외 발생 시 추적 가능

#### 1-3. `main.py` ImportError 예외 처리 개선 (선택적)
- **위치**: `main.py` 16-17줄
- **현재 코드**:
```python
except ImportError:
    pass
```
- **수정 내용**:
  - 선택적 import이므로 로그 출력은 선택적이지만, 작업룰 준수를 위해 로그 출력 권장
  - `except ImportError as e:` 형식으로 변경하고 로그 출력 (DEBUG 레벨)
- **예상 결과**: 예외 발생 시 추적 가능 (선택적)

#### 1-4. `main.py` 변수 참조 오류 수정
- **위치**: `main.py` 49줄
- **현재 코드**:
```python
home = [city for city in cities if city.num == hero.city]
```
- **문제**: `cities` 변수가 정의되지 않음 (전역 변수 `globals.cities` 사용해야 함)
- **수정 내용**: `cities` → `globals.cities`로 변경
- **예상 결과**: 변수 참조 오류 해결

### 작업 2: 사용하지 않는 코드 정리 (권장)

#### 2-1. `main.py` 주석 처리된 코드 제거
- **위치**: `main.py` 97-123줄, 126-136줄
- **내용**: 
  - 명령줄 인터페이스 루프 (97-123줄): 현재는 `popup()` 실행 후 `exit()`하므로 실행되지 않음
  - 테스트 코드 (126-136줄): 주석 처리된 디버그 코드
- **수정 내용**: 주석 처리된 코드 블록 제거
- **예상 결과**: 코드 가독성 향상, 파일 크기 감소

#### 2-2. `main.py` 사용하지 않는 변수 제거
- **위치**: `main.py` 84-87줄
- **내용**: `_load` 변수 정의하지만 사용하지 않음
- **수정 내용**: 사용하지 않는 변수 제거 또는 실제 사용 여부 확인
- **예상 결과**: 불필요한 코드 제거

#### 2-3. `gui/gui.py` 사용하지 않는 변수 제거
- **위치**: `gui/gui.py` 25줄
- **내용**: `_value = ""` 전역 변수 정의했지만 사용하지 않음
- **수정 내용**: 사용하지 않는 변수 제거
- **예상 결과**: 불필요한 코드 제거

#### 2-4. `commands/files.py` 주석 처리된 코드 정리
- **위치**: `commands/files.py` 28줄, 213-214줄
- **내용**: 
  - 28줄: 주석 처리된 코드 (`#_saves = "./saves"`)
  - 213-214줄: 주석 처리된 import 코드
- **수정 내용**: 주석 처리된 코드 제거 또는 실제 사용 여부 확인 후 제거
- **예상 결과**: 코드 가독성 향상

### 작업 3: 대용량 파일 리팩토링 (선택적, 향후 검토)

#### 3-1. `utils/face_morphing.py` 리팩토링 (최우선)
- **현재**: 4,505줄 (매우 큼)
- **문제점**: 
  - 단일 파일이 너무 커서 유지보수 어려움
  - 기능별로 분리 필요
- **개선 방향**: 
  - 기능별 모듈로 분리 (예: `face_morphing_core.py`, `face_morphing_utils.py` 등)
  - 또는 클래스 기반으로 재구성
- **우선순위**: 높음 (유지보수성 향상 필요)

#### 3-2. `gui/face_edit/polygon_renderer.py` 리팩토링
- **현재**: 2,060줄 (큼)
- **개선 방향**: 기능별로 분리 또는 Mixin 패턴 적용
- **우선순위**: 중간

#### 3-3. 기타 대용량 파일 리팩토링
- `gui/face_edit/preview.py`: 1,226줄
- `gui/_face_similar.py`: 1,151줄
- `utils/kaodata_image.py`: 1,084줄
- `gui/face_edit/morphing.py`: 984줄
- `gui/face_edit/__init__.py`: 971줄
- `utils/face_landmarks.py`: 923줄
- **개선 방향**: 각 파일별로 기능 분석 후 분리 계획 수립
- **우선순위**: 낮음 (기능에는 영향 없음)

### 작업 4: 구조적 개선 (선택적, 향후 검토)

#### 4-1. `globals.py` 구조화
- **현재**: 전역 변수 43개, 상수와 변수 혼재
- **개선 방향**: 
  - 상수는 별도 모듈로 분리 (`constants.py`)
  - 전역 상태는 클래스로 관리 고려
- **우선순위**: 낮음 (기능에는 영향 없음)

#### 4-2. GUI 모듈 전역 변수 의존성 감소
- **현재**: `_app`, `_root` 전역 변수 사용
- **개선 방향**: 클래스 기반 구조로 전환
- **우선순위**: 낮음 (기능에는 영향 없음)

## 작업 단계

### 1단계: 작업룰 위반 수정 (필수)
- [x] 1-1. `utils/config.py` 예외 처리 개선
- [x] 1-2. `utils/kaodata_image.py` 예외 처리 개선
- [x] 1-3. `main.py` ImportError 예외 처리 개선 (선택적)
- [x] 1-4. `main.py` 변수 참조 오류 수정

### 2단계: 사용하지 않는 코드 정리 (권장)
- [x] 2-1. `main.py` 주석 처리된 코드 제거 (97-123줄, 126-136줄)
- [x] 2-2. `main.py` 사용하지 않는 변수 제거 (`_load`)
- [x] 2-3. `gui/gui.py` 사용하지 않는 변수 제거 (`_value`)
- [x] 2-4. `commands/files.py` 주석 처리된 코드 정리

### 3단계: 테스트 및 확인
- [x] 수정된 코드 동작 확인
- [x] 린터 에러 확인 (에러 없음)
- [x] 작업룰 준수 확인

## 우선순위

### 높음 (즉시 수정)
1. 작업 1-1: `utils/config.py` 예외 처리 개선 (작업룰 위반)
2. 작업 1-2: `utils/kaodata_image.py` 예외 처리 개선 (작업룰 위반)
3. 작업 1-4: `main.py` 변수 참조 오류 수정 (버그 가능성)

### 중간 (권장)
4. 작업 1-3: `main.py` ImportError 예외 처리 개선 (선택적)
5. 작업 2-1: `main.py` 주석 처리된 코드 제거
6. 작업 2-2: `main.py` 사용하지 않는 변수 제거
7. 작업 2-3: `gui/gui.py` 사용하지 않는 변수 제거
8. 작업 2-4: `commands/files.py` 주석 처리된 코드 정리

### 낮음 (향후 검토)
9. 작업 3-1: `utils/face_morphing.py` 리팩토링 (4,505줄, 매우 큼)
10. 작업 3-2: `gui/face_edit/polygon_renderer.py` 리팩토링 (2,060줄)
11. 작업 3-3: 기타 대용량 파일 리팩토링
12. 작업 4: 구조적 개선 (별도 작업으로 진행)

## 예상 효과

### 즉시 효과
- 작업룰 준수: 예외 처리 개선으로 에러 추적 가능
- 버그 수정: 변수 참조 오류 해결
- 코드 가독성: 사용하지 않는 코드 제거로 가독성 향상

### 장기 효과
- 유지보수성 향상: 깔끔한 코드베이스
- 버그 예방: 명확한 코드 구조

## 주의사항

1. **작업 1-1**: 예외 처리 수정 시 기존 동작 유지 (파일 손상 시 무시하되 로그 출력)
2. **작업 1-2**: 선택적 import이므로 WARNING 레벨로 로그 출력 (absl.logging이 없어도 동작해야 함)
3. **작업 1-3**: 선택적 import이므로 DEBUG 레벨로 로그 출력 권장 (absl.logging이 없어도 동작해야 함)
4. **작업 1-4**: `whoiam()` 함수가 실제로 사용되는지 확인 필요 (현재는 주석 처리된 코드에서만 호출)
5. **작업 2-1**: 주석 처리된 코드 제거 전, 향후 사용 계획이 있는지 확인 필요
6. **작업 2-2**: `_load` 변수가 향후 사용될 계획이 있는지 확인 필요

## 파일 크기 분석 결과

### 대용량 파일 목록 (500줄 이상)
1. `utils/face_morphing.py`: 4,505줄 (매우 큼, 리팩토링 필요)
2. `gui/face_edit/polygon_renderer.py`: 2,060줄 (큼)
3. `gui/face_extract/__init__.py`: 1,242줄 (큼, 이미 리팩토링 진행 중)
4. `gui/face_edit/preview.py`: 1,226줄 (큼)
5. `gui/_face_similar.py`: 1,151줄 (큼)
6. `utils/kaodata_image.py`: 1,084줄 (큼)
7. `gui/face_edit/morphing.py`: 984줄 (큼)
8. `gui/face_edit/__init__.py`: 971줄 (큼)
9. `utils/face_landmarks.py`: 923줄 (큼)
10. `gui/face_edit/slider_ui.py`: 901줄 (큼)
11. `gui/face_extract/preview.py`: 704줄 (중간)
12. `gui/face_edit/landmark_display.py`: 672줄 (중간)
13. `gui/_face_generate.py`: 579줄 (중간)
14. `gui/_item.py`: 571줄 (중간)
15. `gui/_general.py`: 532줄 (중간)
16. `commands/files.py`: 521줄 (중간)
17. `gui/face_edit/canvas.py`: 506줄 (중간)

### 권장 사항
- **500줄 이상**: 리팩토링 고려
- **1,000줄 이상**: 리팩토링 필요
- **2,000줄 이상**: 리팩토링 필수

## 검토 사항

- [ ] 작업 1 (작업룰 위반 수정)은 필수로 진행
- [ ] 작업 2 (코드 정리)는 사용자 승인 후 진행
- [ ] 작업 3 (대용량 파일 리팩토링)은 별도 작업으로 진행 여부 결정
- [ ] 작업 4 (구조적 개선)은 별도 작업으로 진행 여부 결정
