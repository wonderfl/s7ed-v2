# 작업 계획서: 얼굴 추출 패널 리팩토링

**작업 일시**: 2026-01-09 20:32
**작업 목표**: `gui/_face_extract.py` 모듈의 복잡도 감소 및 유지보수성 향상

## 작업 배경
- `gui/_face_extract.py`: 2659줄, 51개 메서드로 과도하게 커짐
- 유지보수가 어려워짐
- 기능별로 명확히 분리하여 코드 가독성 및 유지보수성 향상 필요

## 현재 상태 분석

### 파일 크기
- `gui/_face_extract.py`: 2659줄 (이전 1719줄에서 증가)
- `utils/kaodata_image.py`: 1062줄
- `gui/_face_edit.py`: 792줄
- `gui/_face_generate.py`: 579줄

### 메서드 분류 (51개)
1. **UI 생성** (7개): `_create_*` 메서드들
2. **파일 관리** (6개): `refresh_file_list`, `on_listbox_*`, `on_file_select`, `browse_file`, `load_image`
3. **이미지 처리/미리보기** (10개): `show_*`, `draw_*`, `update_palette_preview`
4. **얼굴 추출** (2개): `extract_face`, `_calculate_face_percentage`
5. **저장** (3개): `save_image`, `save_extracted_png`, `save_png`
6. **캔버스 이벤트** (3개): `on_canvas_*`
7. **설정/콜백** (10개): `on_*`, `_get_*`, `reset_*`
8. **파라미터 관리** (2개): `_load_image_params`, `_save_image_params`
9. **기타** (8개): `__init__`, `create_widgets`, `_init_label_mapping` 등

## 리팩토링 전략

### 옵션 1: Mixin 클래스 패턴 (추천)
- 기능별로 Mixin 클래스로 분리
- `FaceExtractPanel`이 여러 Mixin을 상속
- **장점**: 기능별 명확한 분리, 상태 공유 용이
- **단점**: 다중 상속 복잡성

### 옵션 2: 별도 모듈로 분리
- 각 기능을 별도 모듈로 분리
- `FaceExtractPanel`이 각 모듈의 인스턴스를 가짐
- **장점**: 파일 단위 분리, 독립적 테스트 가능
- **단점**: 상태 공유가 복잡해질 수 있음

### 옵션 3: Utils 모듈로 로직 분리
- 비즈니스 로직을 `utils` 모듈로 이동
- GUI는 UI 처리만 담당
- **장점**: 로직과 UI 분리, 재사용성 향상
- **단점**: 기존 구조와 큰 차이

## 추천 방안: Mixin 클래스 패턴

### 분리 계획

#### 1. `gui/_face_extract_file.py` - 파일 관리 Mixin
- `FileManagerMixin` 클래스
- 메서드: `refresh_file_list`, `on_listbox_*`, `on_file_select`, `browse_file`, `load_image`, `_get_or_select_extract_folder`
- 예상 크기: ~300줄

#### 2. `gui/_face_extract_preview.py` - 미리보기 관리 Mixin
- `PreviewManagerMixin` 클래스
- 메서드: `show_extracted_original`, `show_extracted_adjusted`, `show_original_preview`, `show_palette_preview`, `update_palette_preview`, `draw_grid_extracted`, `draw_face_center_marker`, `draw_crop_region_on_original`, `draw_actual_crop_region`
- 캐싱 로직 포함
- 예상 크기: ~600줄

#### 3. `gui/_face_extract_canvas.py` - 캔버스 이벤트 Mixin
- `CanvasEventHandlerMixin` 클래스
- 메서드: `on_canvas_click`, `on_canvas_drag`, `on_canvas_release`
- 예상 크기: ~150줄

#### 4. `gui/_face_extract_save.py` - 저장 기능 Mixin
- `SaveManagerMixin` 클래스
- 메서드: `save_image`, `save_extracted_png`, `save_png`
- 예상 크기: ~200줄

#### 5. `gui/_face_extract_params.py` - 파라미터 관리 Mixin
- `ParameterManagerMixin` 클래스
- 메서드: `_load_image_params`, `_save_image_params`
- 예상 크기: ~200줄

#### 6. `gui/_face_extract.py` - 메인 클래스 (리팩토링 후)
- `FaceExtractPanel` 클래스
- 모든 Mixin 상속
- UI 생성 메서드 (`_create_*`)
- 설정/콜백 메서드 (`on_*`, `_get_*`)
- 얼굴 추출 로직 (`extract_face`, `_calculate_face_percentage`)
- 예상 크기: ~1200줄 (현재 2659줄에서 약 55% 감소)

## 작업 순서

### 1단계: 파일 관리 Mixin 분리
- [ ] `gui/_face_extract_file.py` 생성
- [ ] `FileManagerMixin` 클래스 구현
- [ ] 파일 관리 관련 메서드 이동
- [ ] `FaceExtractPanel`에 Mixin 적용
- [ ] 테스트 및 검증

### 2단계: 미리보기 관리 Mixin 분리
- [ ] `gui/_face_extract_preview.py` 생성
- [ ] `PreviewManagerMixin` 클래스 구현
- [ ] 미리보기 관련 메서드 이동
- [ ] 캐싱 로직 포함
- [ ] `FaceExtractPanel`에 Mixin 적용
- [ ] 테스트 및 검증

### 3단계: 캔버스 이벤트 Mixin 분리
- [ ] `gui/_face_extract_canvas.py` 생성
- [ ] `CanvasEventHandlerMixin` 클래스 구현
- [ ] 캔버스 이벤트 메서드 이동
- [ ] `FaceExtractPanel`에 Mixin 적용
- [ ] 테스트 및 검증

### 4단계: 저장 기능 Mixin 분리
- [ ] `gui/_face_extract_save.py` 생성
- [ ] `SaveManagerMixin` 클래스 구현
- [ ] 저장 관련 메서드 이동
- [ ] `FaceExtractPanel`에 Mixin 적용
- [ ] 테스트 및 검증

### 5단계: 파라미터 관리 Mixin 분리
- [ ] `gui/_face_extract_params.py` 생성
- [ ] `ParameterManagerMixin` 클래스 구현
- [ ] 파라미터 관리 메서드 이동
- [ ] `FaceExtractPanel`에 Mixin 적용
- [ ] 테스트 및 검증

### 6단계: 메인 클래스 정리
- [ ] `FaceExtractPanel`에서 분리된 메서드 제거
- [ ] Mixin 상속 구조 정리
- [ ] 코드 정리 및 주석 추가
- [ ] 최종 테스트

## 주의사항
- 기존 기능 동작에 영향 없어야 함
- 상태 공유 (`self` 변수)가 정상적으로 동작해야 함
- 각 Mixin은 독립적으로 테스트 가능해야 함
- Exception 발생 시 pass 금지, 모든 에러는 로그 출력

## 완료 조건
- [x] 모든 Mixin 클래스 구현 완료
- [x] `FaceExtractPanel`이 모든 Mixin을 상속하여 정상 동작
- [x] 기존 기능이 모두 정상 작동
- [x] 파일 크기가 적절한 수준으로 감소 (메인 파일 ~1200줄 이하)
- [x] 코드 가독성 및 유지보수성 향상

## 완료 결과
- **원본 파일 크기**: 2659줄
- **최종 파일 크기**: 1228줄
- **감소량**: 1431줄 (약 54% 감소)
- **분리된 Mixin 파일**:
  - `gui/_face_extract_file.py`: 파일 관리 Mixin
  - `gui/_face_extract_preview.py`: 미리보기 관리 Mixin (705줄)
  - `gui/_face_extract_canvas.py`: 캔버스 이벤트 Mixin
  - `gui/_face_extract_save.py`: 저장 기능 Mixin
  - `gui/_face_extract_params.py`: 파라미터 관리 Mixin
- **불필요한 import 제거**: `glob`, `re`, `filedialog`

## 참고 사항
- 기존 작업 계획서: `specs/task260105_1600.md` (파일 분리 검토)
- 관련 모듈:
  - `gui/_face_extract.py`: 얼굴 추출 패널 (리팩토링 대상)
  - `utils/kaodata_image.py`: 이미지 처리 유틸리티
  - `utils/image_adjustments.py`: 이미지 조정 유틸리티
