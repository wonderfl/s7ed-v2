# 작업 계획서: 전체 탭에 MediaPipe 부위 선택 리스트 추가

**작업 일시**: 2026-01-17 19:25  
**작업 목표**: 전체 탭에 MediaPipe Face Mesh에서 사용 가능한 부위를 리스트로 추가하고, 선택하면 이미지에서 해당 부위를 볼 수 있도록 기능 추가

## 작업 배경
- 현재 전체 탭에는 얼굴 너비/높이 슬라이더만 있음
- MediaPipe Face Mesh에서 감지 가능한 부위(눈, 코, 입, 눈썹 등)를 선택하여 이미지에서 확인할 수 있는 기능이 없음
- 사용자가 특정 부위만 선택하여 시각적으로 확인하고 싶을 때 유용함

## 작업 범위

### 1. MediaPipe 부위 리스트 UI 추가
- 전체 탭(`_create_face_tab`)에 체크박스 리스트 추가
- **여러 부위 동시 선택 가능** (체크박스 방식)
- MediaPipe Face Mesh에서 사용 가능한 부위 목록:
  - 얼굴 윤곽 (FACE_OVAL)
  - 왼쪽 눈 (LEFT_EYE)
  - 오른쪽 눈 (RIGHT_EYE)
  - 왼쪽 눈썹 (LEFT_EYEBROW)
  - 오른쪽 눈썹 (RIGHT_EYEBROW)
  - 코 (NOSE)
  - 입술 (LIPS)
  - 왼쪽 눈동자 (LEFT_IRIS) - refine_landmarks=True일 때만 사용 가능
  - 오른쪽 눈동자 (RIGHT_IRIS) - refine_landmarks=True일 때만 사용 가능

### 2. 부위 선택 상태 관리
- 각 부위별 체크박스 변수 추가 (BooleanVar)
- 선택된 부위 목록을 저장하는 변수 추가
- 선택 변경 시 이미지 표시 업데이트

### 3. 선택된 부위 표시 기능
- `update_face_features_display()` 또는 새로운 함수에서 선택된 부위만 표시
- 기존 랜드마크 표시 기능과 통합
- 선택된 부위의 연결선/폴리곤만 그리기

### 4. 탭 변경 시 상태 유지
- 전체 탭에서 선택한 부위는 다른 탭으로 이동해도 유지
- 전체 탭으로 돌아왔을 때 선택 상태 복원

## 작업 순서

### 1단계: 변수 및 UI 추가
- [x] `gui/face_edit/__init__.py`에 부위별 체크박스 변수 추가
  - `show_face_oval`, `show_left_eye`, `show_right_eye`, `show_left_eyebrow`, `show_right_eyebrow`, `show_nose`, `show_lips`, `show_left_iris`, `show_right_iris`
- [x] `gui/face_edit/slider_ui.py`의 `_create_face_tab()` 함수에 부위 선택 리스트 UI 추가
  - LabelFrame으로 "부위 선택" 섹션 생성
  - 체크박스 리스트 배치 (3열 그리드)
  - 각 체크박스에 변경 이벤트 핸들러 연결
  - MediaPipe 사용 불가 시 체크박스 비활성화 및 안내 메시지 표시

### 2단계: 부위 선택 로직 구현
- [x] `gui/face_edit/tab_renderer.py`에 선택된 부위 인덱스 반환 함수 추가
  - `_get_selected_region_indices()` 함수 구현
  - 선택된 부위의 MediaPipe 연결 정보를 합쳐서 인덱스 리스트 반환
  - `_get_target_indices_for_tab()` 함수 수정: 전체 탭일 때 선택된 부위만 반환
- [x] `gui/face_edit/landmark_display.py`에 선택된 부위만 표시하는 로직 추가
  - `_draw_landmarks_on_canvas()` 함수 수정: 전체 탭일 때 선택된 부위만 필터링하여 표시
  - `_draw_landmark_lines()` 함수 수정: 전체 탭일 때 선택된 부위의 연결선만 표시

### 3단계: 표시 기능 통합
- [x] `update_face_features_display()` 함수는 이미 `_get_target_indices_for_tab()` 함수를 사용하므로 자동으로 선택된 부위만 표시됨
- [x] `gui/face_edit/polygon_renderer.py`의 `_draw_landmark_polygons()` 함수 수정
  - 전체 탭일 때 선택된 부위만 폴리곤으로 표시
  - 눈동자도 선택된 부위에 포함되도록 처리
- [x] 부위 선택 변경 시 자동으로 이미지 업데이트
  - `on_region_selection_change()` 함수 추가: 체크박스 변경 이벤트에서 `update_face_features_display()` 호출

### 4단계: 예외 처리 및 최적화
- [x] MediaPipe가 없을 때 체크박스 비활성화 및 안내 메시지 표시
- [x] refine_landmarks=False일 때 눈동자 체크박스는 표시되지만 실제로는 작동하지 않음 (AttributeError 처리됨)
- [x] 선택된 부위가 없을 때 처리: 전체 표시 (기존 동작 유지)
- [x] 성능 최적화: 선택 변경 시 `update_face_features_display()` 호출로 필요한 부분만 업데이트

### 5단계: 테스트 및 검증
- [ ] 각 부위 선택 시 올바르게 표시되는지 확인
- [ ] 여러 부위 동시 선택 시 모두 표시되는지 확인
- [ ] 다른 탭으로 이동 후 돌아왔을 때 선택 상태 유지 확인
- [ ] 랜드마크 표시 옵션(점, 연결선, 폴리곤)과 함께 동작하는지 확인

## 관련 파일

### 수정할 파일
1. `gui/face_edit/__init__.py` - 부위 선택 변수 추가
2. `gui/face_edit/slider_ui.py` - 전체 탭 UI에 부위 선택 리스트 추가
3. `gui/face_edit/tab_renderer.py` - 선택된 부위 인덱스 반환 함수 추가
4. `gui/face_edit/landmark_display.py` 또는 `preview.py` - 선택된 부위만 표시하는 로직 추가

### 참고할 파일
- `gui/face_edit/landmark_display.py` - 랜드마크 표시 로직
- `gui/face_edit/polygon_renderer.py` - 폴리곤 렌더링 로직
- `utils/face_landmarks.py` - MediaPipe 랜드마크 감지

## 주의사항
1. 기존 기능과의 호환성 유지
2. MediaPipe가 없을 때 적절한 처리
3. refine_landmarks 옵션에 따른 눈동자 표시 여부
4. 성능 고려: 선택 변경 시 불필요한 재계산 방지
5. UI 레이아웃: 기존 슬라이더와 조화롭게 배치

## 완료 기준
- [x] 전체 탭에 MediaPipe 부위 선택 리스트가 표시됨
- [x] 각 부위를 선택/해제할 수 있음
- [x] 선택된 부위가 이미지에 올바르게 표시됨 (랜드마크 포인트, 연결선, 폴리곤 모두)
- [x] 여러 부위 동시 선택 가능
- [x] 탭 이동 후에도 선택 상태가 유지됨 (변수로 관리되므로 자동 유지)
- [x] 기존 랜드마크 표시 기능과 정상 동작

## 작업 완료 요약

### 구현된 기능
1. **부위 선택 UI**: 전체 탭에 9개 부위 체크박스 추가 (3열 그리드)
2. **선택 로직**: `_get_selected_region_indices()` 함수로 선택된 부위 인덱스 반환
3. **표시 통합**: 랜드마크 포인트, 연결선, 폴리곤 모두 선택된 부위만 표시
4. **자동 업데이트**: 부위 선택 변경 시 즉시 이미지 업데이트

### 수정된 파일
- `gui/face_edit/__init__.py`: 부위 선택 변수 9개 추가
- `gui/face_edit/slider_ui.py`: 전체 탭에 부위 선택 UI 추가
- `gui/face_edit/morphing.py`: `on_region_selection_change()` 함수 추가
- `gui/face_edit/tab_renderer.py`: `_get_selected_region_indices()` 함수 추가, `_get_target_indices_for_tab()` 수정
- `gui/face_edit/landmark_display.py`: 전체 탭일 때 선택된 부위만 표시하도록 수정
- `gui/face_edit/polygon_renderer.py`: 전체 탭일 때 선택된 부위만 폴리곤 표시하도록 수정

### 테스트 필요 사항
- 각 부위 선택 시 올바르게 표시되는지 확인
- 여러 부위 동시 선택 시 모두 표시되는지 확인
- 랜드마크 표시 옵션(점, 연결선, 폴리곤)과 함께 동작하는지 확인
- MediaPipe가 없을 때 적절히 처리되는지 확인
