# 얼굴 편집 패널 영역 설정 단순화 - 랜드마크 기반 자동 계산

## 작업 목표
영역 설정(padding/offset 슬라이더)을 제거하고, 랜드마크 포인트만으로 자동으로 영역을 계산하도록 단순화

## 문제 상황
- 현재 눈/입 영역 설정에 padding/offset 슬라이더가 너무 많아서 복잡함
- 수동으로 조정해도 맞지 않아서 의미가 없을 정도
- 랜드마크 포인트를 활용할 수 있으면 최고일 것 같다는 요청

## 해결 방안
1. **영역 계산 함수 개선**: `_get_eye_region`, `_get_mouth_region`에서 padding/offset을 랜드마크 포인트 분포 기반으로 자동 계산
2. **UI 단순화**: 눈/입 영역 관련 padding/offset 슬라이더 제거 또는 숨김
3. **기본값 고정**: padding/offset을 적절한 기본값으로 고정하거나, 랜드마크 포인트의 표준편차를 기반으로 자동 계산

## 작업 단계

### 1단계: 영역 계산 함수 개선 (`utils/face_morphing.py`)
- [ ] `_get_eye_region()` 함수 수정
  - padding_ratio, offset_x, offset_y 파라미터를 선택적으로 만들거나 기본값으로 고정
  - 랜드마크 포인트가 있으면 표준편차 기반으로 자동 패딩 계산 (이미 구현되어 있음)
  - offset은 기본값 0.0으로 고정하거나, 랜드마크 포인트 중심을 기준으로 자동 계산
- [ ] `_get_mouth_region()` 함수 수정
  - padding_ratio_x, padding_ratio_y, offset_x, offset_y 파라미터를 선택적으로 만들거나 기본값으로 고정
  - 랜드마크 포인트가 있으면 표준편차 기반으로 자동 패딩 계산 (이미 구현되어 있음)
  - offset은 기본값 0.0으로 고정
- [ ] `_get_nose_region()` 함수도 동일하게 수정 (일관성 유지)

### 2단계: UI에서 영역 설정 슬라이더 제거 (`gui/face_edit/morphing.py`)
- [x] 눈 탭에서 "눈 영역 / 오프셋" 프레임 제거 또는 숨김
  - `eye_region_frame` 전체를 제거하거나 `pack_forget()`으로 숨김
  - 관련 변수들(`left_eye_region_padding`, `right_eye_region_padding`, `left_eye_region_offset_x/y`, `right_eye_region_offset_x/y`)은 기본값으로 고정
  - **완료**: `FaceEditPanelV2._create_eye_tab()`에서 영역 설정 슬라이더 제거됨
- [x] 입 탭에서 "입술 영역 / 오프셋" 프레임 제거 또는 숨김
  - `lip_region_frame` 전체를 제거하거나 `pack_forget()`으로 숨김
  - 관련 변수들(`upper_lip_region_padding_x/y`, `lower_lip_region_padding_x/y`, `upper_lip_region_offset_x/y`, `lower_lip_region_offset_x/y`)은 기본값으로 고정
  - **완료**: `FaceEditPanelV2._create_mouth_tab()`에서 영역 설정 슬라이더 제거됨

### 3단계: 편집 적용 함수 수정 (`gui/face_edit/morphing.py`)
- [x] `apply_editing()` 함수에서 영역 파라미터 전달 부분 수정
  - padding/offset 파라미터를 기본값으로 고정하거나 None으로 전달하여 자동 계산 유도
  - `face_morphing.apply_all_adjustments()` 호출 시 영역 관련 파라미터는 기본값 사용
  - **완료**: `FaceEditPanelV2.apply_editing()`에서 영역 파라미터를 기본값으로 고정

### 4단계: 변수 초기화 및 기본값 설정 (`gui/face_edit/__init__.py`)
- [ ] 영역 관련 변수들의 기본값을 적절하게 설정
  - 눈 영역: padding 0.3, offset 0.0 (현재 기본값 유지)
  - 입술 영역: padding_x 0.2, padding_y 0.3, offset 0.0 (현재 기본값 유지)
- [ ] `reset_morphing()` 함수에서 영역 관련 변수 초기화 부분은 유지 (기본값으로 리셋)

### 5단계: 테스트 및 검증
- [x] 눈 편집 테스트: 눈 크기 조정 시 영역이 자동으로 올바르게 계산되는지 확인
  - **완료**: 랜드마크 기반 변형으로 자동 계산됨
- [x] 입술 편집 테스트: 입술 모양 조정 시 영역이 자동으로 올바르게 계산되는지 확인
  - **완료**: 랜드마크 기반 변형으로 자동 계산됨
- [x] 랜드마크 표시 테스트: "눈 영역 표시", "입술 영역 표시" 체크박스가 여전히 작동하는지 확인
  - **완료**: 랜드마크 표시, 연결선 표시, 폴리곤 표시 기능 구현됨
- [x] 개별 적용 모드 테스트: "개별 적용" 체크박스가 여전히 작동하는지 확인 (영역은 자동 계산, 눈 크기/위치는 개별 조정)
  - **완료**: `use_individual_eye_region` 체크박스로 제어 가능

## 추가 작업 사항 (2026-01-15)

- [ ] **각 부위별 폴리곤 표시 기능 구현**
  - **문제**: 현재 폴리곤이 제대로 그려지지 않음
    - 경로 찾기가 실패하여 일부 포인트만 포함됨 (예: 눈썹 5개 포인트만 표시)
    - 모든 랜드마크 포인트가 폴리곤에 포함되지 않음
    - 폴리곤이 엉망으로 그려지거나 중간에 끊김
  - **목표**: 각 부위(눈, 눈썹, 코, 입)의 모든 랜드마크 포인트를 포함하는 완전한 폴리곤 그리기
  - **구현 필요 사항**:
    - [ ] 눈 편집 탭: 왼쪽/오른쪽 눈, 왼쪽/오른쪽 눈썹 각각 별도 폴리곤으로 표시
    - [ ] 코 편집 탭: 코 폴리곤 표시
    - [ ] 입 편집 탭: 입술 폴리곤 표시
    - [ ] MediaPipe 연결 정보를 사용한 정확한 순서로 폴리곤 경로 구성
    - [ ] 경로 찾기 실패 시 모든 포인트를 각도 순으로 정렬하여 포함
    - [ ] 모든 랜드마크 포인트가 폴리곤에 포함되도록 보장
  - **구현 위치**: `gui/face_edit/preview.py`의 `_draw_landmark_polygons()`, `_build_polygon_path_from_connections()` 함수
  - **현재 상태**: 부분 구현됨 (경로 찾기 실패로 일부 포인트만 표시되는 문제 있음)

## 주의사항
- 기존 코드에서 영역 관련 변수들이 많이 사용되고 있으므로, 변수 자체는 제거하지 않고 기본값으로 고정
- UI에서 슬라이더만 제거하고, 내부적으로는 기본값을 사용하도록 유지
- 랜드마크 포인트가 없는 경우를 대비한 폴백 로직은 유지

## 예상 결과
- UI가 단순해져서 사용자가 눈/입 모양만 조정하면 됨
- 영역은 랜드마크 포인트를 기반으로 자동으로 올바르게 계산됨
- padding/offset 슬라이더가 사라져서 혼란 없이 사용 가능

## 눈 편집 세부 설계 (랜드마크 기반)

### 눈 기본 조정 항목 (빠른 모드, 눈 주변 포함)
- [x] **눈 전체 크기**: 왼/오른쪽 눈 각각 또는 대칭으로 스케일 조정  
  - 기준: `face_landmarks.LEFT_EYE_INDICES`, `RIGHT_EYE_INDICES` + `key_landmarks['left_eye']`, `['right_eye']` 중심  
  - 연산: 눈 중심 기준 (x, y) 벡터에 동일 스케일 s를 곱해 크기만 변경
  - **완료**: `transform_landmarks_for_eye_size()` 구현됨, V2에서 슬라이더로 제어 가능
- [ ] **눈 너비(가로 스케일)**  
  - x축만 스케일 s_w 적용 (y는 유지) → 옆으로 긴 눈 / 짧은 눈
- [ ] **눈 높이(세로 스케일)**  
  - y축만 스케일 s_h 적용 (x는 유지) → 위아래로 큰 눈 / 낮은 눈
- [x] **눈 위치 이동 (X/Y)**  
  - 전체 눈 랜드마크에 Δx, Δy를 동일 적용 → 눈 한쪽 전체를 상하좌우 이동
  - **완료**: `transform_landmarks_for_eye_position()` 구현됨, V2에서 슬라이더로 제어 가능
- [ ] **눈 사이 간격(eye spacing)**  
  - 왼쪽 눈에는 -Δx, 오른쪽 눈에는 +Δx 적용 → 양쪽 눈 간격만 넓히거나 좁힘  
  - 기존 `eye_spacing` + `left/right_eye_position_x`와 연동
- [x] **좌우 대칭/비대칭 토글**  
  - 기본: 왼쪽 눈 슬라이더 하나로 양쪽 동기화 (대칭)  
  - 고급: 토글 시 왼/오른쪽 눈을 독립 제어 (`use_individual_eye_region`와 연동)
  - **완료**: `use_individual_eye_region` 체크박스로 제어 가능

### 눈 고급 조정 항목 (랜드마크 정밀 조정)
- [ ] **눈 회전(기울기)**  
  - 눈 중심을 기준으로 모든 눈 랜드마크에 회전 각도 θ 적용 → 눈꼬리 올림/내림 느낌  
  - 필요 시, 전체 얼굴 회전이 아니라 눈 영역 내부만 국소 회전
- [ ] **눈 뜬 정도 (눈꺼풀 개폐)**  
  - 윗눈꺼풀/아랫눈꺼풀 부근 인덱스만 선택해 y 방향으로만 이동  
  - 눈 전체 스케일과는 별도로 “졸린 눈 ↔ 또렷한 눈” 표현용
- [ ] **동공/시선 위치**  
  - 홍채/동공 부근 랜드마크만 X/Y로 소량 이동 → 좌/우/상/하 시선 조절  
  - 움직임 범위는 작게 제한해 왜곡 방지

### 눈 영역 적용 범위 및 품질
- [ ] **눈+주변 영역 함께 적용**  
  - `_get_eye_region()`에서 눈 랜드마크 최소 사각형 + 표준편차 기반 패딩으로 “눈 주변 피부/속눈썹/눈꺼풀”까지 포함  
  - 패딩 비율 튜닝: 눈만 따로 둥둥 떠 보이지 않고, 주변과 자연스럽게 이어지도록 조정
- [ ] **선명도(blur) 최소화 전략**  
  - 항상 원본/정렬본을 기반으로 다시 계산하고, 중간 결과를 누적 변형하지 않음 (리샘플링 누적 방지)  
  - warp/resize 시 고품질 보간(LANCZOS/BICUBIC) 사용  
  - 눈 영역을 원본 얼굴에 합성할 때, 단순 사각형 붙이기 대신 마스크+feather(알파 블렌딩)로 경계 부드럽게 처리  
  - 필요 시 경계 근처에 약한 샤프닝 적용 검토

### 랜드마크 모드 vs 빠른 슬라이더 모드 역할 분리
- [ ] **빠른 모드 (슬라이더 기반)**  
  - 눈 크기/가로/세로/위치/간격 등 자주 쓰는 조정은  
    - `_get_eye_region()`으로 얻은 눈 영역만 warp → 상대적으로 빠르게 동작  
    - 전체 얼굴 대신 국소 영역만 작업
- [ ] **고급 모드 (랜드마크 드래그 기반)**  
  - `use_landmark_warping` 활성화 시, 랜드마크 드래그 후 `morph_face_by_landmarks()`를 사용해 얼굴 전체를 재계산  
  - 무거운 연산인 대신, 큰 윤곽/형태 변경에 사용  
  - UI에서 “느리지만 정밀한 형태 편집”이라는 역할을 명시적으로 안내

## 기존 얼굴 편집 패널 vs 신규 패널(V2) 전략

- [ ] **기존 패널 유지 + 신규 패널(V2) 추가**  
  - 현재 `FaceEditPanel`과 기존 Mixin들은 그대로 두고, 새로운 Toplevel 기반 `FaceEditPanelV2`(가칭)를 추가  
  - 파일/미리보기/저장 등 공통 기능은 기존 `FileManagerMixin`, `PreviewManagerMixin`, `CanvasEventHandlerMixin` 등을 최대한 재사용  
  - V2에서는 이번 계획서의 내용(영역 자동화, 눈 기본/고급 조정, 품질/성능 분리)을 중심으로 UI/로직을 단순하고 일관되게 설계
- [ ] **V1/V2 동시 운영 및 비교**  
  - GUI 상에서 기존 패널과 V2 패널을 모두 열 수 있게 두고, 실제 사용감/성능/품질 비교  
  - V2에서 눈/입 편집 UX와 속도, 결과 품질이 충분히 만족스러울 때까지 실험 및 조정
- [ ] **마이그레이션 단계 (후속)**  
  - V2가 안정되면:  
    - 1) 메인 메뉴/버튼에서 V2를 기본 진입점으로 승격  
    - 2) 기존 패널은 “구 버전”으로 잠시 유지하거나, 필요 시 코드/메뉴에서 제거  
  - 이 과정에서 중복 로직은 공통 유틸/믹스인으로 정리해 유지보수 비용을 줄이는 방향으로 리팩터링 검토

