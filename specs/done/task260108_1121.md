# 작업 계획서: 얼굴 고급 편집 기능 추가

**작업 일시**: 2026-01-08 11:21  
**작업 목표**: 얼굴 추출 패널에 얼굴 랜드마크 감지, 얼굴 특징 보정, 스타일 전송, 얼굴 나이/성별 변환, 얼굴 생성 기능 추가

## 작업 배경
- 현재 얼굴 추출 기능은 기본적인 얼굴 감지만 수행
- 얼굴 정렬, 특징 보정, 스타일 적용 등 고급 편집 기능이 없음
- 다양한 얼굴 편집 기능을 추가하여 사용자 편의성 향상

## UI 구성 방식
- **패널 분리**: 
  - `gui/_face_edit.py`: 얼굴 편집 패널 (Phase 1, 2)
  - `gui/_face_generate.py`: 얼굴 생성 패널 (Phase 3)
- **독립적인 패널**: 각 패널이 독립적으로 동작
- **워크플로우**: 
  1. **얼굴 생성 패널** (Phase 3): 여러 얼굴 합성/파트 조합 → PNG 저장
  2. **얼굴 편집 패널** (Phase 1, 2): PNG 로드 → 랜드마크 정렬 → 특징 보정 → 스타일 전송 → 나이 변환 → PNG 저장
  3. **얼굴 추출 패널** (기존): PNG 로드 → 이미지 조정 → 팔레트 적용 → PNG 저장 → s7 저장
- **메뉴 추가**: 
  - 메인 GUI 메뉴에 "얼굴 편집..." 항목 추가
  - 메인 GUI 메뉴에 "얼굴 생성..." 항목 추가

## 이미지 프로세싱 포함 여부 결정
- **얼굴 편집 패널**: 이미지 조정 기능 제외
  - 이유: 편집 패널은 얼굴 모양/스타일 변경에 집중
  - 최종 조정은 추출 패널에서 수행 (이미지 조정 + 팔레트 적용)
- **역할 분리**:
  - 편집 패널: 얼굴 구조/스타일 편집
  - 추출 패널: 최종 조정 및 s7 준비

## 구현 우선순위 및 단계별 계획

### Phase 1: 기본 기능 (필수)
**목표**: 얼굴 정렬과 기본 편집 기능
- 얼굴 랜드마크 감지 및 자동 정렬 (기반이 되는 기능)
- 얼굴 특징 보정 (기본적인 편집)

### Phase 2: 고급 편집 (중요)
**목표**: 스타일과 나이 변환
- 스타일 전송 (색상/텍스처)
- 얼굴 나이 변환 (어리게/늙게)

### Phase 3: 얼굴 생성 (고급)
**목표**: 새 얼굴 생성
- 얼굴 합성 (Face Morphing)
- 얼굴 파트 조합

### Phase 4: 선택적 기능 (나중에)
**목표**: 추가 기능
- 성별 변환 (GAN 모델 필요)
- 랜덤 얼굴 생성 (GAN 모델 필요)
- Neural Style Transfer (고급 스타일 전송)

## 작업 범위

### 1. 얼굴 랜드마크 감지 및 자동 정렬
- 얼굴의 눈, 코, 입 등 주요 특징점 감지
- 얼굴을 표준 위치로 자동 정렬
- 얼굴 각도 보정

### 2. 얼굴 특징 보정
- 눈 크기 조정
- 코 크기 조정
- 턱선 조정
- 얼굴 너비/높이 조정

### 3. 스타일 전송
- 다른 이미지의 스타일을 현재 얼굴에 적용
- 미리 정의된 스타일 프리셋 제공

### 4. 얼굴 나이/성별 변환
- 얼굴을 어리게/늙게 변환
- 성별 변환 (선택적)

### 5. 얼굴 생성 기능
- 여러 얼굴 합성 (Face Morphing)
- 랜덤 얼굴 생성
- 템플릿 기반 얼굴 생성
- 얼굴 파트 조합 (눈, 코, 입 등 다른 얼굴에서 가져와 조합)

## 작업 순서

> **중요**: 모든 기능을 한 번에 구현하지 않고, Phase별로 나누어 단계적으로 진행합니다.
> 각 Phase가 완료되면 테스트하고, 다음 Phase로 진행합니다.

### Phase 1: 기본 기능 구현

#### 1단계: 얼굴 편집 패널 기본 구조 생성
- [x] `gui/_face_edit.py` 새 파일 생성
  - `FaceEditPanel` 클래스 생성 (tk.Toplevel 상속)
  - 기본 UI 구조 생성 (파일 선택, 미리보기, 저장 버튼)
  - 얼굴 추출 패널과 유사한 구조로 시작
- [x] 메인 GUI 메뉴에 "얼굴 편집..." 항목 추가 (`gui/gui.py`)
  - 파일 메뉴 또는 별도 메뉴에 추가
  - `show_face_edit_panel()` 함수 호출

#### 2단계: 얼굴 랜드마크 감지 라이브러리 선택 및 통합
- [x] 얼굴 랜드마크 라이브러리 조사 및 선택
  - 옵션 1: dlib (68점 랜드마크, 정확하지만 무거움)
  - 옵션 2: MediaPipe (468점 랜드마크, 가벼움, 실시간)
  - 옵션 3: face_recognition (dlib 기반, 사용하기 쉬움)
  - 추천: MediaPipe (가벼우면서도 정확함) - **선택됨**
- [x] 선택적 의존성으로 requirements.txt에 추가
- [x] `utils/face_landmarks.py` 새 모듈 생성
  - 얼굴 랜드마크 감지 함수 구현
  - 얼굴 정렬 함수 구현
- [x] 얼굴 편집 패널에 랜드마크 기반 정렬 기능 통합

#### 3단계: 얼굴 특징 보정 기능 구현
- [x] `utils/face_morphing.py` 새 모듈 생성
  - 얼굴 특징 보정 함수들 구현
  - 눈 크기 조정 함수 (OpenCV 기반 영역 확대/축소 및 블렌딩)
  - 코 크기 조정 함수 (OpenCV 기반 영역 확대/축소 및 블렌딩)
  - 턱선 조정 함수 (OpenCV 기반 영역 변형 및 블렌딩)
  - 얼굴 너비/높이 조정 함수 (OpenCV 기반 영역 확대/축소 및 블렌딩)
- [x] GUI에 얼굴 특징 보정 UI 추가 (`gui/_face_edit.py` 새 패널)
  - 눈 크기 슬라이더
  - 코 크기 슬라이더
  - 턱선 조정 슬라이더
  - 얼굴 너비/높이 슬라이더
- [x] 실시간 미리보기 업데이트

### Phase 2: 고급 편집 기능 구현

#### 4단계: 스타일 전송 기능 구현
- [x] 스타일 전송 방법 선택
  - 옵션 1: Neural Style Transfer (복잡하지만 고품질)
  - 옵션 2: 색상/텍스처 전송 (간단하고 빠름)
  - 추천: 초기에는 색상/텍스처 전송으로 시작, Neural Style Transfer는 별도 프로젝트로 분리
  - **선택됨: 색상/텍스처 전송**
- [x] `utils/style_transfer.py` 새 모듈 생성
  - 색상 히스토그램 매칭 (OpenCV 기반)
  - 텍스처 전송 (고주파 성분 추출 및 적용)
- [x] GUI에 스타일 전송 UI 추가 (`gui/_face_edit.py`)
  - 스타일 이미지 선택 버튼
  - 색상 전송 강도 슬라이더
  - 텍스처 전송 강도 슬라이더

#### 5단계: 얼굴 나이 변환 기능 구현 (성별 변환은 Phase 4로)
- [x] 나이 변환 방법 선택
  - 옵션 1: GAN 기반 모델 (고품질, 무거움)
  - 옵션 2: 얼굴 특징 변형 기반 (가벼움, 실시간)
  - 추천: 초기에는 특징 변형으로 시작
  - **선택됨: 특징 변형 기반**
- [x] `utils/face_transform.py` 새 모듈 생성
  - 얼굴을 어리게 변환 (얼굴 비율 조정, 피부 매끄럽게, 밝기 증가)
  - 얼굴을 늙게 변환 (주름 추가, 피부 질감 변경, 색상 어둡게)
- [x] GUI에 나이 변환 UI 추가 (`gui/_face_edit.py`)
  - 나이 조정 슬라이더 (-50 ~ +50 세)
  - 초기화 버튼
  - 성별 변환은 별도 프로젝트로 분리

### Phase 3: 얼굴 생성 기능 구현

#### 6단계: 얼굴 생성 패널 구현 (기본 기능만)
- [x] `gui/_face_generate.py` 새 파일 생성
  - `FaceGeneratePanel` 클래스 생성 (tk.Toplevel 상속)
  - 기본 UI 구조 생성
- [x] 얼굴 생성 방법 선택 (기본 기능만)
  - 옵션 1: 여러 얼굴 합성 (Face Morphing) - 랜드마크 기반 얼굴 블렌딩 (우선 구현)
  - 옵션 2: 얼굴 파트 조합 - 여러 얼굴에서 눈/코/입 등 선택하여 조합 (우선 구현)
  - 옵션 3: 랜덤 얼굴 생성 - 별도 프로젝트로 분리
  - 옵션 4: 템플릿 기반 - 별도 프로젝트로 분리
- [x] `utils/face_generation.py` 새 모듈 생성
  - 얼굴 합성 함수 (2개 이상 얼굴을 블렌딩)
  - 얼굴 파트 추출 함수 (눈, 코, 입 등)
  - 얼굴 파트 조합 함수 (여러 얼굴의 파트를 조합)
- [x] GUI에 얼굴 생성 UI 추가 (`gui/_face_generate.py`)
  - 얼굴 합성 모드 선택
  - 여러 얼굴 이미지 선택 (2~5개)
  - 합성 비율 조정 슬라이더 (기본 균등 가중치, 향후 확장 가능)
  - 얼굴 파트 조합 모드
  - 파트별 소스 얼굴 선택 (눈, 코, 입, 얼굴 윤곽 등)
  - 미리보기 및 저장 버튼
- [x] 메인 GUI 메뉴에 "얼굴 생성..." 항목 추가 (`gui/gui.py`)
  - 파일 메뉴 또는 별도 메뉴에 추가
  - `show_face_generate_panel()` 함수 호출

### Phase 4: 선택적 기능 (별도 프로젝트로 분리)

**결정 사항**: Phase 4 기능들은 별도 프로젝트로 분리하여 개발하기로 결정
- 랜덤 얼굴 생성 기능은 GAN 모델이 필요하고 복잡도가 높아 별도 프로젝트로 진행
- 이 프로젝트에서는 Phase 1, 2, 3까지만 구현

#### Phase 4에서 제외된 기능들 (별도 프로젝트)
- [ ] 성별 변환 기능 (GAN 모델 필요, 별도 프로젝트)
- [ ] 랜덤 얼굴 생성 (GAN 모델 필요, 별도 프로젝트)
- [ ] Neural Style Transfer (고급 스타일 전송, 별도 프로젝트)
- [ ] 템플릿 기반 얼굴 생성 (별도 프로젝트)

### 통합 및 최적화 (각 Phase 완료 후)
- [ ] 모든 기능을 얼굴 추출 파이프라인에 통합
- [ ] 처리 순서 최적화
  - 얼굴 생성/합성 → 랜드마크 감지 → 얼굴 정렬 → 특징 보정 → 스타일 전송 → 나이 변환 → 이미지 조정 → 팔레트 적용
- [ ] 성능 최적화 (캐싱, 비동기 처리 등)
- [ ] 에러 처리 강화

### 테스트 및 문서화 (각 Phase 완료 후)
- [x] 각 기능별 테스트 코드 작성 (`test/` 폴더)
  - `test/test_face_edit_phase1.py` 생성 완료
- [ ] 실제 이미지로 테스트 (사용자 테스트 필요)
- [ ] 사용자 가이드 작성 (선택적)

## 기술 스택
- Python
- PIL/Pillow (이미지 처리)
- OpenCV (기존 사용 중)
- MediaPipe 또는 dlib (얼굴 랜드마크, 선택적)
- numpy (이미 사용 중)

## 주의사항
- 모든 기능은 선택적 의존성으로 구현 (없어도 기본 기능 동작)
- Exception 발생 시 pass 금지, 모든 에러는 로그 출력
- 기존 코드와의 호환성 유지
- 성능 고려 (실시간 미리보기 가능하도록)

## 완료 조건 (Phase별)

### Phase 1 완료 조건
- [x] 얼굴 편집 패널 기본 구조 생성 완료
- [x] 얼굴 랜드마크 감지 및 자동 정렬 기능 동작
- [x] 얼굴 특징 보정 기능 동작 (눈, 코, 턱선, 얼굴 크기)
- [x] GUI에 Phase 1 기능 통합 완료
- [x] Phase 1 테스트 코드 작성 완료 (실제 테스트는 사용자 확인 필요)

### Phase 2 완료 조건
- [x] 스타일 전송 기능 동작
- [x] 얼굴 나이 변환 기능 동작
- [x] GUI에 Phase 2 기능 통합 완료
- [x] Phase 2 테스트 코드 작성 완료 (실제 테스트는 사용자 확인 필요)

### Phase 3 완료 조건
- [x] 얼굴 생성 패널 기본 구조 생성 완료
- [x] 얼굴 합성 기능 동작
- [x] 얼굴 파트 조합 기능 동작
- [x] GUI에 Phase 3 기능 통합 완료
- [x] Phase 3 기본 구조 완료 (실제 테스트는 사용자 확인 필요)

### Phase 4 완료 조건 (별도 프로젝트)
- Phase 4 기능들은 별도 프로젝트로 분리하여 개발 예정
- 이 프로젝트에서는 Phase 1, 2, 3까지만 완료

### Phase 5: 이미지 추출 개선 (추가 작업)
**목표**: 이미지 추출 시 MediaPipe를 사용하여 더 정확한 얼굴 영역 추출
- [ ] `extract_face_region` 함수에 MediaPipe 옵션 추가
  - `use_mediapipe` 파라미터 추가 (기본값: False, 기존 동작 유지)
  - MediaPipe로 랜드마크 감지 후 얼굴 영역 계산
  - 랜드마크 기반으로 눈 위치와 얼굴 크기 계산
  - MediaPipe가 없으면 기존 OpenCV 방식으로 폴백
- [ ] 기존 호출 코드와의 호환성 유지
- [ ] 테스트 및 검증

## 구현 세부사항

### 얼굴 랜드마크 감지
- MediaPipe Face Mesh 사용 (468개 랜드마크 포인트)
- 주요 포인트: 눈 (왼쪽/오른쪽), 코, 입, 얼굴 윤곽
- 얼굴 정렬: 두 눈을 수평으로 맞추고, 얼굴 중심을 기준으로 회전

### 얼굴 특징 보정
- 랜드마크 포인트를 기반으로 얼굴 영역 변형
- 눈 크기: 눈 영역 확대/축소
- 코 크기: 코 영역 확대/축소
- 턱선: 턱 영역 변형
- 얼굴 크기: 전체 얼굴 비율 조정

### 스타일 전송
- 색상 전송: 히스토그램 매칭
- 텍스처 전송: 이미지 필터링 기반

### 얼굴 나이 변환
- 어리게: 얼굴 비율 조정 (눈 크게, 얼굴 작게), 피부 매끄럽게
- 늙게: 주름 추가 (노이즈 패턴), 피부 질감 변경

### 얼굴 생성
- 얼굴 합성: 2개 이상의 얼굴을 랜드마크 기반으로 블렌딩
  - 각 얼굴의 가중치 조정 가능
  - 랜드마크 포인트를 기준으로 얼굴 정렬 후 블렌딩
- 얼굴 파트 조합: 여러 얼굴에서 파트를 선택하여 조합
  - 눈: 왼쪽 눈, 오른쪽 눈 각각 선택 가능
  - 코: 별도 선택
  - 입: 별도 선택
  - 얼굴 윤곽: 별도 선택
  - 피부: 별도 선택
- 랜덤 생성: GAN 기반 랜덤 얼굴 생성 (별도 프로젝트로 분리)

### 이미지 추출 개선
- MediaPipe를 사용한 얼굴 영역 추출
  - 랜드마크 기반으로 눈 위치와 얼굴 크기 계산
  - 기존 OpenCV Haar Cascade보다 정확도 향상
  - 기존 방식과의 호환성 유지 (옵션으로 선택 가능)
