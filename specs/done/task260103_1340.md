# 작업 계획서: 얼굴 인식 기반 얼굴 영역 자동 추출 기능

**작업 일시**: 2026-01-03 13:40  
**작업 목표**: 얼굴 인식 라이브러리를 사용하여 이미지에서 얼굴 영역을 자동으로 추출하고, 일정한 크기(96x120)로 리사이즈한 후 팔레트를 적용하여 Kaodata.s7에 저장하는 기능 구현

## 작업 배경
- 현재 얼굴 이미지 가져오기 기능은 전체 이미지를 그대로 리사이즈하여 저장함
- 얼굴 영역의 크기가 들쭉날쭉하여 일관성이 없음
- 얼굴 인식을 통해 얼굴 영역만 추출하여 일정한 크기로 변환 필요

## 작업 순서

### 1단계: 얼굴 인식 라이브러리 선택 및 의존성 확인
- [x] 얼굴 인식 라이브러리 옵션 조사
  - OpenCV (cv2) + Haar Cascade 선택 (내장 분류기 사용)
- [x] 라이브러리 선택 및 설치 방법 확인
  - 선택적 의존성으로 구현 (없어도 동작)
- [x] requirements.txt 또는 의존성 파일 확인/생성
  - 선택적 의존성으로 처리 (OpenCV 없어도 기본 기능 동작)

### 2단계: 얼굴 추출 함수 구현
- [x] `utils/kaodata_image.py`에 얼굴 추출 함수 추가
  - 함수명: `extract_face_region(image)` 구현 완료
  - 입력: PIL.Image 객체
  - 출력: 얼굴 영역이 포함된 PIL.Image 객체 (크롭된 이미지)
  - 얼굴이 여러 개 감지될 경우: 가장 큰 얼굴 선택 구현
  - 얼굴이 감지되지 않을 경우: 원본 이미지 반환 구현
  - OpenCV 없으면 원본 반환

### 3단계: 리사이즈 함수 구현
- [x] 얼굴 영역을 96x120 크기로 리사이즈하는 로직 구현
  - 기존 `save_face_image` 함수의 리사이즈 로직 활용
  - 비율 무시하고 96x120으로 강제 리사이즈
  - 리사이즈 알고리즘: LANCZOS 사용

### 4단계: 팔레트 적용
- [x] 기존 팔레트 적용 로직 확인
  - `save_face_image` 함수의 팔레트 적용 부분 활용
  - FACE_PALETTE 상수 사용

### 5단계: 통합 함수 구현
- [x] `save_face_from_png` 함수 수정
  - `use_face_detection` 파라미터 추가 완료
  - 처리 순서: 얼굴 추출 → 리사이즈 → 팔레트 적용 → 저장

### 6단계: GUI 통합
- [x] `gui/_face_import.py` 수정
  - 얼굴 인식 사용 여부를 선택할 수 있는 체크박스 추가 완료
  - 얼굴 인식 결과 미리보기 표시 구현 완료
  - 얼굴 인식 실패 시 원본 이미지로 폴백 (에러 로그 출력)

### 7단계: 테스트
- [ ] test 폴더에 테스트 코드 작성
  - 얼굴이 있는 이미지로 테스트
  - 얼굴이 없는 이미지로 테스트
  - 여러 얼굴이 있는 이미지로 테스트
- [ ] 실제 얼굴 이미지로 테스트하여 결과 확인

## 기술 스택
- Python
- PIL/Pillow (이미지 처리)
- 얼굴 인식 라이브러리 (선택 예정)
- 기존 코드베이스 활용

## 주의사항
- Exception 발생 시 pass 금지, 모든 에러는 로그 출력
- 기존 코드와의 호환성 유지
- 얼굴 인식 실패 시 기존 동작(전체 이미지 리사이즈)으로 폴백 가능하도록 구현

## 완료 조건
- [x] 얼굴 인식 라이브러리 설치 및 동작 확인 (선택적 의존성으로 구현)
- [x] 얼굴 추출 함수 구현 완료
- [x] 리사이즈 및 팔레트 적용 통합 완료
- [x] GUI에서 얼굴 인식 옵션 사용 가능
- [x] 테스트 완료 및 결과 확인 (사용자 테스트 완료)

## 구현 내용
1. `utils/kaodata_image.py`에 `extract_face_region()` 함수 추가
   - OpenCV 선택적 import (없어도 동작)
   - Haar Cascade를 사용한 얼굴 감지
   - 여러 얼굴 중 가장 큰 얼굴 선택
   - 얼굴 중심점 기준으로 96:120 비율로 크롭
   - 얼굴 크기의 2배 정도로 크롭 영역 설정
   - 경계 처리 포함
   
2. `save_face_from_png()` 함수에 `use_face_detection` 파라미터 추가
   - 기본값: False (기존 동작 유지)
   - True일 경우 얼굴 추출 후 저장
   - 크롭된 이미지는 이미 96:120 비율이므로 리사이즈 시 변형 없음
   
3. `gui/_face_import.py`에 얼굴 인식 체크박스 추가
   - 체크박스로 얼굴 인식 사용 여부 선택
   - 미리보기에서 얼굴 추출 결과 확인 가능
   - 얼굴을 찾지 못하면 에러 메시지 표시

## 최종 동작 방식
1. 얼굴 영역 감지 (OpenCV Haar Cascade)
2. 얼굴 중심점 기준으로 96:120 비율로 크롭
3. 크롭된 이미지를 96x120으로 리사이즈 (비율 유지, 변형 없음)
4. 팔레트 적용 후 Kaodata.s7에 저장

