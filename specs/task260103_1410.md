# 작업 계획서: 얼굴 추출 전용 패널 구현

**작업 일시**: 2026-01-03 14:10  
**작업 목표**: 얼굴 인식 기능을 사용하여 이미지에서 얼굴을 자동으로 추출하고 저장하는 전용 패널 구현

## 작업 배경
- 현재 얼굴 이미지 가져오기 패널은 얼굴 인식을 선택적으로 사용할 수 있음
- 얼굴 추출 전용 패널이 있으면 더 편리하게 사용 가능
- 얼굴 인식이 항상 활성화된 상태로 작동하는 간단한 패널 필요

## 작업 순서

### 1단계: 얼굴 추출 전용 패널 클래스 생성
- [x] `gui/_face_extract.py` 파일 생성
- [x] `FaceExtractPanel` 클래스 구현
  - 기존 `FaceImportPanel` 구조 참고
  - 얼굴 인식이 항상 활성화된 상태

### 2단계: UI 구성
- [x] 파일 선택 영역
  - 파일 선택 버튼
  - 선택된 파일 경로 표시
  - 파일 목록 리스트박스 (자동 새로고침)
- [x] 얼굴 영역 크기 설정 영역
  - 얼굴 영역 크기 비율 입력 (예: 200% = 얼굴 크기의 2배)
  - 기본값: 200% (얼굴 크기의 2배)
  - 슬라이더로 조정 (0.5 ~ 5.0)
- [x] 크롭 중심점 조정 영역
  - X 오프셋 조정 (좌우 이동, -200 ~ 200)
  - Y 오프셋 조정 (상하 이동, -200 ~ 200)
  - 기본값: 0, 0 (얼굴 중심점)
  - 슬라이더로 조정
  - 미리보기에서 실시간 확인 가능
- [x] 수동 영역 설정 영역 (추가 구현)
  - 수동 영역 사용 체크박스
  - X, Y, 너비, 높이 입력 필드
  - 감지된 값 적용 버튼
  - 드래그로 수동 영역 이동 기능
- [x] 미리보기 영역
  - 원본 이미지 미리보기 (96x120 비율로 크롭 표시)
  - 얼굴 추출 결과 미리보기
  - 원본 이미지에 크롭 영역 테두리 표시 (빨간색: 얼굴/수동 영역, 흰색: 실제 크롭 영역)
- [x] 저장 설정 영역
  - 얼굴 번호 입력 (0~647) - 코드 구현 완료, UI는 주석 처리됨
  - 저장 버튼 - 코드 구현 완료, UI는 주석 처리됨
  - PNG 저장 버튼 (추가 구현) - faces 폴더에 저장

### 3단계: 얼굴 추출 로직 통합
- [x] `extract_face_region()` 함수에 파라미터 추가
  - `crop_scale`: 크기 비율 파라미터 추가 (기본값: 2.0)
  - `center_offset_x`: 중심점 X 오프셋 (기본값: 0)
  - `center_offset_y`: 중심점 Y 오프셋 (기본값: 0)
  - `manual_region`: 수동 영역 지정 파라미터 추가 (기본값: None)
  - `return_face_region`: 얼굴 영역 좌표 반환 여부 (기본값: False)
  - 사용자가 지정한 비율과 오프셋으로 크롭 영역 계산
- [x] 이미지 로드 시 자동으로 얼굴 추출
- [x] 얼굴 영역 크기 비율 변경 시 자동으로 재추출
- [x] 크롭 중심점 오프셋 변경 시 자동으로 재추출
- [x] 수동 영역 변경 시 자동으로 재추출 (추가 구현)
- [x] 얼굴 추출 실패 시 수동 영역 모드로 자동 전환 (추가 구현)
- [x] 얼굴 추출 실패 시 에러 메시지 표시
- [x] 얼굴 추출 성공 시 미리보기 업데이트

### 4단계: 저장 기능 구현
- [x] 얼굴 번호 입력 검증 (코드 구현 완료, UI는 주석 처리됨)
- [x] 얼굴 추출된 이미지 저장 (코드 구현 완료, UI는 주석 처리됨)
- [x] 저장 완료 메시지 표시 (코드 구현 완료, UI는 주석 처리됨)
- [x] PNG 저장 기능 (추가 구현)
  - faces 폴더에 원본 파일명으로 저장
  - 원본 이미지와 같은 디렉토리의 faces 폴더 사용

### 5단계: 메뉴 통합
- [x] `gui/gui.py`에 메뉴 항목 추가
- [x] 패널 표시 함수 구현

## 기술 스택
- Python
- tkinter (GUI)
- PIL/Pillow (이미지 처리)
- 기존 `utils/kaodata_image.py`의 얼굴 추출 함수 활용

## 주의사항
- Exception 발생 시 pass 금지, 모든 에러는 로그 출력
- 기존 얼굴 이미지 가져오기 패널과의 차별화
- 얼굴 추출 실패 시 명확한 에러 메시지 표시

## 완료 조건
- [x] 얼굴 추출 전용 패널 구현 완료
- [x] 메뉴에서 패널 호출 가능
- [x] 얼굴 추출 및 저장 기능 정상 동작
- [ ] 테스트 완료 및 결과 확인 (사용자 테스트 필요)

## 구현 내용
1. `utils/kaodata_image.py`의 `extract_face_region()` 함수 수정
   - `crop_scale` 파라미터 추가 (기본값: 2.0)
   - `center_offset_x` 파라미터 추가 (기본값: 0)
   - `center_offset_y` 파라미터 추가 (기본값: 0)
   - `manual_region` 파라미터 추가 (수동 영역 지정, 기본값: None)
   - `return_face_region` 파라미터 추가 (얼굴 영역 좌표 반환 여부, 기본값: False)
   - 사용자 지정 비율과 오프셋으로 크롭 영역 계산
   - 수동 영역 모드 지원

2. `gui/_face_extract.py` 파일 생성
   - `FaceExtractPanel` 클래스 구현
   - 얼굴 인식이 항상 활성화된 상태
   - 크기 비율 슬라이더 (0.5 ~ 5.0, 기본값: 2.0)
   - 중심점 오프셋 슬라이더 (X, Y 각각 -200 ~ 200, 기본값: 0)
   - 실시간 미리보기 업데이트
   - 얼굴 추출 실패 시 에러 메시지 표시
   - 파일 목록 리스트박스 (자동 새로고침, 더블클릭/엔터로 선택)
   - 수동 영역 설정 기능 (추가 구현)
     - 수동 영역 사용 체크박스
     - X, Y, 너비, 높이 입력 필드
     - 감지된 값 적용 버튼
     - 드래그로 수동 영역 이동 기능 (Canvas에서 마우스 드래그)
   - 원본 이미지 미리보기에 크롭 영역 테두리 표시 (추가 구현)
     - 빨간색 테두리: 얼굴/수동 영역
     - 흰색 테두리: 실제 크롭 영역 (96x120 비율)
   - PNG 저장 기능 (추가 구현)
     - `save_png()` 함수 구현
     - faces 폴더에 원본 파일명으로 저장
     - 원본 이미지와 같은 디렉토리의 faces 폴더 자동 생성

3. `gui/gui.py` 메뉴 통합
   - "얼굴 추출..." 메뉴 항목 추가
   - File 메뉴에 배치

## 추가 구현 기능 (작업 계획서에 없었던 기능)
1. **수동 영역 설정 기능**
   - 얼굴 인식 실패 시 수동으로 영역 지정 가능
   - 감지된 얼굴 영역을 수동 영역으로 적용 가능
   - Canvas에서 드래그로 수동 영역 이동 가능
   - 수동 영역 좌표를 직접 입력 가능

2. **PNG 저장 기능**
   - 추출된 얼굴 이미지를 PNG 파일로 저장
   - 원본 이미지와 같은 디렉토리의 faces 폴더에 저장
   - 원본 파일명 유지

3. **시각적 피드백 개선**
   - 원본 이미지 미리보기에 크롭 영역 테두리 표시
   - 얼굴/수동 영역과 실제 크롭 영역을 다른 색상으로 구분
   - 실시간 미리보기 업데이트

4. **사용성 개선**
   - 파일 목록 리스트박스로 여러 이미지 관리
   - 자동 새로고침 기능
   - 키보드 단축키 지원 (더블클릭, 엔터)