# 작업 계획서: 추출한 이미지를 팔레트 색상에 적용하여 저장

**작업 일시**: 2026-01-04 14:08  
**작업 목표**: 얼굴 추출 패널에서 추출한 이미지를 게임 팔레트 색상에 맞춰서 PNG로 저장하는 기능 구현

## 작업 배경
- 현재 `save_png()` 함수는 추출된 이미지를 그대로 PNG로 저장함
- 게임에서 사용하는 팔레트 색상(FACE_PALETTE)에 맞춰서 저장하면 더 정확한 색상으로 저장 가능
- `save_face_image()` 함수는 이미 팔레트 변환을 하지만, PNG 저장 시에는 적용되지 않음
- **문제점**: 팔레트 변환 시 색상이 거칠어지거나 안 이쁜 경우가 있음
  - 단순히 가장 가까운 색으로 매핑하면 그라데이션이 깨질 수 있음
  - 디더링(dithering) 없이 변환하면 색상 전환이 부자연스러울 수 있음

## 작업 순서

### 1단계: 팔레트 색상 매핑 함수 구현
- [x] `utils/kaodata_image.py`에 RGB 이미지를 팔레트 색상에 매핑하는 함수 추가 (이미 구현됨)
  - 함수명: `convert_to_palette_colors(image, palette=FACE_PALETTE, method='quantize', dither=False)`
  - 변환 방법 옵션:
    - `'nearest'`: 가장 가까운 색으로 직접 매핑 (빠르지만 거칠 수 있음)
    - `'quantize'`: PIL의 quantize() 사용 (기본 양자화, 기본값)
    - `'dither'`: 디더링 적용 (Floyd-Steinberg 등, 부드럽지만 느릴 수 있음)
  - `dither` 파라미터: 디더링 적용 여부 (True/False)
  - 반환: 팔레트 모드 이미지 (P 모드)
  - RGB/RGBA 이미지 입력 지원

### 2단계: 미리보기 및 저장 함수 수정
- [x] `gui/_face_extract.py`에 팔레트 적용 이미지 변수 추가
  - `self.palette_applied_image`: 팔레트 적용된 이미지 저장
  - `extract_face()` 함수에서 추출 후 자동으로 팔레트 적용 버전 계산
- [x] `update_palette_preview()`, `show_palette_preview()` 함수 추가
  - 팔레트 적용 버전 미리보기 표시
  - 추출된 얼굴 미리보기 옆에 배치 (가로 3개)
- [x] `gui/_face_extract.py`의 `save_png()` 함수 확인
  - 팔레트 적용 옵션 이미 구현됨
  - 팔레트 적용 시 `palette_applied_image` 사용
  - 팔레트 적용 후 PNG로 저장

### 3단계: UI 개선
- [x] 미리보기 영역 확장 (추출된 얼굴 + 팔레트 적용 버전)
  - 원본 이미지 (왼쪽) + 추출된 얼굴 (중간) + 팔레트 적용 버전 (오른쪽)
  - 팔레트 적용 버전은 실시간으로 업데이트 (추출 시 자동 계산)
  - 각 미리보기에 라벨 추가: "추출된 얼굴", "팔레트 적용"
- [x] 팔레트 적용 옵션 UI 추가
  - 팔레트 적용 체크박스 (기본값: 체크됨)
  - 변환 방법 선택 (드롭다운)
    - 옵션: "nearest", "quantize", "dither"
    - 기본값: "quantize" (균형잡힌 선택)
  - 변환 방법 변경 시 팔레트 적용 미리보기 자동 업데이트
  - UI 위치: 얼굴 영역 설정 프레임 내부

### 4단계: 테스트 및 검증
- [ ] 팔레트 변환 함수 테스트
  - RGB 이미지 입력 시 정상 동작 확인
  - 팔레트 색상이 정확히 매핑되는지 확인
- [ ] PNG 저장 기능 테스트
  - 팔레트 적용 시 정상 저장 확인
  - 팔레트 미적용 시 원본 이미지 저장 확인
  - 저장된 이미지가 게임에서 사용 가능한지 확인

## 기술 스택
- Python
- PIL/Pillow (이미지 처리)
- numpy (색상 거리 계산, 선택사항)

## 구현 방법

### 팔레트 색상 매핑 알고리즘

#### 방법 1: 가장 가까운 색 (Nearest Color)
1. 팔레트에서 256개 색상 추출 (RGB 값)
2. 각 픽셀의 RGB 값을 팔레트의 각 색상과 비교
3. 유클리드 거리 계산: sqrt((R1-R2)^2 + (G1-G2)^2 + (B1-B2)^2)
4. 가장 가까운 팔레트 색상의 인덱스 사용
5. 팔레트 모드 이미지 생성
- 장점: 빠름, 정확한 색상 매핑
- 단점: 그라데이션이 깨질 수 있음

#### 방법 2: 양자화 (Quantize)
- PIL의 `quantize()` 메서드 사용
- 팔레트를 먼저 적용한 후 양자화
- 장점: 균형잡힌 결과
- 단점: 중간 정도의 성능

#### 방법 3: 디더링 (Dithering)
- Floyd-Steinberg 디더링 또는 PIL의 디더링 옵션 사용
- 색상 오차를 주변 픽셀로 분산시켜 부드러운 전환
- 장점: 가장 부드러운 결과, 그라데이션 유지
- 단점: 느림, 약간의 노이즈 발생 가능

### 성능 최적화
- 팔레트 색상 리스트를 미리 계산하여 캐싱
- numpy를 사용하여 벡터화된 연산 (선택사항, 성능이 중요할 경우)
- 디더링은 선택적으로만 사용

## 주의사항
- Exception 발생 시 pass 금지, 모든 에러는 로그 출력
- 팔레트 변환 시 색상 손실이 발생할 수 있음을 사용자에게 알림
- 기존 `save_face_image()` 함수의 팔레트 변환 로직과 일관성 유지
- **중요**: 사용자가 팔레트 적용 전/후를 비교할 수 있도록 미리보기 제공 권장
- 디더링은 성능이 느릴 수 있으므로 선택적으로만 사용

## 완료 조건
- [x] 팔레트 색상 매핑 함수 구현 완료 (이미 구현되어 있었음)
- [x] 얼굴 추출 시 팔레트 적용 버전 자동 계산 및 미리보기 표시
- [x] 미리보기 영역에 추출된 얼굴 + 팔레트 적용 버전 동시 표시 (가로 3개)
- [x] 변환 방법 변경 시 팔레트 미리보기 실시간 업데이트
- [x] PNG 저장 시 팔레트 적용 기능 동작 확인 (이미 구현되어 있었음)
- [ ] 저장된 이미지가 게임에서 정상적으로 표시되는지 확인 (사용자 테스트 필요)
- [ ] 테스트 완료 및 결과 확인 (사용자 테스트 필요)

## 참고사항
- `save_face_image()` 함수는 이미 팔레트 변환을 하고 있음 (229-235줄)
- 하지만 `quantize()` 방식이 최적이 아닐 수 있으므로, 더 정확한 매핑 방법 구현
- 팔레트 모드 이미지를 PNG로 저장하면 팔레트 정보가 함께 저장됨
- PIL의 `quantize()` 메서드는 `dither` 파라미터를 지원함 (Image.Dither.NONE, Image.Dither.FLOYDSTEINBERG 등)
- 사용자가 원하는 결과를 얻을 수 있도록 여러 옵션 제공이 중요함
- **UI 레이아웃**: 가로 3개 배치로 확정
  - [원본 이미지] | [추출된 얼굴] | [팔레트 적용]
  - 각 미리보기는 동일한 크기로 배치

