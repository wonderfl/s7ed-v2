# 작업 계획서: 이미지 처리 로직 리팩토링

## 작업 목표
`show_extracted_adjusted()`와 `update_palette_preview()` 함수의 중복된 이미지 처리 로직을 공통 함수로 추출하여 코드 중복을 제거하고 유지보수성을 향상시킵니다.

## 현재 문제점

### 1. 코드 중복
- `show_extracted_adjusted()`: 약 360줄
- `update_palette_preview()`: 약 400줄
- 두 함수에 거의 동일한 이미지 처리 로직이 중복됨 (약 300줄)

### 2. 유지보수 어려움
- 새로운 이미지 조정 기능 추가 시 두 곳을 모두 수정해야 함
- 버그 수정 시 두 곳을 모두 확인해야 함
- 처리 순서 변경 시 두 곳을 모두 수정해야 함

### 3. 가독성 저하
- 각 함수가 너무 길어서 이해하기 어려움
- 각 이미지 조정 단계가 개별적으로 처리되어 반복적

## 리팩토링 계획 (개선안)

### 더 적극적인 리팩토링: 별도 모듈로 분리

#### 1단계: 이미지 조정 모듈 생성
- [x] `utils/image_adjustments.py` 새 파일 생성
  - 모든 이미지 조정 함수를 이 모듈로 이동
  - 순수 함수로 구현 (GUI 의존성 제거)
  - 각 조정 함수: `apply_equalize(img, value)`, `apply_brightness(img, value)` 등

#### 2단계: 설정 기반 파이프라인
- [x] 처리 순서를 설정 리스트로 정의 (`ADJUSTMENT_PIPELINE`)
- [x] `process_image_pipeline(img, adjustments_dict, resize_before=None, resize_after=None)` 함수
  - 설정 딕셔너리를 받아서 자동으로 처리 순서대로 적용
  - 리사이즈 타이밍을 파라미터로 처리

#### 3단계: GUI 클래스 간소화
- [x] `_face_extract.py`에서 이미지 처리 로직 제거
- [x] `show_extracted_adjusted()`: 약 360줄 → 약 30줄
- [x] `update_palette_preview()`: 약 400줄 → 약 15줄 (이미지 처리 부분만)

#### 4단계: 헬퍼 함수 추가
- [x] `_get_adjustment_values()`: 모든 조정 값을 딕셔너리로 반환
- [x] `convert_to_rgb(img)`: RGB 변환 헬퍼 (image_adjustments 모듈에 포함)

## 구현 세부사항

### 이미지 조정 순서
1. RGB 변환
2. Equalize
3. (리사이즈 - update_palette_preview만)
4. Brightness
5. Contrast
6. Noise Reduction
7. Clarity
8. Dehaze
9. Saturation
10. Vibrance
11. Hue
12. Color Temp
13. Tint
14. Gamma
15. Exposure
16. (리사이즈 - show_extracted_adjusted만)
17. Sharpness
18. Vignette

### 함수 시그니처 예시
```python
def apply_equalize(self, img, value):
    """평탄화 적용"""
    if value <= 0.0:
        return img
    # ... 기존 로직 ...

def apply_image_adjustments(self, img, resize_before=None, resize_after=None):
    """이미지 조정 파이프라인"""
    # RGB 변환
    img = self.convert_to_rgb(img)
    
    # Equalize
    img = self.apply_equalize(img, self.equalize.get())
    
    # 리사이즈 (조건부)
    if resize_before:
        img = img.resize(resize_before, Image.LANCZOS)
    
    # 나머지 조정들...
    
    # 리사이즈 (조건부)
    if resize_after:
        img = img.resize(resize_after, Image.LANCZOS)
    
    return img
```

## 완료 결과

### 코드 라인 수 감소 및 모듈화
- **이전**: `_face_extract.py` 약 2400줄 (이미지 처리 로직 포함)
- **리팩토링 후**:
  - `_face_extract.py`: **1703줄** (GUI 로직만, **697줄 감소, 29% 감소**)
  - `utils/image_adjustments.py`: **389줄** (이미지 처리 로직만, 새로 생성)
  - **총 코드**: 약 2092줄 (308줄 감소, 13% 감소)
  - **모듈화로 관리 용이성 대폭 향상**

### 유지보수성 향상
- ✅ 이미지 처리 로직이 완전히 분리되어 독립적으로 테스트 가능
- ✅ 새로운 조정 기능 추가 시 `image_adjustments.py`만 수정
- ✅ GUI 로직과 이미지 처리 로직이 명확히 분리
- ✅ 다른 모듈에서도 이미지 조정 기능 재사용 가능

### 가독성 향상
- ✅ `_face_extract.py`가 훨씬 간결해짐 (각 함수 30-50줄)
- ✅ 각 함수가 단일 책임을 가짐
- ✅ 이미지 조정 로직이 명확하게 분리됨
- ✅ 설정 기반 처리로 순서 변경이 쉬움

### 추가 이점
- ✅ 순수 함수로 구현되어 단위 테스트 작성 용이
- ✅ GUI 의존성 제거로 재사용성 향상
- ✅ 코드 구조가 더 명확해짐

## 주의사항
- 기존 동작과 완전히 동일하게 유지해야 함
- 처리 순서가 중요하므로 순서 변경 시 주의
- 리사이즈 타이밍이 다르므로 파라미터로 처리
- 테스트를 통해 동작 확인 필수

