# 작업 계획서: 얼굴 추출 패널 성능 최적화

**작업 일시**: 2026-01-09 20:24
**작업 목표**: 얼굴 추출 패널의 이미지 미리보기 성능 최적화 (캐싱 기반)

## 작업 배경
- 조정 슬라이더 변경 시마다 전체 이미지 처리 파이프라인이 실행되어 성능 저하 발생
- 팔레트 변환, 이미지 조정, 원본 크롭 등이 매번 재계산됨
- 조정값이 변경되지 않았을 때도 불필요한 재계산 수행
- 사용자가 슬라이더를 빠르게 움직일 때 지연 발생

## 작업 범위

### 1. 조정 이미지 미리보기 캐싱
- `show_extracted_adjusted()` 함수 최적화
- 조정값 해시 기반 캐싱 구현
- 조정값이 변경되었을 때만 재계산

### 2. 팔레트 미리보기 캐싱
- `update_palette_preview()` 함수 최적화
- 조정값 + 팔레트 설정 해시 기반 캐싱 구현
- 조정값 또는 팔레트 설정이 변경되었을 때만 재계산

### 3. 원본 이미지 미리보기 캐싱
- `show_original_preview()` 함수 최적화
- 원본 이미지 크롭 결과 캐싱
- 이미지가 변경되지 않았을 때 재계산 방지

### 4. 랜드마크 좌표 조정 캐싱
- 랜드마크 좌표 조정 결과 캐싱
- 크롭 영역이 변경되지 않았을 때 재계산 방지

## 작업 순서

### 1단계: 캐시 변수 및 해시 함수 구현
- [x] 캐시 변수 추가
  - [x] `_adjusted_image_cache`: 조정 이미지 캐시 (해시, 이미지)
  - [x] `_palette_image_cache`: 팔레트 이미지 캐시 (해시, 이미지)
  - [x] `_original_preview_cache`: 원본 미리보기 캐시 (해시, 이미지)
  - [x] `_landmarks_adjusted_cache`: 랜드마크 좌표 조정 캐시 (해시, 좌표 리스트)
- [x] 해시 함수 구현
  - [x] `_get_adjustments_hash()`: 조정값 해시 생성
  - [x] `_get_palette_settings_hash()`: 팔레트 설정 해시 생성
  - [x] `_get_original_preview_hash()`: 원본 미리보기 해시 생성 (이미지 크기, 크롭 영역)
  - [x] `_get_landmarks_adjusted_hash()`: 랜드마크 좌표 조정 해시 생성

### 2단계: show_extracted_adjusted() 최적화
- [x] 조정값 해시 계산
- [x] 캐시 확인 및 재사용 로직 추가
- [x] 캐시 미스 시에만 이미지 처리 파이프라인 실행
- [x] 캐시 업데이트

### 3단계: update_palette_preview() 최적화
- [x] 조정값 + 팔레트 설정 해시 계산
- [x] 캐시 확인 및 재사용 로직 추가
- [x] 캐시 미스 시에만 팔레트 변환 실행
- [x] 캐시 업데이트

### 4단계: show_original_preview() 최적화
- [x] 원본 이미지 크롭 해시 계산
- [x] 캐시 확인 및 재사용 로직 추가
- [x] 캐시 미스 시에만 크롭 및 리사이즈 실행
- [x] 캐시 업데이트

### 5단계: 랜드마크 좌표 조정 캐싱
- [x] 크롭 영역 해시 계산
- [x] 랜드마크 좌표 조정 결과 캐싱
- [x] 캐시 확인 및 재사용 로직 추가
- [x] 주요 랜드마크도 캐시에 포함

### 6단계: 캐시 무효화 로직 추가
- [x] `extract_face()` 호출 시 관련 캐시 무효화
- [x] 이미지 로드 시 모든 캐시 무효화
- [x] `show_extracted_adjusted()`에서 이미지 없을 때 캐시 무효화
- [x] `show_original_preview()`에서 이미지 없을 때 캐시 무효화

## 기술 스택
- Python
- PIL/Pillow (이미지 처리)
- hashlib (해시 생성)

## 구현 세부사항

### 해시 생성 방법
- 조정값 해시: 모든 조정 슬라이더 값의 튜플을 문자열로 변환 후 해시
- 팔레트 설정 해시: 조정값 해시 + 팔레트 방법 + 디더링 여부
- 원본 미리보기 해시: 이미지 크기 + 크롭 영역 좌표

### 캐시 구조
```python
_adjusted_image_cache = {
    'hash': str,  # 조정값 해시
    'image': PIL.Image  # 처리된 이미지 (288x360)
}

_palette_image_cache = {
    'hash': str,  # 조정값 + 팔레트 설정 해시
    'image': PIL.Image  # 팔레트 적용 이미지
}

_original_preview_cache = {
    'hash': str,  # 원본 미리보기 해시
    'image': PIL.Image  # 크롭된 원본 이미지 (288x360)
}

_landmarks_adjusted_cache = {
    'hash': str,  # 크롭 영역 해시
    'landmarks': list  # 조정된 랜드마크 좌표 리스트
}
```

### 캐시 무효화 시점
- 이미지 로드 시: 모든 캐시 무효화
- `extract_face()` 호출 시: 조정 이미지 캐시, 팔레트 캐시 무효화 (원본 이미지 변경)
- 조정값 변경 시: 조정 이미지 캐시, 팔레트 캐시 무효화
- 팔레트 설정 변경 시: 팔레트 캐시만 무효화
- 원본 이미지 변경 시: 원본 미리보기 캐시, 랜드마크 캐시 무효화

## 주의사항
- 캐시 메모리 사용량 고려 (이미지가 많을 수 있음)
- 캐시 무효화 로직이 정확히 동작해야 함
- Exception 발생 시 pass 금지, 모든 에러는 로그 출력
- 기존 기능 동작에 영향 없어야 함

## 완료 조건
- [x] 모든 캐시 변수 및 해시 함수 구현 완료
- [x] `show_extracted_adjusted()` 최적화 완료
- [x] `update_palette_preview()` 최적화 완료
- [x] `show_original_preview()` 최적화 완료
- [x] 랜드마크 좌표 조정 캐싱 완료
- [x] 캐시 무효화 로직 구현 완료
- [x] 성능 개선 확인 (슬라이더 조정 시 반응 속도 향상) - 사용자 테스트 완료

## 참고 사항
- 기존 작업 계획서: `specs/task260109_1441.md` (MediaPipe 랜드마크 표시)
- 관련 모듈:
  - `gui/_face_extract.py`: 얼굴 추출 패널, 미리보기 함수들
  - `utils/image_adjustments.py`: 이미지 조정 파이프라인
  - `utils/kaodata_image.py`: 팔레트 변환 함수
