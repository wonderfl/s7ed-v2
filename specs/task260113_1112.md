# 작업 계획서: 얼굴 편집 패널 원본 이미지 보존 문제 수정

**작업 일시**: 2026-01-13 11:12  
**작업 목표**: 얼굴 편집 패널에서 정렬된 이미지가 원본 이미지를 덮어씌우는 문제를 수정하여 원본 이미지를 항상 보존하도록 개선

## 작업 배경
- 얼굴 편집 패널에서 자동 정렬 기능 사용 시 정렬된 이미지가 원본 이미지를 덮어씌움
- 원본 이미지가 손실되면 이후 편집 작업에서 문제 발생
- 원본과 편집본을 구분하여 표시해야 하는데 원본이 정렬된 이미지로 변경됨

## 발견된 문제점

### 1. `apply_alignment()` 함수의 원본 이미지 덮어쓰기
- **위치**: `gui/_face_edit.py` 572줄
- **문제**: `self.current_image = aligned_image`로 원본 이미지를 정렬된 이미지로 덮어씀
- **영향**: 원본 이미지가 손실되어 미리보기에서 원본과 편집본이 동일하게 표시됨

### 2. 중복 코드
- **위치**: `gui/_face_edit.py` 588-590줄
- **문제**: `self.edited_image = self.current_image.copy()`가 중복되어 있음
- **영향**: 코드 가독성 저하, 유지보수 어려움

### 3. `load_image()` 함수의 로직 문제
- **위치**: `gui/_face_edit.py` 470-482줄
- **문제**: 자동 정렬 시 원본 이미지가 정렬된 이미지로 변경될 수 있음
- **영향**: 원본 이미지 보존이 보장되지 않음

### 4. 이미지 미리보기 비율 조정 문제
- **위치**: `gui/_face_edit.py` 495-549줄 (`show_original_preview()`, `show_edited_preview()`)
- **문제**: `resize((288, 360))`로 강제로 288x360으로 변경하여 원본 비율이 무시됨
- **영향**: 이미지가 왜곡되어 표시됨, 원본 비율을 확인할 수 없음

### 5. 이미지 이동 기능 부재
- **위치**: `gui/_face_edit.py` 미리보기 캔버스
- **문제**: 이미지가 캔버스보다 클 때 다른 부분을 보기 위해 이동할 수 없음
- **영향**: 이미지의 일부만 확인 가능, 전체 이미지를 확인하기 어려움

### 6. UI 레이아웃 개선 필요
- **위치**: `gui/_face_edit.py` 전체 레이아웃
- **문제**: 
  - 미리보기 크기가 288x360으로 작음
  - 레이아웃이 상단(파일선택+편집설정), 하단(미리보기)로 되어 있어 공간 활용이 비효율적
- **영향**: 미리보기가 작아서 편집 결과를 확인하기 어려움, 레이아웃이 비효율적

### 7. 원본 이미지 확대/축소 기능 부재
- **위치**: `gui/_face_edit.py` 원본 이미지 미리보기
- **문제**: 원본 이미지를 확대하거나 축소할 수 없음
- **영향**: 이미지의 세부 사항을 확인하거나 전체를 보기 어려움

## 수정 계획

### 핵심 원칙
1. **원본 이미지 보존**: `self.current_image`는 항상 로드된 원본 이미지를 유지
2. **편집 이미지 분리**: `self.edited_image`는 정렬 및 편집이 적용된 이미지
3. **정렬은 편집의 일부**: 정렬도 편집의 일부로 처리하여 원본은 변경하지 않음

### 수정 내용

#### 1. `apply_alignment()` 함수 수정
- 원본 이미지(`self.current_image`)는 변경하지 않음
- 정렬된 이미지는 `self.edited_image`에만 저장
- 정렬 실패 시에도 원본 이미지는 보존

#### 2. `load_image()` 함수 수정
- 원본 이미지는 항상 `self.current_image`에 저장
- 자동 정렬이 활성화되어 있으면 정렬 후 `self.edited_image`에 저장
- 자동 정렬이 비활성화되어 있으면 원본을 `self.edited_image`에 복사

#### 3. 중복 코드 제거
- 588-590줄의 중복된 `self.edited_image = self.current_image.copy()` 제거

#### 4. 이미지 미리보기 비율 유지 수정
- `show_original_preview()`, `show_edited_preview()` 함수 수정
- 원본 비율을 유지하면서 288x360 캔버스에 맞추되, 잘리는 부분은 잘리게 함
- 비율을 조정해서 전체를 보이게 하지 않고, 원본 비율 유지하면서 스케일 조정

#### 5. 마우스 드래그로 이미지 이동 기능 추가
- 원본 이미지 캔버스와 편집된 이미지 캔버스에 드래그 기능 추가
- 마우스 드래그로 이미지를 이동하여 다른 부분 확인 가능
- 이미지 위치 추적 변수 추가 (canvas_image_pos_x, canvas_image_pos_y)
- 드래그 시작/이동/종료 이벤트 핸들러 구현
- 이미지가 캔버스보다 작으면 중앙 고정, 크면 이동 가능하도록 경계 제한

#### 6. UI 레이아웃 개선
- 미리보기 크기를 288x360에서 384x480으로 변경
- 레이아웃을 상단에 파일선택, 미리보기, 편집설정으로 가로 배치
- 미리보기 영역을 중앙에 배치하여 편집 결과를 더 잘 확인할 수 있도록 개선

#### 7. 원본 이미지 확대/축소 기능 추가
- 원본 이미지에 확대/축소 기능 추가
- 확대/축소 비율 변수 추가 (`zoom_scale`)
- 확대/축소 버튼 추가 (확대, 축소, 원래대로)
- 마우스 휠로 확대/축소 기능 (선택적)
- 확대/축소 시 이미지 위치 유지 또는 중앙 배치

## 작업 단계

### 1단계: `apply_alignment()` 함수 수정
- [x] `self.current_image = aligned_image` 라인 제거
- [x] 정렬된 이미지는 `self.edited_image`에만 저장하도록 수정
- [x] 정렬 실패 시 원본 이미지 보존 확인
- [x] 중복 코드 제거 (588-590줄)

### 2단계: `load_image()` 함수 수정
- [x] 원본 이미지는 항상 `self.current_image`에 저장
- [x] 자동 정렬 시 정렬된 이미지는 `self.edited_image`에만 저장
- [x] 자동 정렬 비활성화 시 원본을 `self.edited_image`에 복사

### 3단계: 이미지 미리보기 비율 유지 수정
- [x] `show_original_preview()` 함수 수정
  - 원본 비율을 유지하면서 288x360 캔버스에 맞추기
  - 비율이 맞지 않으면 잘리는 부분은 잘리게 처리
  - 이미지 위치 추적 변수 추가
- [x] `show_edited_preview()` 함수 수정
  - 원본 비율을 유지하면서 288x360 캔버스에 맞추기
  - 비율이 맞지 않으면 잘리는 부분은 잘리게 처리
  - 이미지 위치 추적 변수 추가

### 3-1단계: 마우스 드래그로 이미지 이동 기능 추가
- [x] 이미지 위치 추적 변수 초기화 (__init__)
  - `canvas_original_pos_x`, `canvas_original_pos_y` (원본 이미지 위치)
  - `canvas_edited_pos_x`, `canvas_edited_pos_y` (편집된 이미지 위치)
  - `canvas_original_drag_start_x`, `canvas_original_drag_start_y` (드래그 시작 위치)
  - `canvas_edited_drag_start_x`, `canvas_edited_drag_start_y` (드래그 시작 위치)
- [x] 캔버스에 마우스 이벤트 바인딩
  - `<Button-1>`: 드래그 시작
  - `<B1-Motion>`: 드래그 중
  - `<ButtonRelease-1>`: 드래그 종료
- [x] 드래그 이벤트 핸들러 구현
  - `on_canvas_original_drag_start()`: 원본 이미지 드래그 시작
  - `on_canvas_original_drag()`: 원본 이미지 드래그 중
  - `on_canvas_original_drag_end()`: 원본 이미지 드래그 종료
  - `on_canvas_edited_drag_start()`: 편집된 이미지 드래그 시작
  - `on_canvas_edited_drag()`: 편집된 이미지 드래그 중
  - `on_canvas_edited_drag_end()`: 편집된 이미지 드래그 종료
- [x] 이미지 이동 시 경계 제한 로직 구현
  - 이미지가 캔버스보다 작으면 중앙 고정
  - 이미지가 캔버스보다 크면 이동 가능하되 경계 내로 제한

### 4단계: 테스트 및 검증
- [x] 이미지 로드 시 원본 이미지가 보존되는지 확인
- [x] 자동 정렬 시 원본과 편집본이 다르게 표시되는지 확인
- [x] 정렬 실패 시에도 원본 이미지가 보존되는지 확인
- [x] 이미지 미리보기에서 원본 비율이 유지되는지 확인
- [x] 편집 기능(특징 보정, 스타일 전송, 나이 변환)이 정상 동작하는지 확인
- [x] 편집을 여러 번 적용해도 누적되지 않고 처음부터 다시 적용되는지 확인

### 5단계: UI 레이아웃 개선
- [x] 미리보기 크기를 288x360에서 384x480으로 변경
  - `_create_preview_ui()` 함수에서 preview_width, preview_height 변경
  - `show_original_preview()`, `show_edited_preview()` 함수에서 캔버스 크기 변경
  - 드래그 경계 제한 로직에서 캔버스 크기 변경
- [x] 레이아웃을 상단 가로 배치로 변경
  - `create_widgets()` 함수에서 레이아웃 구조 변경
  - 상단: 파일선택(왼쪽) + 미리보기(중앙) + 편집설정(오른쪽)
  - 하단: 상태 표시
- [x] 미리보기 레이아웃을 좌우 배치로 변경
  - 원본 이미지(왼쪽) + 편집된 이미지(오른쪽)

### 6단계: 원본 이미지 확대/축소 기능 추가
- [x] 확대/축소 비율 변수 초기화 (__init__)
  - `zoom_scale_original` (기본값: 1.0)
  - `original_image_base_size` (원본 이미지 기본 크기 저장)
- [x] 확대/축소 버튼 UI 추가
  - `_create_preview_ui()` 함수에 확대/축소 버튼 프레임 추가
  - 확대 버튼, 축소 버튼, 원래대로 버튼
- [x] 확대/축소 함수 구현
  - `zoom_in_original()`: 확대 (zoom_scale_original 증가, 최대 3배)
  - `zoom_out_original()`: 축소 (zoom_scale_original 감소, 최소 0.5배)
  - `zoom_reset_original()`: 원래대로 (zoom_scale_original = 1.0)
- [x] `show_original_preview()` 함수 수정
  - 확대/축소 비율을 적용하여 이미지 표시
  - 확대/축소 시 이미지 위치 유지
- [x] 마우스 휠로 확대/축소 기능 추가
  - 캔버스에 마우스 휠 이벤트 바인딩
- [x] 이미지 로드 시 확대/축소 초기화
  - `load_image()` 함수에서 확대/축소 비율 초기화

## 수정 범위
- **파일**: `gui/_face_edit.py`
- **함수**: 
  - `__init__()` (20-64줄) - 이미지 위치 변수 추가
  - `apply_alignment()` (556-590줄)
  - `load_image()` (470-493줄)
  - `show_original_preview()` (495-521줄)
  - `show_edited_preview()` (523-549줄)
  - 드래그 이벤트 핸들러 (새로 추가)
  - 확대/축소 함수 (새로 추가)
- **예상 변경 라인 수**: 약 120-150줄

## 주의사항
- 원본 이미지 보존이 최우선
- 기존 편집 기능에 영향이 없도록 주의
- Exception 발생 시 pass 금지, 모든 에러는 로그 출력
- 수정 후 원본과 편집본이 올바르게 구분되어 표시되는지 확인

## 완료 조건
- [x] 원본 이미지가 항상 보존됨
- [x] 정렬된 이미지가 원본을 덮어쓰지 않음
- [x] 원본과 편집본이 올바르게 구분되어 표시됨
- [x] 중복 코드 제거 완료
- [x] 이미지 미리보기에서 원본 비율이 유지됨 (비율 조정으로 전체를 보이게 하지 않음)
- [x] 마우스 드래그로 이미지 이동이 정상 동작함
- [x] 이미지가 캔버스보다 클 때 드래그로 다른 부분 확인 가능
- [x] 이미지가 캔버스보다 작을 때 중앙 고정 유지
- [x] 모든 편집 기능이 정상 동작함
- [x] 편집을 여러 번 적용해도 누적되지 않고 처음부터 다시 적용됨
- [x] 에러 처리 및 로그 출력 정상 동작
- [x] 미리보기 크기가 384x480으로 변경됨
- [x] 레이아웃이 상단 가로 배치(파일선택-미리보기-편집설정)로 변경됨
- [x] 미리보기 내부 레이아웃이 좌우 배치(원본-편집본)로 변경됨
- [x] 원본 이미지 확대/축소 기능이 정상 동작함
- [x] 확대/축소 버튼이 정상 동작함
- [x] 마우스 휠로 확대/축소 기능이 정상 동작함
- [x] 확대/축소 시 이미지가 올바르게 표시됨
- [x] 이미지 로드 시 확대/축소가 초기화됨

## 추가 수정 사항
- 편집 누적 문제 해결: `self.aligned_image` 변수를 추가하여 정렬된 이미지를 별도로 저장
- `apply_editing()` 함수가 항상 정렬된 이미지(또는 원본)를 기반으로 처음부터 다시 편집 적용
