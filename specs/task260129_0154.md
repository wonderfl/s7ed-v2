# Task 260129_0154 — Guide Axis & Advanced Tab Scaling Alignment

## 1. 배경
- 가이드축(지시선)은 최신 수정으로 확대/축소·토글·패닝 상황에서도 정상적으로 정렬됨을 확인했다.
- 그러나 **고급 모드 → 전체 탭(All tab)** 에서 `size_x / size_y` 슬라이더를 조절하면 가이드축을 기준으로 한 비례 변형이 아닌, 단순한 수평/수직 스케일이 적용된다.
- 이로 인해 사용자는 가이드축을 참조하며 전체 영역을 비틀고 싶어도 실제 변화가 축 기준과 달라 "정상 동작한 적이 없다"고 느끼게 된다.

## 2. 현재 증상 정리
1. 고급 모드 전체 탭에서 size X/Y를 조절하면 지시선이 가리키는 축이 아니라 화면 좌표계의 수평/수직 방향으로만 스케일링된다.
2. size 슬라이더 변경 시, 영역 중심/회전 정보를 무시하고 있어 가이드축 기반 회전에 맞춰 변형되길 기대하는 사용자 요구와 다르다.
3. 가이드축 자체는 정상 정렬되므로, 문제는 "영역 변형 로직과 가이드축 기준의 불일치"에 있다.

## 3. 목표
1. 고급 모드 전체 탭 size X/Y 슬라이더 조정 시, 현재 가이드축(눈 중심선/수직선)을 기준으로 비례 확대/축소가 적용되도록 한다.
2. 영역 변환 파이프라인에서 회전/중심 좌표를 명시적으로 이용하여, 지시선과 변형 결과가 동일한 기준을 공유하게 한다.
3. 필요한 경우 가이드축 계산 결과를 영역 스케일러에 전달하는 인터페이스를 정의하고 테스트 시나리오를 확보한다.
4. QA 체크리스트를 업데이트하여 “가이드축 정렬 정상 + 영역 스케일 방향 일치”를 검증한다.

## 4. 범위 및 비범위
- **포함**: 고급 모드 전체 탭 size X/Y 슬라이더, 영역 변형 로직, 가이드축 데이터 전달/적용, 관련 로그.
- **제외**: 가이드선 렌더링 자체(이미 정상), 슬라이더 UI 전반 리팩터, apply_editing 시그니처 개선(별도 Task 260128_1915).

## 5. 작업 순서
1. **현상 재현 & 데이터 캡처** – 고급 모드 전체 탭에서 size X/Y 슬라이더를 조작하며, 가이드축 각도·중심과 현재 변환 매트릭스를 로깅한다.
2. **영역 변형 파이프라인 분석** – `_apply_common_sliders_to_landmarks` 및 관련 헬퍼에서 size X/Y가 어떻게 적용되는지 추적해 회전/중심 무시 지점을 찾는다.
3. **가이드축 연동 설계** – `GuideLinesManager` 혹은 LandmarkManager에서 제공하는 선 정보(각도, 중심점)를 전체 탭 변환 로직에 주입할 인터페이스를 정의한다.
4. **변환 로직 수정** – size X/Y 슬라이더가 가이드축 벡터를 기준으로 비례 변환하도록 수식/매트릭스를 업데이트하고, 기존 수평/수직 스케일링을 대체한다.
5. **QA + 문서화** – 업데이트된 체크리스트를 실행해 결과를 기록하고, 향후 회귀 테스트에 활용할 로그/스크린샷을 정리한다.

### 5.1 단계별 구현 세부 계획

1. **현상 재현 & 데이터 캡처**
   - [x] `gui/face_edit/morphing/ui.py`에서 고급 모드 전체 탭이 활성화되도록 설정한 뒤 size X/Y를 번갈아 조정.
   - [x] `GuideLinesManager.draw_guide_lines()`와 `LandmarkManager.get_face_landmarks()`에 디버그 로그(각도, center_x/y) 추가.
   - [x] `utils/face_morphing/morphing_context.py` (실제 좌표 변환을 수행하는 헬퍼) 혹은 `_apply_common_sliders` 진입부에 현재 변환 매트릭스/슬라이더 입력을 출력하도록 임시 로그 삽입.

2. **영역 변형 파이프라인 분석**
   - [x] `gui/face_edit/morphing/logic.py`의 `_apply_common_sliders_to_landmarks` 내부에서 전체 탭 분기(예: `if current_tab == '전체'`)를 찾아 size X/Y가 어느 단계에서 `face_morphing.transform_points_for_region_size` 등으로 전달되는지 확인.
   - [x] `utils/face_morphing/polygon_morphing/core.py` 혹은 `face_morphing/adjustments/*.py`에서 size 값이 실제 좌표에 반영될 때 회전 행렬을 생략하는지 조사.
   - [x] 발견된 지점에 주석으로 현 구조 요약 + 필요한 파라미터(축 각도, 중심)를 명시.

> **분석 메모**
> - Advanced 전체 탭은 `_handle_advanced_mode` → `_apply_common_sliders_to_landmarks` → `_collect_landmark_transform_context` → `_transform_selected_landmarks` 순서로 진행된다. 이 경로에서 `scale_relative_fn`이 모든 포인트의 상대 좌표를 조정하며, 현 시점에서는 가이드축 각도만 적용되고 축 중심/길이는 지역별 중심(`_get_region_center`)를 사용한다.@gui/face_edit/morphing/logic.py#583-836
> - `_collect_landmark_transform_context`는 `self._should_use_guide_axis()`가 참일 때만 `_get_guide_axis_angle`을 호출한다. 이 각도는 `GuideLinesManager.get_eye_centers_and_angle`을 통해 계산되지만, advanced 모드에선 회전 각도만 전달되고 눈 중심(가이드축 중심) 정보는 활용되지 않는다.@gui/face_edit/morphing/logic.py#956-1035
> - 일반 모드(슬라이더)에서는 `adjust_region_size_with_axis` 등 OpenCV 기반 함수가 사용되지만, advanced 모드는 polygon morphing을 직접 호출하며 회전 행렬 로직을 갖지 않는다. 따라서 size X/Y 변화가 여전히 화면 좌표에 정렬된 축으로 작동한다.@utils/face_morphing/adjustments/region_adjustments.py#77-521
> - 위 결과를 문서화하기 위해 `_handle_advanced_mode` 호출부에 주석을 추가했다.@gui/face_edit/morphing/logic.py#583-602

3. **가이드축 연동 설계**
   - [x] `GuideLinesManager.calculate_eye_center_line()` 결과(중심점, angle)를 FaceEditPanel 상태(`current_guide_axis_info`)에 캐시하는 메서드 추가.
   - [x] `_collect_landmark_transform_context`가 `guide_axis_info`를 반환해 advanced 모드 슬라이더 경로에서 참조 가능하도록 시그니처 확장.
   - [ ] 필요한 경우 `EditingContext` dataclass(@gui/face_edit/editing_pipeline.py#7-20) 확장안을 문서화.

> **설계 메모**
> - `_get_guide_axis_info()`를 도입해 왼/오른쪽 눈 중심, 중간점, 각도를 dict로 생성하고 FaceEditPanel에 캐시했다.@gui/face_edit/morphing/logic.py#714-752
> - `_collect_landmark_transform_context()`는 `guide_axis_info` 필드를 새로 포함하며, 여기에는 angle/centers가 같이 전달된다. 후속 단계에서 `_transform_selected_landmarks`가 이 정보를 기반으로 translate→rotate→scale→inverse 회전을 수행하도록 업데이트할 예정이다.@gui/face_edit/morphing/logic.py#1012-1083

4. **변환 로직 수정**
   - [x] size X/Y 슬라이더 적용 함수(예: `face_morphing.transform_points_for_region_size`)에 회전 행렬을 추가: 
     1. [x] (x, y)를 가이드축 중심으로 translate,
     2. [x] 가이드축 angle만큼 회전,
     3. [x] X/Y 스케일 적용,
     4. [x] 다시 inverse 회전 + inverse translate.
   - [x] 기본 축 정보가 없을 경우(가이드선 비활성 등) 기존 수평/수직 스케일로 fallback하도록 가드 추가.
   - [ ] 수정 후 `landmark_manager.set_custom_landmarks()` 호출 전후로 디버그 로그를 남겨 실제 좌표 변화를 비교. *(후속 QA 단계에서 로그/스크린샷 수집 예정)*

5. **QA + 문서화**
   - [ ] 체크리스트 항목별(토글/슬라이더/옵션) 스크린샷과 로그를 `specs/task260129_0154.md`에 첨부.
   - [ ] size X/Y 연속 조작 시 가이드축 angle을 측정해 변형 후 벡터와 일치하는지 표로 정리.
   - [ ] 회귀 방지를 위해 `tests/manual/guide_axis_scaling.md`(새 파일) 초안 작성 고려.

## 7. 산출물
- 전체 탭 size X/Y 변환 로직 수정 PR (필요 시 GuideLinesManager/landmark 헬퍼 연동 포함).
- 본 문서에 원인 분석, 수식/인터페이스 변경 사항, 테스트 로그 첨부.
- QA 체크리스트 완료 결과 및 스크린샷/영상.

## 8. 리스크 및 완화
| 리스크 | 영향 | 완화 전략 |
|--------|-------|-----------|
| 가이드축/영역 로직 분리 | 기준 불일치 재발 | 공용 데이터 구조 정의, 변환 전후 단위 테스트 |
| size 슬라이더 수식 변경에 따른 회귀 | 다른 탭/옵션 영향 | 조건부 가드 및 비교 테스트, 기존 동작 스냅샷 확보 |
| 가이드라인 의존성 증가 | 렌더링 순서 복잡화 | 인터페이스 단순화, 실패 시 기본 축으로 fallback |
| QA 부족 | 회귀 재발 | 본문 체크리스트 기반 수동 테스트 + 로그 추적 |

## 9. 진행 계획
1. 고급 모드 전체 탭 size X/Y 동작 재현 및 로그 확보 (D+0).
2. 영역 변형 로직 분석/설계 문서화 (D+1).
3. 가이드축 연동 및 수식 수정 구현 (D+2).
4. QA 체크리스트 실행·로그 첨부 (D+3).
5. 최종 문서/PR 정리 및 리뷰 (D+4).
