# 랜드마크 데이터 구조 정리 작업계획서

**작성 일시**: 2026-01-19 00:21  
**작업 목적**: 랜드마크 데이터 구조 단순화 및 눈동자 데이터 분리 관리

## 작업 배경

현재 랜드마크 데이터가 너무 복잡하고 임시 변수가 많아 문제가 발생할 가능성이 높음:
- 14개 이상의 랜드마크 변수 존재
- Tesselation 선택 시 478개 → 470개 변환 로직이 복잡
- 임시 변수들이 많아 데이터 흐름 추적이 어려움
- 눈동자 데이터가 original_landmarks에 포함되어 분리가 어려움

## 작업 목표

1. 눈동자 데이터를 별도로 관리 (`_original_iris_landmarks`)
2. `_original_landmarks`는 `_original_face_landmarks`로 바꾸고 항상 468개로 고정 (기본 얼굴 랜드마크만)
3. 임시 변수 정리 및 데이터 흐름 단순화
4. Tesselation 처리 로직 단순화

## 작업 단계

### 1단계: LandmarkManager 구조 확장
- [x] `_original_face_landmarks` 필드 추가 (468개 얼굴 랜드마크)
- [x] `_original_iris_landmarks` 필드 추가 (10개 눈동자 랜드마크)
- [x] `_custom_iris_centers` 필드 추가 (2개 중앙 포인트, Tesselation용)
- [x] `set_original_face_landmarks()` 메서드 추가
- [x] `get_original_face_landmarks()` 메서드 추가
- [x] `set_original_iris_landmarks()` 메서드 추가
- [x] `get_original_iris_landmarks()` 메서드 추가
- [x] `set_custom_iris_centers()` 메서드 추가
- [x] `get_custom_iris_centers()` 메서드 추가
- [x] `get_original_landmarks_full()` 메서드 추가 (하위 호환용, 468+10=478개 반환)
- [x] `get_landmarks_for_tesselation()` 메서드 추가 (468+2=470개 반환)
- [x] `set_original_landmarks()` 메서드 수정 (하위 호환성 유지, 478개를 자동 분리)
- [x] `reset()` 메서드에 새 필드 초기화 로직 추가

**파일**: `gui/face_edit/landmark_manager.py`

### 2단계: logic.py 리팩토링
- [x] `_apply_common_sliders_to_landmarks` 함수에서 눈동자 추가 로직 제거 (428-461줄)
- [x] `original_landmarks`를 468개로 분리하여 저장 (`original_face_landmarks`)
- [x] `_original_iris_landmarks` 별도 저장
- [x] 임시 변수 정리:
  - `updated_landmarks` → 작업용으로 유지 (468개)
  - `final_landmarks` → `custom_landmarks`로 직접 저장 (468개 또는 470개)
  - `original_face_landmarks_tuple` → `original_face_landmarks` 사용 (468개)
  - `final_landmarks_no_iris` → 제거 (Tesselation 시 중앙 포인트만 추가)
  - `original_landmarks_no_iris` → 제거 (Tesselation 시 중앙 포인트만 추가)
  - `final_landmarks_for_custom` → `custom_landmarks`로 직접 저장 (468개 또는 470개)
  - `original_landmarks_for_morph` → `get_landmarks_for_tesselation()` 사용 (470개)
  - `landmarks_for_drawing` → 3단계에서 파라미터 분리
- [x] Tesselation 처리 로직 단순화 (눈동자 제거 불필요, 중앙 포인트만 추가)

**파일**: `gui/face_edit/morphing/logic.py`

### 3단계: 다른 파일 수정 (필요시)
- [x] `drawing.py`: 
  - `_draw_landmark_polygons` 함수 시그니처 변경:
    - 기존: `landmarks` 파라미터 하나 (478개 또는 470개)
    - 변경: `face_landmarks` (468개), `iris_landmarks` (10개 또는 None), `iris_centers` (2개 또는 None, Tesselation용)
  - 하위 호환성 유지: `landmarks` 파라미터도 받아서 내부에서 처리
  - `iris_centers` 파라미터 활용 로직 추가
  - `use_custom` 로직 단순화
- [x] `all_tab_drawer.py`: 
  - `len(landmarks) > 468` 체크 제거 (파라미터로 명확히 구분)
  - `draw_iris` 함수에서 `iris_landmarks`, `iris_centers` 파라미터 활용
  - `use_custom` 로직 단순화
- [x] `landmark_display.py`: 
  - `len(landmarks) > 468` 체크를 LandmarkManager 기반으로 변경
  - 하위 호환성 유지 (기존 방식도 지원)
- [x] `tab_drawers.py`: 
  - `len(landmarks) > 468` 체크를 LandmarkManager 기반으로 변경
  - 하위 호환성 유지 (기존 방식도 지원)
  - `_draw_iris_tab_polygons` 함수에 `iris_centers` 파라미터 추가 (Tesselation 모드 지원)
- [x] 호출부 수정:
  - [x] `logic.py`: `face_landmarks`, `iris_landmarks`, `iris_centers` 전달
  - [x] `drawing.py`: `_draw_iris_tab_polygons` 호출 시 `iris_centers` 전달
  - [ ] `__init__.py`: 하위 호환성 유지 (기존 방식 그대로 사용 가능)
  - [ ] `morphing/utils.py`: 하위 호환성 유지 (기존 방식 그대로 사용 가능)
  - [ ] `morphing/handlers.py`: 하위 호환성 유지 (기존 방식 그대로 사용 가능)
  - [ ] 기타 호출부: 하위 호환성 유지 (기존 방식 그대로 사용 가능)
- [x] 기타 파일: 하드코딩된 478개 체크 확인 및 수정 완료
- [x] Tesselation 모드에서 눈동자 중심점 그리기 지원:
  - [x] 전체탭: `all_tab_drawer.py`에서 Tesselation 선택 시 `iris_centers` 활용
  - [x] 눈동자 탭: `tab_drawers.py`에서 `iris_centers` 파라미터 추가 및 활용

**파일**: `gui/face_edit/polygon_renderer/*.py`, `gui/face_edit/landmark_display.py`, 모든 호출부 등

**참고**: 하위 호환성을 위해 기존 호출부는 그대로 동작하도록 구현했습니다. 점진적으로 파라미터 분리 방식으로 전환할 수 있습니다.

### 4단계: 테스트 및 검증
- [x] LandmarkManager 기본 기능 테스트 (통과)
  - 얼굴 랜드마크 설정/조회 (468개)
  - 눈동자 랜드마크 설정/조회 (10개)
  - 전체 랜드마크 조회 (478개)
  - 중앙 포인트 설정/조회 (2개)
  - Tesselation용 랜드마크 조회 (470개)
  - 하위 호환성 테스트 (478개 자동 분리)
- [x] 함수 시그니처 변경 확인
  - `_draw_landmark_polygons`: `face_landmarks`, `iris_landmarks`, `iris_centers` 파라미터 추가
  - `draw_iris`: `iris_landmarks`, `iris_centers` 파라미터 활용
- [x] 린터 오류 확인 (없음)
- [x] 기본 얼굴 편집 기능 테스트 (실제 실행 완료)
- [x] Tesselation 선택 시 동작 테스트 (실제 실행 완료)
- [x] 눈동자 드래그 기능 테스트 (실제 실행 완료)
- [x] 폴리곤 그리기 기능 테스트 (실제 실행 완료)

### 5단계: 폴리곤 드래그 기능 버그 수정 (2026-01-19 13:58)

리팩토링 과정에서 발견된 폴리곤 드래그 기능의 버그를 수정했습니다.

#### 발견된 문제
1. 폴리곤 포인트를 선택은 되는데 드래그가 안 됨
2. 드래그는 잘 되는데 수정하고 나면 되돌아감
3. 다른 포인트를 수정하면 이전에 수정한게 되돌아감

#### 수정 내용

**1. 폴리곤 포인트 드래그 동작 문제 수정**
- **파일**: `gui/face_edit/polygon_drag_handler.py`
- **문제**: `on_polygon_drag` 함수에서 정수 `landmark_index`일 때 랜드마크 위치는 업데이트되지만, 선택된 포인트 표시 업데이트가 `elif isinstance(landmark_index, str):` 블록 안에 있어서 실행되지 않음
- **수정**: 
  - [x] 정수 `landmark_index`일 때도 선택된 포인트 표시를 업데이트하도록 수정
  - [x] `elif` 블록의 잘못된 코드 정리

**2. 드래그 후 원래 위치로 되돌아가는 문제 수정**
- **파일**: `gui/face_edit/polygon_drag_handler.py`, `gui/face_edit/morphing/logic.py`
- **문제**: 
  - `apply_polygon_drag_final`에서 슬라이더가 기본값이면 무조건 `custom_landmarks`를 원본으로 복원하는 로직이 드래그 변경을 덮어씀
  - `_apply_common_sliders_to_landmarks`가 항상 원본 랜드마크를 기준으로 슬라이더 변형을 적용하여 드래그 변경이 사라짐
- **수정**: 
  - [x] `apply_polygon_drag_final`에서 랜드마크가 변형되었는지 먼저 확인하고, 변형되지 않았을 때만 원본으로 복원
  - [x] `_apply_common_sliders_to_landmarks`에서 `custom_landmarks`가 있으면 그것을 기준으로 사용하도록 수정

**3. 다른 포인트 수정 시 이전 변경이 되돌아가는 문제 수정**
- **파일**: `gui/face_edit/morphing/logic.py`
- **문제**: 슬라이더 변형을 적용할 때 드래그로 변경된 포인트도 함께 변형되어 원래 위치로 되돌아감
- **수정**: 
  - [x] 드래그로 변경된 포인트 추적: 원본 랜드마크와 `custom_landmarks`를 비교하여 차이가 0.5픽셀 이상인 포인트를 드래그로 변경된 것으로 간주
  - [x] 슬라이더 변형 적용 시 드래그 포인트 제외: 일반 부위 변형과 Tesselation 변형 모두에서 드래그로 변경된 포인트는 건너뛰기

#### 수정된 파일
1. `gui/face_edit/polygon_drag_handler.py`
   - `on_polygon_drag`: 선택된 포인트 표시 업데이트 로직 수정
   - `apply_polygon_drag_final`: 드래그 변경 보존 로직 수정

2. `gui/face_edit/morphing/logic.py`
   - `_apply_common_sliders_to_landmarks`: 드래그 변경된 포인트 추적 및 보존 로직 추가

#### 테스트 결과
- [x] 폴리곤 포인트 드래그로 이동 가능
- [x] 드래그 종료 후 변경 사항 유지
- [x] 이미지 변형(morphing)에 정상 반영
- [x] 다른 포인트 수정 시 이전 변경 사항 유지

#### 발견된 잠재적 버그 (추가 확인 필요)

**1. 사이즈 변경 시 드래그 변경 덮어쓰기 문제**
- **위치**: `gui/face_edit/morphing/editing_steps.py` 212줄
- **문제**: 사이즈 변경이 있으면 `custom_landmarks`를 `transformed_landmarks`로 덮어쓰는데, 이게 드래그로 변경된 포인트를 덮어쓸 수 있음
- **상황**: 눈 크기 슬라이더를 조정하면 드래그로 변경한 포인트가 사라질 수 있음
- **확인 필요**: 사이즈 변경 시 드래그로 변경된 포인트도 함께 변환되어야 하는지, 아니면 보존되어야 하는지

**2. V2 패널의 apply_editing에서 무조건 덮어쓰기**
- **위치**: `gui/face_edit/__init__.py` 827줄 (FaceEditPanelV2)
- **문제**: `self.custom_landmarks = list(transformed)`로 무조건 덮어쓰고 있음
- **상황**: V2 패널에서 슬라이더를 조정하면 드래그 변경이 사라질 수 있음
- **확인 필요**: V2 패널 사용 여부 및 동작 확인

**3. 드래그 변경 포인트 추적 정확도**
- **위치**: `gui/face_edit/morphing/logic.py` 498-520줄
- **문제**: 0.5픽셀 차이로 드래그 변경을 판단하는데, 슬라이더 변형으로 인한 작은 변화도 드래그로 오인할 수 있음
- **확인 필요**: 임계값 조정 또는 더 정확한 추적 방법 필요할 수 있음

## 예상 효과

1. **데이터 구조 단순화**: 14개 → 약 10개 변수로 감소
2. **로직 단순화**: 
   - Tesselation 처리 시 변환 로직 단순화
   - `use_custom` 로직 제거로 코드 단순화
   - `len(landmarks) > 468` 체크 제거 (파라미터로 명확히 구분)
3. **유지보수성 향상**: 
   - 데이터 흐름이 명확해짐
   - 파라미터로 구조가 명확히 드러남
4. **버그 예방**: 
   - 임시 변수 감소로 데이터 불일치 가능성 감소
   - 길이 체크 오류 가능성 제거
5. **코드 가독성 향상**: 
   - 불필요한 조건 체크 제거
   - 함수 시그니처만 봐도 데이터 구조 파악 가능

## 주의사항

1. 하위 호환성 유지: 기존 코드에서 478개 구조를 가정하는 부분이 있을 수 있음
2. MediaPipe 호환성: MediaPipe는 478개를 반환하므로 분리 로직 필요
3. `morph_face_by_polygons` 호환성: 470개 구조를 받도록 설계되어 있음

## 작업 완료 체크리스트

- [x] 1단계 완료
- [x] 2단계 완료
- [x] 3단계 완료
- [x] 4단계 완료 (코드 레벨)
- [x] 5단계 완료 (폴리곤 드래그 기능 버그 수정)
- [x] 모든 테스트 통과 (LandmarkManager 기본 기능)
- [x] 린터 오류 없음
- [x] Tesselation 모드에서 눈동자 중심점 그리기 지원 완료
- [x] 사용자 테스트 완료 (실제 실행 완료)
- [x] 폴리곤 드래그 기능 버그 수정 완료
