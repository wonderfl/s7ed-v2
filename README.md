# 삼국지 VII 에디터 (s7ed-v2)

삼국지 VII 게임의 저장 파일을 편집하고, 장수 얼굴을 편집/추출/생성할 수 있는 에디터입니다.

## 프로젝트 소개

이 프로젝트는 삼국지 VII 게임의 저장 파일(`.s7`)을 읽고 편집할 수 있는 도구입니다. 특히 장수 얼굴 이미지를 편집, 추출, 생성하는 고급 기능을 제공합니다.

## 주요 기능

### 게임 데이터 편집
- 장수 데이터 편집 (능력치, 특기, 관계 등)
- 도시 데이터 편집
- 아이템 데이터 편집
- 세력 데이터 편집

### 얼굴 편집 기능
- **얼굴 추출**: 이미지에서 얼굴을 자동으로 감지하고 추출
- **얼굴 편집**: 얼굴 랜드마크를 이용한 얼굴 모양 편집
  - 얼굴 특징 보정 (눈 크기, 코 크기, 턱선 등)
  - 스타일 전송
  - 나이 변환
- **얼굴 생성**: 여러 얼굴을 합성하여 새로운 얼굴 생성
- **얼굴 유사도 검색**: 비슷한 얼굴 찾기

### 기타 기능
- 게임 저장 파일 자동 감지 및 재로드
- 설정 파일을 통한 사용자 환경 관리
- 통합 로깅 시스템

## 설치 방법

### 요구사항
- Python 3.8 이상
- Windows 10 이상 (주로 Windows에서 테스트됨)

### 필수 패키지 설치

```bash
pip install -r requirements.txt
```

필수 패키지:
- `Pillow>=10.0.0`: 이미지 처리
- `numpy>=1.24.0`: 수치 계산

### 선택적 패키지

#### 얼굴 인식 기능 사용 시
```bash
pip install opencv-python>=4.8.0
```

#### 얼굴 랜드마크 기능 사용 시
```bash
pip install mediapipe>=0.10.0
```

#### 얼굴 변형 기능 사용 시
```bash
pip install scipy>=1.10.0
```

### GPU 가속 (선택)

GPU 가속을 사용하려면 OpenCV CUDA 지원 빌드가 필요합니다. 일반 `opencv-python`은 CPU만 지원합니다.

- CUDA 지원 OpenCV 빌드 사용 권장
- GPU가 없거나 CUDA를 지원하지 않아도 정상 작동 (CPU로 자동 폴백)

## 사용 방법

### 기본 워크플로우

1. **프로그램 실행**
   ```bash
   python main.py
   ```

2. **게임 저장 파일 열기**
   - 메뉴: `File` > `Open`
   - 또는 `Ctrl+O` (구현 예정)

3. **장수 데이터 편집**
   - 메인 화면에서 장수 선택
   - 능력치, 특기, 관계 등 편집

4. **얼굴 편집**
   - 메뉴: `File` > `얼굴 편집...`
   - 얼굴 이미지 로드 후 편집

5. **저장**
   - 메뉴: `File` > `Save`
   - 또는 `Ctrl+S` (구현 예정)

### 주요 기능 설명

#### 얼굴 추출
1. 메뉴: `File` > `얼굴 추출...`
2. 원본 이미지 파일 선택
3. 자동 얼굴 감지 또는 수동 영역 지정
4. 이미지 조정 및 팔레트 적용
5. 저장

#### 얼굴 편집
1. 메뉴: `File` > `얼굴 편집...`
2. 얼굴 이미지 파일 선택
3. 랜드마크 자동 감지 및 정렬
4. 얼굴 특징 보정, 스타일 전송, 나이 변환 등
5. 저장

#### 얼굴 생성
1. 메뉴: `File` > `얼굴 생성...`
2. 여러 얼굴 이미지 선택
3. 얼굴 합성 또는 파트 조합
4. 저장

### 설정 파일

설정은 `config.json` 파일에 저장됩니다.

주요 설정:
- `loading_file`: 기본 로드할 게임 저장 파일 경로
- `face_file`: 얼굴 데이터 파일 경로
- `png_dir`: PNG 이미지 저장 디렉토리
- `save_file_dir`: 게임 저장 파일 디렉토리
- `face_extract_dir`: 얼굴 추출 원본 이미지 디렉토리

#### 로깅 설정

로깅 설정은 별도의 `logging.json` 파일에서 관리됩니다 (권장). 자세한 내용은 `docs/logging_config_guide.md`를 참조하세요.

**중요**: 파일 로그 활성화 여부는 `log_level` 설정으로 제어됩니다.
- `log_level`이 유효한 레벨 값(`"DEBUG"`, `"INFO"`, `"WARNING"`, `"ERROR"`, `"CRITICAL"`)이면 → 파일 로그 활성화
- `log_level`이 없거나 `null`, 빈 문자열(`""`), 공백만 있거나, `"None"` (대소문자 구분 없음)이면 → 파일 로그 비활성화

파일 로그를 저장하지 않으려면 `log_level`을 제거하거나 `null`, `""`, `"None"` 등으로 설정하세요.

주요 로깅 설정:
- `output_level`: 콘솔 출력 레벨 (DEBUG, INFO, WARNING, ERROR, CRITICAL)
- `log_level`: 파일 로그 레벨 (설정하면 파일 로그 활성화, 없거나 null이면 비활성화)
- `file_path`: 로그 파일 경로
- `filename_date`: 날짜별 파일명 패턴 (예: `"%Y-%m-%d"`)
- `filename_prefix`: 파일명 접두사 (예: `"app_"`)

하위 호환성을 위해 `config.json`의 `logging` 섹션도 지원하지만, `logging.json` 사용을 권장합니다.

### 저장 파일 형식

- 게임 저장 파일: `.s7` (삼국지 VII 저장 파일)
- 얼굴 데이터 파일: `Kaodata.s7`
- 설정 파일: `config.json` (JSON 형식)

## 단축키

### 현재 구현된 단축키
- `Ctrl+F`: 검색 창 열기

### 메뉴 구조

#### File 메뉴
- `Open`: 게임 저장 파일 열기
- `Reload`: 현재 파일 다시 로드
- `Save`: 저장
- `Save as`: 다른 이름으로 저장
- `Export`: 내보내기
- `얼굴 파일 열기...`: 얼굴 데이터 파일 열기
- `얼굴 이미지 가져오기...`: 얼굴 이미지 가져오기
- `얼굴 추출...`: 얼굴 추출 패널
- `얼굴 편집...`: 얼굴 편집 패널
- `얼굴 편집 V2 (실험)...`: 얼굴 편집 V2 패널 (실험적)
- `얼굴 생성...`: 얼굴 생성 패널
- `비슷한 얼굴 찾기...`: 비슷한 얼굴 찾기 패널
- `Exit`: 프로그램 종료

#### Add+ 메뉴
- `충성 +5`: 선택한 장수의 충성도 +5
- `친밀 +10`: 선택한 장수의 친밀도 +10
- `병사 +500`: 선택한 장수의 병사 +500
- `건강 ++`: 선택한 장수의 건강 회복

#### Full 메뉴
- `행동력: 200`: 행동력을 200으로 설정
- `훈련: 100`: 훈련도를 100으로 설정
- `포획: 00`: 포획도를 00으로 설정

#### Help 메뉴
- `City/Item`: 도시/아이템 정보
- `about`: 프로그램 정보
- `help`: 도움말

## 문제 해결

### MediaPipe 설치 오류
```
[얼굴랜드마크] MediaPipe가 설치되지 않았습니다.
```
**해결 방법**: 
```bash
pip install mediapipe>=0.10.0
```

### OpenCV 설치 오류
얼굴 인식 기능이 작동하지 않는 경우:
```bash
pip install opencv-python>=4.8.0
```

### GPU 가속이 작동하지 않는 경우
- 일반 `opencv-python`은 CPU만 지원합니다
- GPU 가속을 사용하려면 CUDA 지원 OpenCV 빌드가 필요합니다
- GPU가 없어도 정상 작동합니다 (CPU로 자동 폴백)

### 로그 파일 확인
에러가 발생한 경우 `logs/s7ed.log` 파일을 확인하세요 (로그 파일 저장이 활성화된 경우).

로그 파일 저장을 활성화하려면 `logging.json` 파일을 생성하고 다음을 추가:
```json
{
  "output_level": "INFO",
  "log_level": "WARNING",
  "file_path": "logs/s7ed.log",
  "rotation_type": "date",
  "rotation_when": "midnight",
  "rotation_interval": 1,
  "backup_count": 30,
  "filename_date": "%Y-%m-%d",
  "filename_prefix": "app_"
}
```

**참고**: `log_level`이 유효한 레벨 값으로 설정되어 있으면 파일 로그가 활성화됩니다. 파일 로그를 비활성화하려면 `log_level`을 제거하거나 `null`, `""`로 설정하세요.

또는 `logging.json.example` 파일을 `logging.json`으로 복사하여 사용할 수 있습니다.

자세한 로깅 설정은 `docs/logging_config_guide.md`를 참조하세요.

**참고**: 하위 호환성을 위해 `config.json`의 `logging` 섹션도 지원하지만, `logging.json` 사용을 권장합니다.

### 설정 파일 문제
설정 파일이 손상된 경우 `config.json` 파일을 삭제하면 기본값으로 재생성됩니다.

## 기여 방법

버그 리포트나 기능 제안은 이슈로 등록해주세요.

## 라이선스

이 프로젝트의 라이선스 정보는 프로젝트 루트의 라이선스 파일을 참조하세요.

## 참고사항

- 이 도구는 삼국지 VII 게임의 저장 파일을 편집하는 비공식 도구입니다
- 저장 파일을 편집하기 전에 백업을 권장합니다
- 게임 버전에 따라 호환성 문제가 있을 수 있습니다
