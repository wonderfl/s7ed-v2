# MediaPipe Face Mesh 폴리곤 렌더링 작업계획서

**작업일**: 2026-01-30 17:53  
**담당자**: Cascade  
**목표**: Tkinter 캔버스에 MediaPipe Face Mesh 폴리곤 실시간 렌더링 구현

## 작업 목표
MediaPipe Face Mesh의 얼굴 영역별 폴리곤(눈썹, 눈, 코, 입술, 얼굴 윤곽 등)을 Tkinter 캔버스에 실시간으로 그려서 시각적으로 표시

## 작업 범위
- **신규 파일**: `gui/polygon_renderer.py` (PolygonRenderer 클래스)
- **수정 파일**: `gui/preview.py`, `gui/__init__.py`, `gui/file.py`
- **기능**: MediaPipe 랜드마크 감지 → 폴리곤 렌더링 → UI 가시성 제어

## 단계별 작업 계획

### 단계 1: PolygonRenderer 클래스 구현
- [ ] `gui/polygon_renderer.py` 파일 생성
- [ ] MediaPipe Face Mesh 상수 정의 (FACEMESH_CONTOURS, FACEMESH_TESSELATION 등)
- [ ] 폴리곤 그리기 메서드 구현 (`draw_visible_polygons`)
- [ ] 랜드마크 점 그리기 메서드 구현 (`draw_landmark_points`)
- [ ] 폴리곤/점 삭제 메서드 구현 (`clear_polygons`, `clear_landmark_points`)
- [ ] 영역별 가시성 맵 생성 메서드 구현

### 단계 2: PreviewManagerMixin 통합
- [ ] `gui/preview.py`에 polygon_renderer import 추가
- [ ] `show_original_preview` 메서드에 폴리곤 그리기 로직 추가
- [ ] 좌표 변환 로직 구현 (랜드마크 → 캔버스 좌표)
- [ ] 폴리곤 레이어 순서 조정 (이미지 위에 표시)
- [ ] 헬퍼 메서드 추가 (`_draw_mediapipe_polygons`, `_clear_mediapipe_polygons`)

### 단계 3: UI 변수 연동
- [ ] `gui/__init__.py`에 MediaPipe 부위 선택 BooleanVar 초기화
- [ ] 체크박스 변수와 폴리곤 가시성 연동
- [ ] 기본값 설정 (모두 False로 시작, 사용자가 활성화)
- [ ] UI 상태 변화 시 폴리곤 재렌더링 트리거

### 단계 4: 랜드마크 감지 연동
- [ ] `gui/file.py`의 `load_image` 메서드에 MediaPipe 랜드마크 감지 추가
- [ ] `utils/landmarks.py`의 `detect_face_landmarks` 함수 활용
- [ ] 감지된 랜드마크를 `self.face_landmarks`에 저장
- [ ] 랜드마크 감지 성공/실패 로그 출력
- [ ] 랜드마크 감지 시 미리보기 업데이트 트리거

### 단계 5: 테스트 및 디버깅
- [ ] 이미지 로드 시 랜드마크 감지 테스트
- [ ] UI 체크박스 활성화 시 폴리곤 표시 테스트
- [ ] 확대/축소 시 폴리곤 좌표 변환 테스트
- [ ] 드래그 시 폴리곤 동기화 테스트
- [ ] 성능 최적화 (불필요한 재렌더링 방지)

## 기술 구현 상세

### MediaPipe 상수 활용
```python
# 사용할 MediaPipe 상수
- mp.solutions.face_mesh.FACEMESH_CONTOURS  # 얼굴 윤곽
- mp.solutions.face_mesh.FACEMESH_LEFT_EYEBROW  # 왼쪽 눈썹
- mp.solutions.face_mesh.FACEMESH_RIGHT_EYEBROW  # 오른쪽 눈썹
- mp.solutions.face_mesh.FACEMESH_LEFT_EYE  # 왼쪽 눈
- mp.solutions.face_mesh.FACEMESH_RIGHT_EYE  # 오른쪽 눈
- mp.solutions.face_mesh.FACEMESH_LIPS  # 입술
- mp.solutions.face_mesh.FACEMESH_NOSE  # 코
```

### 좌표 변환 공식
```python
# 랜드마크 좌표 → 캔버스 좌표
canvas_x = landmark_x * scale_x + offset_x
canvas_y = landmark_y * scale_y + offset_y
```

### 색상 지정
- 각 영역별로 다른 색상 지정 (눈썹: 녹색, 눈: 파란색, 코: 노란색, 입술: 빨간색 등)
- 투명도 조절 가능하도록 설정

## 테스트 계획

### 기능 테스트
1. **랜드마크 감지**: 얼굴이 있는 이미지 로드 시 468개 포인트 감지 확인
2. **폴리곤 표시**: UI 체크박스 활성화 시 해당 영역 폴리곤 표시 확인
3. **동기화**: 이미지 확대/축소/드래그 시 폴리곤 동기화 확인
4. **성능**: 실시간 렌더링 시 지연 없는지 확인

### 엣지 케이스 테스트
- 얼굴이 없는 이미지 처리
- 랜드마크 감지 실패 시 처리
- 캔버스 크기 변경 시 폴리곤 재조정
- 여러 이미지 빠르게 전환 시 처리

## 완료 조건
- [ ] MediaPipe 랜드마크 감지 성공 (468개 포인트)
- [ ] 모든 얼굴 영역 폴리곤 정확히 표시
- [ ] UI 체크박스로 가시성 제어 가능
- [ ] 이미지 조작 시 폴리곤 정확히 동기화
- [ ] 성능 저하 없는 실시간 렌더링

## 리스크 및 대책
- **성능 문제**: 불필요한 재렌더링 방지를 위한 캐싱 구현
- **좌표 변환 오류**: 다양한 이미지 크기에서 테스트
- **MediaPipe 호환성**: 버전 호환성 확인 및 예외 처리

---

**체크리스트**: 각 단계 완료 시 [x] 표시  
**승인자**: 사용자  
**완료일**: 예정 2026-01-30 18:30
